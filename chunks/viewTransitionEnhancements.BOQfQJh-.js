import{logger as n}from"./logger.B6gmc7Y6.js";import"./vendor-other.DbSZRnBI.js";const d={enablePerformanceMetrics:!0,fallbackDelay:500,maxTransitionDuration:1e3,preloadStrategy:"hover",durations:{fast:200,normal:350,slow:500},debug:!1,accessibility:{respectReducedMotion:!0,announceRouteChanges:!0,routeAnnouncementLanguage:"de"}},c={fallbackDelay:{min:0,max:5e3},maxTransitionDuration:{min:100,max:3e3},preloadStrategies:["hover","visible","none"],durations:{fast:{min:50,max:500},normal:{min:100,max:1e3},slow:{min:200,max:2e3}}};function g(a){const e=[];if(a.fallbackDelay!==void 0){const{min:t,max:i}=c.fallbackDelay;(typeof a.fallbackDelay!="number"||a.fallbackDelay<t||a.fallbackDelay>i)&&e.push({field:"fallbackDelay",message:`fallbackDelay must be a number between ${t} and ${i}`,code:"INVALID_FALLBACK_DELAY"})}if(a.maxTransitionDuration!==void 0){const{min:t,max:i}=c.maxTransitionDuration;(typeof a.maxTransitionDuration!="number"||a.maxTransitionDuration<t||a.maxTransitionDuration>i)&&e.push({field:"maxTransitionDuration",message:`maxTransitionDuration must be a number between ${t} and ${i}`,code:"INVALID_MAX_DURATION"})}return a.preloadStrategy!==void 0&&(c.preloadStrategies.includes(a.preloadStrategy)||e.push({field:"preloadStrategy",message:`preloadStrategy must be one of: ${c.preloadStrategies.join(", ")}`,code:"INVALID_PRELOAD_STRATEGY"})),a.durations&&Object.entries(a.durations).forEach(([t,i])=>{if(i!==void 0){const s=t,{min:r,max:o}=c.durations[s];(typeof i!="number"||i<r||i>o)&&e.push({field:`durations.${t}`,message:`${t} duration must be a number between ${r} and ${o}`,code:`INVALID_DURATION_${t.toUpperCase()}`})}}),e}function f(a){return{...d,...a,durations:{...d.durations,...a.durations},accessibility:{...d.accessibility,...a.accessibility}}}class h{config;debug;constructor(e,t=!1){this.config=e,this.debug=t}init(){this.setupRouteAnnouncements(),this.setupReducedMotionSupport(),this.setupFocusManagement()}setupRouteAnnouncements(){this.config.announceRouteChanges&&document.addEventListener("astro:after-swap",()=>{this.announceRouteChange()})}announceRouteChange(){const e=document.title,{routeAnnouncementLanguage:t}=this.config,s={de:`Navigiert zu: ${e}`,en:`Navigated to: ${e}`}[t];if(!s){this.debug&&n.warn(`Unsupported announcement language: ${t}`);return}const r=document.createElement("div");r.setAttribute("aria-live","polite"),r.setAttribute("aria-atomic","true"),r.className="sr-only",r.style.cssText=this.getScreenReaderOnlyStyles(),r.textContent=s,document.body.appendChild(r),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},1e3)}getScreenReaderOnlyStyles(){return`
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    `}setupReducedMotionSupport(){if(!this.config.respectReducedMotion)return;const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=i=>{i.matches?this.enableReducedMotion():this.disableReducedMotion()};t(e),e.addEventListener("change",t)}enableReducedMotion(){document.documentElement.style.setProperty("--vt-duration-fast","1ms"),document.documentElement.style.setProperty("--vt-duration-normal","1ms"),document.documentElement.style.setProperty("--vt-duration-slow","1ms"),document.documentElement.classList.add("vt-reduced-motion"),this.debug&&n.debug("AccessibilityManager: Reduced motion enabled")}disableReducedMotion(){document.documentElement.classList.remove("vt-reduced-motion"),this.debug&&n.debug("AccessibilityManager: Reduced motion disabled")}setupFocusManagement(){document.addEventListener("astro:before-swap",()=>{this.preserveFocus()}),document.addEventListener("astro:after-swap",()=>{this.restoreFocus()})}preserveFocus(){const e=document.activeElement;if(e&&e.id)sessionStorage.setItem("vt-focus-id",e.id);else if(e&&e.tagName){const t=Array.from(document.querySelectorAll(e.tagName)).indexOf(e);sessionStorage.setItem("vt-focus-tag",e.tagName),sessionStorage.setItem("vt-focus-index",t.toString())}this.debug&&n.debug("AccessibilityManager: Focus preserved",{element:e?.tagName,id:e?.id})}restoreFocus(){setTimeout(()=>{const e=sessionStorage.getItem("vt-focus-id"),t=sessionStorage.getItem("vt-focus-tag"),i=sessionStorage.getItem("vt-focus-index");let s=!1;if(e){const r=document.getElementById(e);r&&(r.focus(),sessionStorage.removeItem("vt-focus-id"),s=!0)}if(!s&&t&&i){const o=document.querySelectorAll(t)[parseInt(i)];o&&(o.focus(),sessionStorage.removeItem("vt-focus-tag"),sessionStorage.removeItem("vt-focus-index"),s=!0)}this.debug&&n.debug("AccessibilityManager: Focus restoration",{restored:s,method:e?"by-id":t?"by-tag":"none"})},50)}updateConfig(e){this.config={...this.config,...e}}getStatus(){return{reducedMotionEnabled:document.documentElement.classList.contains("vt-reduced-motion"),announceRouteChanges:this.config.announceRouteChanges,language:this.config.routeAnnouncementLanguage}}}class p{metrics=new Map;currentTransition={};debug;constructor(e=!1){this.debug=e}init(){this.setupEventListeners()}setupEventListeners(){document.addEventListener("astro:before-preparation",()=>{this.currentTransition={timestamp:performance.now()}}),document.addEventListener("astro:after-preparation",()=>{if(this.currentTransition.timestamp){const e=performance.now()-this.currentTransition.timestamp;this.currentTransition.preparationDuration=e,e>100&&this.debug&&n.warn(`Slow view transition preparation: ${e.toFixed(2)}ms`)}}),document.addEventListener("astro:before-swap",()=>{this.currentTransition.timestamp&&(this.currentTransition.swapDuration=0)}),document.addEventListener("astro:after-swap",()=>{if(this.currentTransition.timestamp&&this.currentTransition.preparationDuration!==void 0){const e=performance.now()-this.currentTransition.timestamp,t=e-this.currentTransition.preparationDuration,i={preparationDuration:this.currentTransition.preparationDuration,swapDuration:t,totalDuration:e,timestamp:this.currentTransition.timestamp};this.storeMetrics(i),this.debug&&n.debug("Transition metrics:",i)}})}storeMetrics(e){if(this.metrics.set(e.timestamp.toString(),e),this.metrics.size>10){const t=Array.from(this.metrics.keys())[0];this.metrics.delete(t)}}getMetrics(){return Array.from(this.metrics.values())}getLatestMetrics(){const e=this.getMetrics();return e.length>0?e[e.length-1]:null}getAverageMetrics(){const e=this.getMetrics();if(e.length===0)return null;const t=e.reduce((i,s)=>({preparationDuration:i.preparationDuration+s.preparationDuration,swapDuration:i.swapDuration+s.swapDuration,totalDuration:i.totalDuration+s.totalDuration}),{preparationDuration:0,swapDuration:0,totalDuration:0});return{preparationDuration:t.preparationDuration/e.length,swapDuration:t.swapDuration/e.length,totalDuration:t.totalDuration/e.length}}getSummary(){const e=this.getMetrics();if(e.length===0)return{totalTransitions:0,averageTime:0,slowestTransition:0,fastestTransition:0};const t=e.map(o=>o.totalDuration),i=t.reduce((o,m)=>o+m,0)/t.length,s=Math.max(...t),r=Math.min(...t);return{totalTransitions:e.length,averageTime:i,slowestTransition:s,fastestTransition:r}}reset(){this.metrics.clear(),this.currentTransition={}}exportMetrics(){return JSON.stringify({timestamp:Date.now(),metrics:this.getMetrics(),summary:this.getSummary()},null,2)}}class b{config;preloadedUrls=new Set;isPreloading=!1;constructor(e="hover",t=!1){this.config={strategy:e,debug:t}}init(){switch(this.config.strategy){case"hover":this.setupHoverPreloading();break;case"visible":this.setupIntersectionPreloading();break;case"none":break;default:this.config.debug&&n.warn(`Unknown preload strategy: ${this.config.strategy}`)}}setupHoverPreloading(){const e=t=>{const s=t.target.closest("a");s&&this.isInternalLink(s)&&this.preloadPage(s.href)};document.addEventListener("mouseover",e,{passive:!0}),this.config.debug&&n.debug("PreloadManager: Hover preloading initialized")}setupIntersectionPreloading(){if(!("IntersectionObserver"in window)){this.config.debug&&n.warn("PreloadManager: IntersectionObserver not supported, falling back to hover"),this.setupHoverPreloading();return}const e=new IntersectionObserver(t=>{t.forEach(i=>{if(i.isIntersecting){const s=i.target;this.isInternalLink(s)&&(this.preloadPage(s.href),e.unobserve(s))}})},{rootMargin:"50px",threshold:.1});document.querySelectorAll("a").forEach(t=>{this.isInternalLink(t)&&e.observe(t)}),this.config.debug&&n.debug("PreloadManager: Intersection preloading initialized")}isInternalLink(e){try{return new URL(e.href,window.location.origin).origin===window.location.origin&&!e.hasAttribute("data-no-preload")&&!e.href.includes("#")&&e.href!==window.location.href&&!this.preloadedUrls.has(e.href)}catch{return!1}}async preloadPage(e){if(!(this.preloadedUrls.has(e)||this.isPreloading)){this.preloadedUrls.add(e),this.isPreloading=!0;try{const t=await fetch(e,{method:"GET",headers:{"X-Purpose":"prefetch"},..."priority"in Request.prototype&&{priority:"low"}});t.ok&&("caches"in window&&await(await caches.open("view-transitions-preload")).put(e,t.clone()),this.config.debug&&n.debug(`PreloadManager: Successfully preloaded ${e}`))}catch(t){this.config.debug&&n.warn(`PreloadManager: Failed to preload ${e}:`,t),this.preloadedUrls.delete(e)}finally{this.isPreloading=!1}}}updateStrategy(e){this.config.strategy=e,this.cleanup(),this.init()}getStats(){return{strategy:this.config.strategy,preloadedCount:this.preloadedUrls.size,preloadedUrls:Array.from(this.preloadedUrls)}}async clearCache(){if(this.preloadedUrls.clear(),"caches"in window)try{await caches.delete("view-transitions-preload"),this.config.debug&&n.debug("PreloadManager: Cache cleared")}catch(e){this.config.debug&&n.warn("PreloadManager: Failed to clear cache:",e)}}cleanup(){this.preloadedUrls.clear()}}class l{config;fallbackTimeouts=new Map;isEnabled=!0;constructor(e){this.config=e}init(){this.setupTransitionTimeouts(),this.setupErrorHandling(),this.addFallbackStyles(),this.config.debug&&n.debug("FallbackHandler: Initialized with config",this.config)}setupTransitionTimeouts(){document.addEventListener("astro:before-preparation",()=>{this.startTransitionTimeout()}),document.addEventListener("astro:after-swap",()=>{this.clearTransitionTimeout()})}setupErrorHandling(){window.addEventListener("error",e=>{this.isTransitionError(e)&&this.handleTransitionError("JavaScript error during transition",e.error)}),window.addEventListener("unhandledrejection",e=>{this.isTransitionError(e)&&this.handleTransitionError("Promise rejection during transition",e.reason)})}startTransitionTimeout(){const e=window.setTimeout(()=>{this.handleTransitionTimeout()},this.config.maxTransitionDuration);this.fallbackTimeouts.set("current",e)}clearTransitionTimeout(){const e=this.fallbackTimeouts.get("current");e&&(clearTimeout(e),this.fallbackTimeouts.delete("current"))}handleTransitionTimeout(){this.config.debug&&n.warn(`FallbackHandler: Transition timeout after ${this.config.maxTransitionDuration}ms`),this.triggerFallbackNavigation()}handleTransitionError(e,t){this.config.debug&&n.error(`FallbackHandler: ${e}`,t),this.triggerFallbackNavigation()}isTransitionError(e){const t="message"in e?e.message:String(e.reason);return t.includes("view-transition")||t.includes("astro")||t.includes("transition")}triggerFallbackNavigation(){this.isEnabled&&(document.documentElement.classList.add("vt-fallback"),this.isEnabled=!1,setTimeout(()=>{this.config.debug&&n.debug("FallbackHandler: Triggering fallback navigation");const e=window.location.href;window.location.href=e},this.config.fallbackDelay),setTimeout(()=>{this.isEnabled=!0,document.documentElement.classList.remove("vt-fallback")},5e3))}addFallbackStyles(){if(document.getElementById("vt-fallback-styles"))return;const t=document.createElement("style");t.id="vt-fallback-styles",t.textContent=`
      /* Fallback styles when view transitions fail */
      .vt-fallback {
        --vt-duration-fast: 0ms;
        --vt-duration-normal: 0ms;
        --vt-duration-slow: 0ms;
      }

      .vt-fallback *,
      .vt-fallback *::before,
      .vt-fallback *::after {
        animation-duration: 0ms !important;
        animation-delay: 0ms !important;
        transition-duration: 0ms !important;
        transition-delay: 0ms !important;
      }

      /* Ensure content is still accessible during fallback */
      .vt-fallback [data-loading] {
        opacity: 1 !important;
        transform: none !important;
      }

      /* Hide transition-specific elements during fallback */
      .vt-fallback [data-transition-only] {
        display: none !important;
      }
    `,document.head.appendChild(t)}static checkSupport(){return{viewTransitions:"startViewTransition"in document,documentStartViewTransition:typeof document.startViewTransition=="function",cssViewTransitions:CSS.supports("view-transition-name","none")}}setupProgressiveEnhancement(){const e=l.checkSupport();e.viewTransitions||(document.documentElement.classList.add("no-view-transitions"),this.config.debug&&n.debug("FallbackHandler: View transitions not supported, using fallback mode")),e.cssViewTransitions||document.documentElement.classList.add("no-css-view-transitions")}getStats(){return{isEnabled:this.isEnabled,activeTimeouts:this.fallbackTimeouts.size,support:l.checkSupport()}}updateConfig(e){this.config={...this.config,...e}}setEnabled(e){this.isEnabled=e,e||(this.fallbackTimeouts.forEach(t=>{clearTimeout(t)}),this.fallbackTimeouts.clear())}cleanup(){this.fallbackTimeouts.forEach(t=>{clearTimeout(t)}),this.fallbackTimeouts.clear();const e=document.getElementById("vt-fallback-styles");e&&e.remove()}}class w{config;accessibilityManager;metricsCollector;preloadManager;fallbackHandler;isInitialized=!1;constructor(e){this.config=e,this.accessibilityManager=new h(e.accessibility,e.debug),this.metricsCollector=new p(e.debug),this.preloadManager=new b(e.preloadStrategy,e.debug),this.fallbackHandler=new l({maxTransitionDuration:e.maxTransitionDuration,fallbackDelay:e.fallbackDelay,debug:e.debug})}init(){if(this.isInitialized){this.config.debug&&n.warn("ViewTransitionEnhancer: Already initialized");return}try{this.fallbackHandler.setupProgressiveEnhancement(),this.setupViewTransitions(),this.applyDynamicDurations(),this.accessibilityManager.init(),this.config.enablePerformanceMetrics&&this.metricsCollector.init(),this.preloadManager.init(),this.fallbackHandler.init(),this.setupCleanup(),this.isInitialized=!0,this.config.debug&&n.debug("ViewTransitionEnhancer: Initialized successfully",{config:this.config,modules:{accessibility:!0,metrics:this.config.enablePerformanceMetrics,preload:this.config.preloadStrategy!=="none",fallback:!0}})}catch(e){throw n.error("ViewTransitionEnhancer: Initialization failed:",e),e}}setupViewTransitions(){if(!("startViewTransition"in document)){document.documentElement.classList.add("no-view-transitions"),this.config.debug&&n.debug("ViewTransitionEnhancer: View transitions not supported");return}document.documentElement.classList.add("view-transitions-supported"),this.setupTransitionHandlers()}setupTransitionHandlers(){document.addEventListener("astro:before-preparation",()=>{this.config.debug&&n.debug("ViewTransitionEnhancer: Before preparation")}),document.addEventListener("astro:after-swap",()=>{this.applyDynamicDurations(),this.config.debug&&n.debug("ViewTransitionEnhancer: After swap")})}applyDynamicDurations(){const{durations:e}=this.config,t=document.documentElement;t.style.setProperty("--vt-duration-fast",`${e.fast}ms`),t.style.setProperty("--vt-duration-normal",`${e.normal}ms`),t.style.setProperty("--vt-duration-slow",`${e.slow}ms`),this.config.debug&&n.debug("ViewTransitionEnhancer: Applied dynamic durations",e)}setupCleanup(){const e=()=>{this.cleanup()};window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e),document.addEventListener("astro:before-preparation",()=>{this.config.debug&&n.debug("ViewTransitionEnhancer: Preparing for transition")})}updateConfig(e){const t={...this.config};this.config={...this.config,...e},e.accessibility&&this.accessibilityManager.updateConfig(e.accessibility),e.preloadStrategy&&e.preloadStrategy!==t.preloadStrategy&&this.preloadManager.updateStrategy(e.preloadStrategy),(e.maxTransitionDuration||e.fallbackDelay)&&this.fallbackHandler.updateConfig({maxTransitionDuration:this.config.maxTransitionDuration,fallbackDelay:this.config.fallbackDelay,debug:this.config.debug}),e.durations&&this.applyDynamicDurations(),this.config.debug&&n.debug("ViewTransitionEnhancer: Configuration updated",{old:t,new:this.config})}getStatus(){return{isInitialized:this.isInitialized,config:this.config,modules:{accessibility:this.accessibilityManager.getStatus(),metrics:{latest:this.metricsCollector.getLatestMetrics(),summary:this.metricsCollector.getSummary()},preload:this.preloadManager.getStats(),fallback:this.fallbackHandler.getStats()}}}exportDiagnostics(){const e=this.getStatus(),t={timestamp:new Date().toISOString(),version:"2.0.0",status:e,browser:{userAgent:navigator.userAgent,viewTransitions:"startViewTransition"in document,reducedMotion:window.matchMedia("(prefers-reduced-motion: reduce)").matches},performance:{metrics:this.metricsCollector.exportMetrics()}};return JSON.stringify(t,null,2)}reset(){this.config.enablePerformanceMetrics&&this.metricsCollector.reset(),this.preloadManager.clearCache(),this.config.debug&&n.debug("ViewTransitionEnhancer: Reset completed")}cleanup(){if(this.isInitialized)try{this.fallbackHandler.cleanup();const e=document.documentElement;e.style.removeProperty("--vt-duration-fast"),e.style.removeProperty("--vt-duration-normal"),e.style.removeProperty("--vt-duration-slow"),this.isInitialized=!1,this.config.debug&&n.debug("ViewTransitionEnhancer: Cleanup completed")}catch(e){n.error("ViewTransitionEnhancer: Cleanup failed:",e)}}getModules(){return{accessibility:this.accessibilityManager,metrics:this.metricsCollector,preload:this.preloadManager,fallback:this.fallbackHandler}}}function u(a={}){const e=g(a);if(e.length>0)throw n.error("ViewTransitions: Configuration validation failed:",e),a.debug&&e.forEach(s=>{n.error(`  - ${s.field}: ${s.message} (${s.code})`)}),new Error(`Invalid view transitions configuration: ${e.map(s=>s.message).join(", ")}`);const t=f(a),i=new w(t);return i.init(),typeof window<"u"&&(window.__viewTransitionEnhancer=i),i}function y(){return typeof window>"u"?null:window.__viewTransitionEnhancer??null}function v(){const a=y();a&&(a.cleanup(),delete window.__viewTransitionEnhancer)}function D(a={}){return v(),u(a)}if(typeof window<"u"){let a=null;const e=()=>{try{a=u({debug:!1,enablePerformanceMetrics:!0,preloadStrategy:"hover",accessibility:{respectReducedMotion:!0,announceRouteChanges:!0,routeAnnouncementLanguage:"de"}})}catch{}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e(),document.addEventListener("astro:after-swap",()=>{})}export{h as AccessibilityManager,d as DEFAULT_CONFIG,l as FallbackHandler,p as MetricsCollector,b as PreloadManager,c as VALIDATION_RULES,w as ViewTransitionEnhancer,v as cleanupViewTransitions,w as default,y as getViewTransitionsInstance,u as initViewTransitions,f as mergeConfig,D as reinitViewTransitions,g as validateConfig};
