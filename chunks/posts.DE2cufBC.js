import{l as logger,g as getCollection,S as SITE}from"./_astro_content.C3X8YU77.js";import{g as getPostSlug,s as slugify}from"./slugs.CO34ldaf.js";import{l as renderEntry}from"./vendor-astro.COCnXwAE.js";async function withAsyncErrorHandling(t,o,r,s){const{logError:e=!0,transformError:n,onError:g}={};try{return await t()}catch(t){const s=n?n(t):t;if(e&&logger.error(`Error in ${o}:`,s),g)try{g(s,o)}catch(t){logger.error(`Error in onError callback for ${o}:`,t)}return r}}function withErrorHandling(t,o,r,s){const{logError:e=!0,transformError:n,onError:g}={};try{return t()}catch(t){const s=n?n(t):t;if(e&&logger.error(`Error in ${o}:`,s),g)try{g(s,o)}catch(t){logger.error(`Error in onError callback for ${o}:`,t)}return r}}const addSlugsToPosts=t=>t.map((t=>({...t,slug:getPostSlug(t)}))),getAllPosts=async(t=!1)=>withAsyncErrorHandling((async()=>{logger.log("Getting all posts, includeDrafts:",t);const o=await getCollection("blog");if(logger.log("Total posts found:",o.length),t)return logger.log("Returning all posts (dev mode or includeDrafts=true)"),addSlugsToPosts(o);const r=Date.now(),s=SITE.scheduledPostMargin??0;logger.log("Current time:",r),logger.log("Scheduled post margin:",s);const e=o.filter((t=>{const{draft:o,pubDatetime:e}=t.data;if(!e)return logger.log("Post",t.id,"has no pubDatetime, excluding"),!1;const n=new Date(e);if(isNaN(n.getTime()))return logger.log("Post",t.id,"has invalid pubDatetime, excluding"),!1;const g=n.getTime()<=r+s,a=!o;return g||logger.log("Post",t.id,"is scheduled for future",n.toISOString(),"excluding"),a||logger.log("Post",t.id,"is a draft, excluding"),a&&g}));return logger.log("Filtered posts count:",e.length),addSlugsToPosts(e)}),"getAllPosts",[]),getSortedPosts=(t,o="desc")=>withErrorHandling((()=>{logger.log("Sorting posts, count:",t.length);const r=[...t].sort(((t,r)=>{const s=new Date(t.data.modDatetime??t.data.pubDatetime??0).getTime(),e=new Date(r.data.modDatetime??r.data.pubDatetime??0).getTime();return"desc"===o?e-s:s-e}));return logger.log("Sorted posts count:",r.length),r}),"getSortedPosts",t);function getRelatedPosts(t,o,r){return o.filter((o=>o.id!==t.id)).map((o=>{let r=0;const s=t.data.tags??[],e=o.data.tags??[],n=s.filter((t=>e.includes(t)));r+=3*n.length;const g=t.data.categories??[],a=o.data.categories??[];return r+=2*g.filter((t=>a.includes(t))).length,o.data.group===t.data.group&&(r+=1),{post:o,score:r,sharedTags:n}})).filter((t=>t.score>0)).sort(((t,o)=>o.score-t.score)).slice(0,r).map((t=>t.post))}const getPostsWithReadingTime=async t=>withAsyncErrorHandling((async()=>Promise.all(t.map((async t=>t.data.readingTime?t:withAsyncErrorHandling((async()=>{const{remarkPluginFrontmatter:o}=await renderEntry(t);return o?.readingTime&&(t.data.readingTime=o.readingTime,logger.log("Reading time for post",t.id,"calculated:",o.readingTime,"minutes")),t}),`getPostsWithReadingTime[${t.id}]`,t))))),"getPostsWithReadingTime",t),postCache={},processAllPosts=async(t={})=>withAsyncErrorHandling((async()=>{const o=JSON.stringify(t);if(postCache[o])return logger.log("Returning cached posts for options:",o),postCache[o];const{includeDrafts:r=!1,sortDirection:s="desc",maxPosts:e=1/0}=t;logger.log("Processing all posts with options:",o);const n=await getAllPosts(r),g=getSortedPosts(n,s),a=await getPostsWithReadingTime(g),i=e<1/0?a.slice(0,e):a;return postCache[o]=i,logger.log("Processed posts count:",i.length),i}),"processAllPosts",[]),getPostsBy=async(t,o,r)=>withAsyncErrorHandling((async()=>{logger.log("Filtering posts by",o,":",r,", posts count:",t.length);const s=slugify(r);logger.log("Slugified value:",s);const e="group"===o?t.filter((t=>slugify(t.data[o])===s)):t.filter((t=>t.data[o]?.some((t=>slugify(t)===s))));return logger.log("Filtered posts count:",e.length),e}),`getPostsBy[${o}]`,[]),getPostsByTag=async(t,o)=>getPostsBy(t,"tags",o),getPostsByCategory=async(t,o)=>getPostsBy(t,"categories",o),groupByCondition=(t,o,r)=>withErrorHandling((()=>{const s=r?.initialGroups||{};return t.forEach(((t,e)=>{try{const r=o(t,e);s[r]||(s[r]=[]),s[r].push(t)}catch(o){if(!r?.onError)throw o;{const e=r.onError(t,o);s[e]||(s[e]=[]),s[e].push(t)}}})),s}),"groupByCondition",r?.initialGroups||{});export{getAllPosts as a,getPostsByCategory as b,getSortedPosts as c,getRelatedPosts as d,getPostsByTag as e,groupByCondition as g,processAllPosts as p,withErrorHandling as w};