---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/sections/Header.astro";
import Footer from "@/components/sections/Footer.astro";
import Tag from "@/components/elements/Tag.astro";
import { type CollectionEntry } from "astro:content";
import { slugifyStr } from "@/utils/slugify";
import ShareLinks from "@/components/socials/ShareLinks.astro";
import { SITE } from "@/config";
import Image from "@/components/elements/Image.astro";
import Blockquote from "@/components/elements/Blockquote.astro";
import { getLangFromUrl, useTranslations } from "i18n/utils";
import { Picture } from "astro:assets";
import ArticleMeta from "@/components/partials/ArticleMeta.astro";
import Paragraph from "@/components/elements/Paragraph.astro";
import { getAuthorEntry } from "@/utils/getAuthor";

interface PostProps {
  post: CollectionEntry<"blog">;
}

interface LayoutProps {
  title: string;
  author: string;
  heroImage: CollectionEntry<"blog">["data"]["heroImage"];
  description: string;
  pubDatetime: Date;
  modDatetime?: Date;
  canonicalURL?: string;
  ogImage: string;
  scrollSmooth: boolean;
}

const { post } = Astro.props as PostProps;

const {
  data: {
    title,
    author,
    heroImage,
    description,
    ogImage,
    canonicalURL,
    pubDatetime,
    modDatetime,
    categories,
    tags,
  },
} = post;

const authorEntry = await getAuthorEntry(author);

const { Content } = await post.render();

const ogImageUrl = typeof ogImage === "string" ? ogImage : ogImage?.src;
const ogUrl = new URL(
  ogImageUrl ?? `/posts/${slugifyStr(title)}.png`,
  Astro.url.origin
).href;

const layoutProps: LayoutProps = {
  title: `${title} | ${SITE.title}`,
  author: authorEntry?.data.name || SITE.author,
  heroImage,
  description,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage: ogUrl,
  scrollSmooth: true,
};

const components = { img: Image, blockquote: Blockquote, p: Paragraph };

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<Layout {...layoutProps}>
  <!-- Reading Progress Bar -->
  <div
    class="progress-container fixed top-0 z-20 block h-1 w-full bg-transparent 2xl:hidden"
    role="progressbar"
    aria-label="Reading progress"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-valuenow="0"
  >
    <div
      id="progress-top"
      class="h-1 w-0 rounded-full bg-gradient-to-r from-skin-accent/50 to-skin-accent"
    >
    </div>
  </div>

  <Header />

  <!-- Main Content Grid -->
  <div class="relative mx-auto grid max-w-content grid-cols-12 gap-8 md:px-4">
    <!-- Main Content Area -->
    <main id="main-content" class="col-span-12 2xl:col-span-8">
      <!-- Categories -->
      <div class="mb-2 flex flex-wrap text-xs uppercase">
        {
          categories &&
            categories.map((category: string) => (
              <div
                transition:name={slugifyStr(title + category)}
                class="mb-1 mr-[0.125rem] inline-flex items-center text-sm font-medium text-skin-accent after:[&:not(:last-child)]:ml-[0.125rem] after:[&:not(:last-child)]:content-['|']"
                data-pagefind-filter={t("category.name")}
              >
                {category}
              </div>
            ))
        }
      </div>

      <!-- Title -->
      <h1
        transition:name={slugifyStr(title)}
        class="mb-4 text-xl font-semibold lg:text-3xl"
      >
        {title}
      </h1>

      <!-- Article Meta -->
      <ArticleMeta post={post} withAuthor={true} withReadingTime={true} />

      <!-- Hero Image -->
      {
        heroImage && (
          <Picture
            class="mx-auto mt-4 aspect-video"
            src={heroImage.src}
            alt={heroImage.alt}
            decoding="async"
            loading={"eager"}
            widths={[400, 800, 1200, 1600]}
            sizes="(max-width: 800px) 400px, (max-width: 1200px) 800px, (max-width: 1600px) 1200px, 1600px"
            formats={["avif", "webp"]}
            fallbackFormat="png"
            transition:name={slugifyStr(title + "-heroImage")}
            data-pagefind-index-attrs="title,alt"
          />
        )
      }

      <!-- Article Content -->
      <article id="article" class="prose mx-auto mt-6 max-w-none">
        <Content components={components} />
      </article>

      <!-- Tags -->
      <ul class="my-8 flex flex-wrap gap-2" role="list" aria-label="Tags">
        {tags.map((tag: string) => <Tag tag={slugifyStr(tag)} tagName={tag} />)}
      </ul>

      <!-- Navigation and Share Links -->
      <div
        class="flex flex-col-reverse items-center justify-between gap-6 sm:flex-row-reverse sm:items-end sm:gap-4"
      >
        <button
          id="back-to-top"
          class="focus-outline flex items-center gap-2 whitespace-nowrap py-1 hover:opacity-75"
          aria-label={t("nav.backToTop")}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="rotate-90"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"
            ></path>
          </svg>
          <span>{t("nav.backToTop")}</span>
        </button>

        <ShareLinks />
      </div>
    </main>

    <!-- Table of Contents Sidebar -->
    <aside
      data-pagefind-ignore="all"
      class="sticky top-24 hidden h-fit self-start rounded-lg bg-skin-card/5 p-4 shadow-sm 2xl:col-span-4 2xl:block"
      aria-label="Table of contents"
    >
      <!-- Mobile Progress Bar -->
      <div
        id="progress-mobile"
        class="fixed left-0 top-0 h-2 w-full bg-gradient-to-r from-orange-400/30 to-orange-400 md:hidden"
        role="progressbar"
        aria-label="Reading progress mobile"
        aria-valuemin="0"
        aria-valuemax="100"
        aria-valuenow="0"
      >
      </div>

      <!-- Desktop Progress Bar -->
      <div id="pin" class="hidden md:block">
        <div class="mx-4 overflow-hidden">
          <div
            id="progress-aside"
            class="h-px w-full bg-gradient-to-r from-skin-accent/50 to-skin-accent"
            role="progressbar"
            aria-label="Reading progress sidebar"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="0"
          >
          </div>
        </div>

        <!-- TOC Navigation -->
        <nav
          id="toc"
          class="mx-4 rounded-lg bg-skin-card/30 px-4 py-6 shadow-md"
          aria-label="Table of contents"
        >
          <p class="mb-4 font-medium text-skin-base">{t("toc.title")}</p>
          <ul
            class="space-y-3 text-pretty text-sm transition duration-300 ease-in-out"
            role="list"
          >
          </ul>
        </nav>
      </div>
    </aside>
  </div>

  <Footer />

  <script>
    class TableOfContents {
      private observer: IntersectionObserver;
      private article: HTMLElement | null;
      private tocList: HTMLUListElement | null;
      private headings: HTMLElement[];

      constructor() {
        this.article = document.querySelector<HTMLElement>("#article");
        this.tocList = document.querySelector<HTMLUListElement>("#toc ul");
        this.headings = Array.from(
          this.article?.querySelectorAll("h2, h3, h4") || []
        );
        // this.headings = Array.from(
        //   this.article?.querySelectorAll("h2, h3, h4, h5, h6") || []
        // );

        this.observer = new IntersectionObserver(
          (entries: IntersectionObserverEntry[]) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                this.setSelectedLinkById(entry.target.id);
              }
            });
          },
          {
            root: null,
            rootMargin: "0px 0px -40% 0px",
            threshold: [0.1, 0.5, 1.0],
          }
        );

        this.initialize();
      }

      private setSelectedLinkById(selectedId: string): void {
        const listItems = document.querySelectorAll<HTMLLIElement>("#toc li");
        listItems.forEach(item => item.classList.remove("selected"));

        const selectedLink = document.querySelector<HTMLAnchorElement>(
          `#toc a[href="#${selectedId}"]`
        );
        const listItem = selectedLink?.parentElement;
        if (listItem) {
          listItem.classList.add("selected");
          this.scrollIntoViewIfNeeded(listItem);
        }
      }

      private scrollIntoViewIfNeeded(element: HTMLElement): void {
        const container = document.querySelector<HTMLElement>("#toc");
        if (!container) return;

        const { top: containerTop, bottom: containerBottom } =
          container.getBoundingClientRect();
        const { top: elementTop, bottom: elementBottom } =
          element.getBoundingClientRect();

        if (elementBottom > containerBottom || elementTop < containerTop) {
          element.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      }

      private createSvgElement(): SVGElement {
        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg"
        );
        svg.classList.add("w-0", "h-0", "flex-none", "text-skin-accent");
        svg.setAttribute("fill", "none");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("aria-hidden", "true");
        svg.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" d="m12.75 15 3-3m0 0-3-3m3 3h-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />';
        return svg;
      }

      private createLink(heading: HTMLElement): HTMLAnchorElement {
        const link = document.createElement("a");
        link.href = `#${heading.id}`;
        link.textContent = heading.textContent?.trim() || "";
        return link;
      }

      private createListItem(heading: HTMLElement): HTMLLIElement {
        const listItem = document.createElement("li");
        listItem.className = `toc-level-${heading.tagName.toLowerCase()}`;

        const svg = this.createSvgElement();
        const link = this.createLink(heading);

        listItem.appendChild(svg);
        listItem.appendChild(link);

        return listItem;
      }

      private initialize(): void {
        if (!this.tocList || !this.headings.length) return;

        this.headings.slice(1).forEach(heading => {
          const listItem = this.createListItem(heading);
          this.tocList?.appendChild(listItem);
          this.observer.observe(heading);
        });

        window.addEventListener("beforeunload", () => {
          this.observer.disconnect();
        });
      }
    }

    class ScrollProgress {
      private progressBars: HTMLElement[];
      private article: HTMLElement | null;
      private ticking: boolean;

      constructor() {
        this.progressBars = Array.from(
          document.querySelectorAll<HTMLElement>(
            "#progress-top, #progress-aside, #progress-mobile"
          )
        );
        this.article = document.querySelector("article");
        this.ticking = false;
      }

      public update(): void {
        if (this.ticking) return;

        this.ticking = true;
        requestAnimationFrame(() => {
          if (!this.article) return;

          const scrollPosition = window.scrollY;
          const windowHeight = window.innerHeight;
          const documentHeight =
            document.documentElement.scrollHeight - windowHeight;

          const progress = Math.max(
            0,
            Math.min(100, (scrollPosition / documentHeight) * 100)
          );

          this.progressBars.forEach(bar => {
            bar.style.width = `${progress}%`;
            bar.setAttribute("aria-valuenow", progress.toString());
          });

          this.ticking = false;
        });
      }
    }

    class BackToTopButton {
      private button: HTMLElement | null;

      constructor() {
        this.button = document.getElementById("back-to-top");
        this.initialize();
      }

      private initialize(): void {
        this.button?.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }
    }

    document.addEventListener("astro:page-load", () => {
      const scrollProgress = new ScrollProgress();
      window.addEventListener("scroll", () => scrollProgress.update(), {
        passive: true,
      });

      new TableOfContents();
      new BackToTopButton();
    });
  </script>

  <style is:global lang="postcss">
    main {
      @apply mx-auto w-full max-w-none px-4 pb-12;
    }

    #toc {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      scrollbar-width: none;
      scrollbar-color: rgba(var(--color-accent), 0.5) transparent;

      &::-webkit-scrollbar {
        width: 6px;
      }

      &::-webkit-scrollbar-track {
        @apply bg-transparent;
      }

      &::-webkit-scrollbar-thumb {
        @apply rounded-full bg-skin-accent/50;
      }

      li {
        @apply flex items-center text-sm leading-4 text-skin-base opacity-80 my-1;
        transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);

        &.selected {
          @apply opacity-100 text-skin-accent;
          svg {
            @apply mr-2 h-4 w-4;
          }
        }

        svg {
          @apply h-0 w-0;
          transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        a {
          @apply block py-1 hover:text-skin-accent;
          transition: color 200ms ease-in-out;
        }
      }

      .toc-level-h2 {
        @apply ml-2;
      }

      .toc-level-h3 {
        @apply ml-4;
      }

      .toc-level-h4 {
        @apply ml-6;
      }
    }
  </style>
</Layout>
