---
import ArticleContent from "@/components/partials/ArticleContent.astro";
import ArticleFooter from "@/components/partials/ArticleFooter.astro";
import ArticleHeader from "@/components/partials/ArticleHeader.astro";
import ArticleProgressBar from "@/components/partials/ArticleProgressBar.astro";
import ArticleSidebar from "@/components/partials/ArticleSidebar.astro";
import References from "@/components/partials/References.astro";
import Footer from "@/components/sections/Footer.astro";
import Header from "@/components/sections/Header.astro";
import { BreadcrumbSchema, HealthArticleSchema } from "@/components/seo";
import { SITE } from "@/config";
import Layout from "@/layouts/Layout.astro";
import { getAuthorEntry } from "@/utils/authors";
import { getPostSlug } from "@/utils/slugs";
import type { Post } from "@/utils/types";

interface PostProps {
  post: Post;
}

interface LayoutProps {
  title: string;
  author: string;
  heroImage: Post["data"]["heroImage"];
  description: string;
  keywords?: string[];
  tags?: string[];
  categories?: string[];
  pubDatetime: Date;
  modDatetime?: Date;
  canonicalURL?: string;
  ogImage: string;
  scrollSmooth: boolean;
}

const { post } = Astro.props as PostProps;

const {
  data: {
    title,
    author,
    heroImage,
    description,
    ogImage,
    canonicalURL,
    pubDatetime,
    modDatetime,
    keywords,
    categories,
    tags,
    references,
  },
} = post;

const authorEntry = await getAuthorEntry(author);

const ogImageUrl = typeof ogImage === "string" ? ogImage : ogImage?.src;
const ogUrl = new URL(
  ogImageUrl ?? `/posts/${getPostSlug(post)}.png`,
  Astro.url.origin
).href;

const layoutProps: LayoutProps = {
  title: `${title} | ${SITE.title}`,
  author: authorEntry?.data.name || SITE.author,
  heroImage,
  description,
  keywords,
  tags,
  categories,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage: ogUrl,
  scrollSmooth: true,
};

// All articles are health-related content
const primaryCategory = categories?.[0] || "Gesundheit";
---

<Layout {...layoutProps}>
  <!-- Enhanced SEO Schema Markup -->
  <BreadcrumbSchema
    currentPage={title}
    category={primaryCategory}
    isHealthContent={true}
  />

  <HealthArticleSchema
    title={title}
    description={description}
    url={new URL(Astro.url.pathname, Astro.url.origin).href}
    datePublished={pubDatetime}
    dateModified={modDatetime}
    author={{
      name: authorEntry?.data.name || SITE.author,
      expertise: "Health and Wellness Writing",
    }}
    healthCategory={primaryCategory}
    medicalAudience="Patient"
  />

  <ArticleProgressBar />

  <Header />
  <!-- Main Content Grid -->
  <div class="relative mx-auto mt-8 grid max-w-content grid-cols-12 gap-8">
    <!-- Main Content Area with Enhanced Pagefind Metadata -->
    <main
      id="main-content"
      class="col-span-12 mx-auto w-full max-w-none px-4 pb-12 2xl:col-span-8"
      data-pagefind-body
      data-pagefind-meta={`type:blog,author:${authorEntry?.data.name || SITE.author},category:${primaryCategory},readingTime:${post.data.readingTime || 0},publishDate:${pubDatetime.toISOString().split("T")[0]},healthTopic:${categories?.includes("Organsysteme") || categories?.includes("Immunsystem") ? "medical" : "lifestyle"},hasReferences:${references && references.length > 0 ? "true" : "false"},referenceCount:${references?.length || 0},language:de`}
      data-pagefind-weight="10"
    >
      <ArticleHeader post={post as Post} />
      <ArticleContent post={post as Post} data-pagefind-weight="15" />

      {/* References component */}
      {
        references && references.length > 0 && (
          <References referenceIds={references} />
        )
      }

      <ArticleFooter post={post as Post} data-pagefind-weight="5" />
    </main>

    <!-- Table of Contents Sidebar - Excluded from search -->
    <aside data-pagefind-ignore>
      <ArticleSidebar />
    </aside>
  </div>

  <Footer />
</Layout>
