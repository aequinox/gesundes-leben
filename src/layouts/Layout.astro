---
import { ClientRouter } from "astro:transitions";

import Breadcrumb from "@/components/Breadcrumb.astro";
import BottomNav from "@/components/sections/BottomNav.astro";
import Header from "@/components/sections/Header.astro";
import { SEO } from "@/components/seo";
import SizeIndicator from "@/components/SizeIndicator.astro";
import type { NavigationLink } from "@/components/types";
import { SITE } from "@/config";

import "@/styles/global.css";

export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | undefined;
  scrollSmooth?: boolean;
  activeNav?: NavigationLink;
}

const {
  title = SITE.title,
  author = SITE.author,
  // profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  activeNav,
} = Astro.props;
---

<!doctype html>
<html
  lang=`${SITE.lang ?? "en"}`
  class={`${scrollSmooth && "scroll-smooth"}`}
  transition:animate="none"
>
  <head>
    <SEO
      title={title}
      description={description}
      canonicalURL={canonicalURL.toString()}
      ogImage={ogImage}
      pageType={pubDatetime ? "article" : "webpage"}
      publishedTime={pubDatetime}
      modifiedTime={modDatetime}
      author={{ name: author }}
    />

    <ClientRouter />
    <script is:inline src="/toggle-theme.js"></script>
    <script>
      // Lazy load view transition enhancements when needed
      if (
        "startViewTransition" in document ||
        window.matchMedia("(prefers-reduced-motion: no-preference)").matches
      ) {
        import("@/utils/viewTransitionEnhancements")
          .then(_module => {
            // Module is auto-initialized on import
            // Use logger in development only
            if (import.meta.env.DEV) {
              import("@/utils/logger").then(({ logger }) => {
                logger.debug(
                  "View transition enhancements loaded successfully"
                );
              });
            }
          })
          .catch(error => {
            // Silently fail - view transitions are progressive enhancement
          });
      }
    </script>
  </head>
  <body data-pagefind-body class="px-2 lg:px-12" data-astro-prefetch>
    <!-- Skip Navigation Link for Accessibility (WCAG AAA) -->
    <a href="#main-content" class="skip-link">
      Zum Hauptinhalt springen
    </a>
    <Header activeNav={activeNav} />
    {Astro.url.pathname !== "/" && <Breadcrumb />}
    <main id="main-content" transition:animate="slide" transition:name="main-content">
      <slot />
    </main>
    {import.meta.env.DEV && <SizeIndicator />}

    {/* Mobile Bottom Navigation */}
    <BottomNav activeNav={activeNav} />

    {/* Site Behaviour */}
    <!-- {import.meta.env.PROD && <SiteBehaviour />} -->

    {/* Swipe Gestures for Article Navigation */}
    <script>
      class SwipeNavigationController {
        private touchStartX: number = 0;
        private touchEndX: number = 0;
        private touchStartY: number = 0;
        private touchEndY: number = 0;
        private readonly SWIPE_THRESHOLD: number = 100;
        private readonly VERTICAL_THRESHOLD: number = 50;

        constructor() {
          this.init();
        }

        private init(): void {
          document.addEventListener('touchstart', this.handleTouchStart.bind(this), {
            passive: true,
          });
          document.addEventListener('touchend', this.handleTouchEnd.bind(this), {
            passive: true,
          });
        }

        private handleTouchStart(event: TouchEvent): void {
          this.touchStartX = event.changedTouches[0].screenX;
          this.touchStartY = event.changedTouches[0].screenY;
        }

        private handleTouchEnd(event: TouchEvent): void {
          this.touchEndX = event.changedTouches[0].screenX;
          this.touchEndY = event.changedTouches[0].screenY;
          this.handleSwipe();
        }

        private handleSwipe(): void {
          const horizontalDiff = this.touchEndX - this.touchStartX;
          const verticalDiff = Math.abs(this.touchEndY - this.touchStartY);

          // Ignore if vertical swipe is too large (scrolling)
          if (verticalDiff > this.VERTICAL_THRESHOLD) {
            return;
          }

          // Swipe left - next article
          if (horizontalDiff < -this.SWIPE_THRESHOLD) {
            const nextLink = document.querySelector<HTMLAnchorElement>(
              'a[rel="next"]'
            );
            if (nextLink) {
              nextLink.click();
            }
          }

          // Swipe right - previous article
          if (horizontalDiff > this.SWIPE_THRESHOLD) {
            const prevLink = document.querySelector<HTMLAnchorElement>(
              'a[rel="prev"]'
            );
            if (prevLink) {
              prevLink.click();
            }
          }
        }
      }

      // Initialize on page load
      document.addEventListener('astro:page-load', () => {
        new SwipeNavigationController();
      });
    </script>
  </body>
</html>
