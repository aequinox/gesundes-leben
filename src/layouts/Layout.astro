---
import { ClientRouter } from "astro:transitions";

import Breadcrumb from "@/components/Breadcrumb.astro";
import BottomNav from "@/components/sections/BottomNav.astro";
import Header from "@/components/sections/Header.astro";
import { SEO } from "@/components/seo";
import SizeIndicator from "@/components/SizeIndicator.astro";
import type { NavigationLink } from "@/components/types";
import { SITE } from "@/config";

import "@/styles/global.css";

export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | undefined;
  scrollSmooth?: boolean;
  activeNav?: NavigationLink;
}

const {
  title = SITE.title,
  author = SITE.author,
  // profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  activeNav,
} = Astro.props;
---

<!doctype html>
<html
  lang=`${SITE.lang ?? "en"}`
  class={`${scrollSmooth && "scroll-smooth"}`}
  transition:animate="none"
>
  <head>
    <!-- Inline critical CSS for instant font rendering -->
    <style is:inline>
      :root {
        --font-body:
          "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      html {
        font-family: var(--font-body);
        font-synthesis: none;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      body {
        margin: 0;
        min-height: 100vh;
        line-height: 1.6;
      }
    </style>

    <SEO
      title={title}
      description={description}
      canonicalURL={canonicalURL.toString()}
      ogImage={ogImage}
      pageType={pubDatetime ? "article" : "webpage"}
      publishedTime={pubDatetime}
      modifiedTime={modDatetime}
      author={{ name: author }}
    />

    <ClientRouter />
    <script is:inline src="/toggle-theme.js"></script>
    <script>
      // Lazy load view transition CSS and enhancements on first navigation
      let viewTransitionsLoaded = false;

      document.addEventListener(
        "astro:before-preparation",
        async () => {
          if (viewTransitionsLoaded) return;
          viewTransitionsLoaded = true;

          // Load view transitions CSS
          const { loadViewTransitions } = await import(
            "@/utils/load-view-transitions"
          );
          await loadViewTransitions();

          // Load view transition enhancements when needed
          if (
            "startViewTransition" in document ||
            window.matchMedia("(prefers-reduced-motion: no-preference)").matches
          ) {
            import("@/utils/viewTransitionEnhancements")
              .then(_module => {
                // Module is auto-initialized on import
                // Use logger in development only
                if (import.meta.env.DEV) {
                  import("@/utils/logger").then(({ logger }) => {
                    logger.debug(
                      "View transition enhancements loaded successfully"
                    );
                  });
                }
              })
              .catch(error => {
                // Silently fail - view transitions are progressive enhancement
              });
          }
        },
        { once: true }
      );
    </script>
  </head>
  <body data-pagefind-body class="px-2 lg:px-12" data-astro-prefetch>
    <!-- Skip Navigation Link for Accessibility (WCAG AAA) -->
    <a href="#main-content" class="skip-link"> Zum Hauptinhalt springen </a>
    <Header activeNav={activeNav} />
    {Astro.url.pathname !== "/" && <Breadcrumb />}
    <main
      id="main-content"
      transition:animate="slide"
      transition:name="main-content"
    >
      <slot />
    </main>
    {import.meta.env.DEV && <SizeIndicator />}

    {/* Mobile Bottom Navigation */}
    <BottomNav activeNav={activeNav} />

    {/* Site Behaviour */}
    <!-- {import.meta.env.PROD && <SiteBehaviour />} -->

    {/* Swipe Gestures for Article Navigation */}
    <script>
      class SwipeNavigationController {
        private touchStartX: number = 0;
        private touchEndX: number = 0;
        private touchStartY: number = 0;
        private touchEndY: number = 0;
        private readonly SWIPE_THRESHOLD: number = 100;
        private readonly VERTICAL_THRESHOLD: number = 50;

        constructor() {
          this.init();
        }

        private init(): void {
          document.addEventListener(
            "touchstart",
            this.handleTouchStart.bind(this),
            {
              passive: true,
            }
          );
          document.addEventListener(
            "touchend",
            this.handleTouchEnd.bind(this),
            {
              passive: true,
            }
          );
        }

        private handleTouchStart(event: TouchEvent): void {
          this.touchStartX = event.changedTouches[0].screenX;
          this.touchStartY = event.changedTouches[0].screenY;
        }

        private handleTouchEnd(event: TouchEvent): void {
          this.touchEndX = event.changedTouches[0].screenX;
          this.touchEndY = event.changedTouches[0].screenY;
          this.handleSwipe();
        }

        private handleSwipe(): void {
          const horizontalDiff = this.touchEndX - this.touchStartX;
          const verticalDiff = Math.abs(this.touchEndY - this.touchStartY);

          // Ignore if vertical swipe is too large (scrolling)
          if (verticalDiff > this.VERTICAL_THRESHOLD) {
            return;
          }

          // Swipe left - next article
          if (horizontalDiff < -this.SWIPE_THRESHOLD) {
            const nextLink =
              document.querySelector<HTMLAnchorElement>('a[rel="next"]');
            if (nextLink) {
              nextLink.click();
            }
          }

          // Swipe right - previous article
          if (horizontalDiff > this.SWIPE_THRESHOLD) {
            const prevLink =
              document.querySelector<HTMLAnchorElement>('a[rel="prev"]');
            if (prevLink) {
              prevLink.click();
            }
          }
        }
      }

      // Initialize on page load
      document.addEventListener("astro:page-load", () => {
        new SwipeNavigationController();
      });
    </script>

    <style is:global>
      /* View Transitions - Enhanced Animation Control */

      /* Respect user's motion preferences */
      @media (prefers-reduced-motion: reduce) {
        ::view-transition-group(*),
        ::view-transition-old(*),
        ::view-transition-new(*) {
          animation-duration: 0.01ms !important;
          animation-delay: 0ms !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Smooth transitions for supported browsers */
      @media (prefers-reduced-motion: no-preference) {
        ::view-transition-old(root),
        ::view-transition-new(root) {
          animation-duration: 300ms;
          animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hero image transitions */
        ::view-transition-old(post-*-heroImage),
        ::view-transition-new(post-*-heroImage) {
          animation-duration: 400ms;
          animation-timing-function: cubic-bezier(0.19, 1, 0.22, 1);
          mix-blend-mode: normal;
        }

        /* Title transitions */
        ::view-transition-old(post-*-title),
        ::view-transition-new(post-*-title) {
          animation-duration: 350ms;
          animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tag transitions */
        ::view-transition-old(tag-*),
        ::view-transition-new(tag-*) {
          animation-duration: 250ms;
          animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* Fallback for browsers without view transition support */
      @supports not (view-transition-name: none) {
        [transition\:name] {
          transition:
            opacity 0.3s ease,
            transform 0.3s ease;
        }
      }
    </style>
  </body>
</html>
