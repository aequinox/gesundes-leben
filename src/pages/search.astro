---
import Footer from "@/components/sections/Footer.astro";
import Header from "@/components/sections/Header.astro";
import { SITE } from "@/config";
import { getI18nStrings } from "@/config/i18n";
import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";

import "@pagefind/default-ui/css/ui.css";

const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : "/";
const i18n = getI18nStrings("de");
---

<Layout title={`${i18n.search.pageTitle} | ${SITE.title}`}>
  <Header />
  <Main
    pageTitle={i18n.search.pageTitle}
    pageDesc={i18n.search.pageDescription}
  >
    <!-- Search loading skeleton -->
    <div
      id="search-loading"
      class="animate-pulse rounded-lg bg-card p-6"
      aria-hidden="true"
    >
      <div class="mb-4 h-12 rounded bg-muted"></div>
      <div class="space-y-3">
        <div class="h-4 w-3/4 rounded bg-muted"></div>
        <div class="h-4 w-1/2 rounded bg-muted"></div>
        <div class="h-4 w-5/6 rounded bg-muted"></div>
      </div>
    </div>

    <!-- Search container -->
    <div
      id="pagefind-search"
      transition:persist
      data-backurl={backUrl}
      role="search"
      aria-label={i18n.search.ariaLabel}
      style="display: none;"
    >
    </div>

    <!-- Accessibility announcements -->
    <div
      id="search-announcements"
      aria-live="polite"
      aria-atomic="true"
      class="sr-only"
    >
    </div>

    <!-- Keyboard shortcuts info -->
    <div
      class="text-muted-foreground mt-8 hidden rounded-lg bg-muted/50 p-4 text-sm sm:block"
    >
      <p>
        <kbd class="rounded border bg-background px-2 py-1 text-xs">Strg</kbd> +
        <kbd class="rounded border bg-background px-2 py-1 text-xs">K</kbd> Suche
        fokussieren · <kbd
          class="rounded border bg-background px-2 py-1 text-xs">Esc</kbd
        > Löschen
      </p>
    </div>
  </Main>
  <Footer />
</Layout>

<script>
  import type { LoggerConfig } from "@/utils/logger";
  import { logger, LogLevelName } from "@/utils/logger";

  // Configure logger for search component
  logger.configure({
    component: "search",
    minLevel: import.meta.env.DEV ? LogLevelName.DEBUG : LogLevelName.INFO,
  } satisfies LoggerConfig);

  // German search strings
  const searchStrings = {
    pageTitle: "Suche",
    pageDescription:
      "Durchsuche alle Artikel nach relevanten Gesundheits- und Wellness-Inhalten...",
    ariaLabel: "Artikel-Suche",
    placeholder: "Artikel durchsuchen...",
    devWarning:
      "DEV-Modus Warnung! Du musst das Projekt mindestens einmal erstellen, um die Suchergebnisse während der Entwicklung zu sehen.",
    buildCommand: "bun run build",
    noResults: "Keine Ergebnisse für [SEARCH_TERM] gefunden",
    oneResult: "Ein Ergebnis für [SEARCH_TERM]",
    manyResults: "[COUNT] Ergebnisse für [SEARCH_TERM]",
    searching: "Suche nach [SEARCH_TERM]...",
    clearSearch: "Suche löschen",
    loadMore: "Mehr laden",
    filters: {
      label: "Filter",
      tags: "Kategorien",
      type: "Typ",
    },
  } as const;

  // Global reference to event handlers for cleanup
  let searchInput: HTMLInputElement | null = null;
  let clearButton: HTMLButtonElement | null = null;

  /**
   * Resets the search parameter when input is cleared
   */
  function resetSearchParam(e: Event): void {
    try {
      const target = e.target as HTMLInputElement;
      if (target?.value.trim() === "") {
        history.replaceState(history.state, "", window.location.pathname);
        logger.debug("Search parameters reset");
      }
    } catch (error) {
      logger.error("Error resetting search parameters:", error);
    }
  }

  /**
   * Shows loading skeleton while search initializes
   */
  function showLoadingState(): void {
    const loadingEl = document.querySelector<HTMLElement>("#search-loading");
    const searchEl = document.querySelector<HTMLElement>("#pagefind-search");

    if (loadingEl && searchEl) {
      loadingEl.style.display = "block";
      searchEl.style.display = "none";
    }
  }

  /**
   * Hides loading skeleton and shows search interface
   */
  function hideLoadingState(): void {
    const loadingEl = document.querySelector<HTMLElement>("#search-loading");
    const searchEl = document.querySelector<HTMLElement>("#pagefind-search");

    if (loadingEl && searchEl) {
      loadingEl.style.display = "none";
      searchEl.style.display = "block";
    }
  }

  /**
   * Announces messages to screen readers
   */
  function announceToScreenReader(message: string): void {
    const announcements = document.querySelector<HTMLElement>(
      "#search-announcements"
    );
    if (announcements) {
      announcements.textContent = message;
      // Clear after announcement
      setTimeout(() => {
        announcements.textContent = "";
      }, 1000);
    }
  }

  /**
   * Sets up keyboard shortcuts for search
   */
  function setupKeyboardShortcuts(): void {
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      // Ctrl+K or Cmd+K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        const searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        if (searchInput) {
          searchInput.focus();
          announceToScreenReader("Suchfeld fokussiert");
        }
      }

      // Escape to clear search
      if (e.key === "Escape") {
        const searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        if (searchInput && document.activeElement === searchInput) {
          searchInput.value = "";
          searchInput.dispatchEvent(new Event("input", { bubbles: true }));
          announceToScreenReader("Suche gelöscht");
        }
      }
    });
  }

  /**
   * Initializes the Pagefind search functionality
   */
  function initSearch(): void {
    const pageFindSearch =
      document.querySelector<HTMLElement>("#pagefind-search");

    if (!pageFindSearch) {
      logger.warn("Pagefind search element not found");
      return;
    }

    // Show loading state
    showLoadingState();
    announceToScreenReader("Suchfunktion wird geladen...");

    const params = new URLSearchParams(window.location.search);

    const onIdle = window.requestIdleCallback || (cb => setTimeout(cb, 1));

    onIdle(async () => {
      try {
        // Import PagefindUI with proper error handling
        const { PagefindUI } = await import("@pagefind/default-ui");

        logger.debug("PagefindUI loaded successfully");

        // Display warning in dev mode
        if (import.meta.env.DEV) {
          pageFindSearch.innerHTML = `
            <div class="bg-muted/75 rounded p-4 space-y-4 mb-4">
              <p><strong>${searchStrings.devWarning.split("!")[0]}!</strong> ${searchStrings.devWarning.split("! ")[1]}</p>
              <code class="block bg-black text-white px-2 py-1 rounded">${searchStrings.buildCommand}</code>
            </div>
          `;
        }

        // Initialize pagefind UI with German translations
        const search = new PagefindUI({
          element: "#pagefind-search",
          showSubResults: true,
          showImages: false,
          excerptLength: 30,
          openFilters: [searchStrings.filters.tags, searchStrings.filters.type],
          translations: {
            placeholder: searchStrings.placeholder,
            clear_search: searchStrings.clearSearch,
            load_more: searchStrings.loadMore,
            search_label: searchStrings.ariaLabel,
            filters_label: searchStrings.filters.label,
            zero_results: searchStrings.noResults,
            many_results: searchStrings.manyResults,
            one_result: searchStrings.oneResult,
            searching: searchStrings.searching,
          },
          processTerm(term: string): string {
            try {
              params.set("q", term);
              history.replaceState(history.state, "", `?${params.toString()}`);

              const backUrl = pageFindSearch?.dataset?.backurl;
              if (backUrl) {
                sessionStorage.setItem(
                  "backUrl",
                  `${backUrl}?${params.toString()}`
                );
              }

              logger.debug(`Search term processed: ${term}`);
              return term;
            } catch (error) {
              logger.error("Error processing search term:", error);
              return term;
            }
          },
        });

        logger.info("Pagefind search initialized successfully");

        // Hide loading state and show search interface
        hideLoadingState();
        announceToScreenReader("Suche bereit");

        // Setup keyboard shortcuts
        setupKeyboardShortcuts();

        // If search param exists (eg: search?q=astro), trigger search
        const query = params.get("q");
        if (query) {
          search.triggerSearch(query);
          announceToScreenReader(`Suche nach ${query} gestartet`);
        }

        // Reset search param if search input is cleared
        searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        clearButton = document.querySelector<HTMLButtonElement>(
          ".pagefind-ui__search-clear"
        );

        // Add enhanced event listeners
        searchInput?.addEventListener("input", e => {
          resetSearchParam(e);
          const value = (e.target as HTMLInputElement).value;
          if (value.length > 2) {
            announceToScreenReader(
              `${searchStrings.searching.replace("[SEARCH_TERM]", value)}`
            );
          }
        });

        clearButton?.addEventListener("click", e => {
          resetSearchParam(e);
          announceToScreenReader("Suche gelöscht");
        });
      } catch (error) {
        logger.error("Failed to initialize Pagefind search:", error);

        // Hide loading state and show error
        hideLoadingState();
        announceToScreenReader("Fehler beim Laden der Suchfunktion");

        // Fallback error display
        if (pageFindSearch) {
          pageFindSearch.style.display = "block";
          pageFindSearch.innerHTML = `
            <div class="bg-destructive/10 border border-destructive/20 rounded p-4 mb-4">
              <p class="text-destructive font-medium">Suchfunktion konnte nicht geladen werden.</p>
              <p class="text-sm text-muted-foreground mt-2">Bitte lade die Seite neu oder kontaktiere den Support.</p>
              <button 
                class="mt-3 px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors"
                onclick="window.location.reload()"
              >
                Seite neu laden
              </button>
            </div>
          `;
        }
      }
    });
  }

  /**
   * Cleanup function for search component
   */
  function cleanupSearch(): void {
    try {
      // Remove event listeners to prevent memory leaks
      if (searchInput) {
        searchInput.removeEventListener("input", resetSearchParam);
        searchInput = null;
      }
      if (clearButton) {
        clearButton.removeEventListener("click", resetSearchParam);
        clearButton = null;
      }

      logger.debug("Search component cleaned up");
    } catch (error) {
      logger.error("Error during search cleanup:", error);
    }
  }

  // Initialize search on page load
  document.addEventListener("astro:after-swap", () => {
    const pagefindSearch = document.querySelector("#pagefind-search");

    // If pagefind search form already exists, don't initialize search component
    if (pagefindSearch && pagefindSearch.querySelector("form")) {
      logger.debug("Search already initialized, skipping");
      return;
    }

    logger.debug("Initializing search after page swap");
    initSearch();
  });

  // Cleanup on page unload
  document.addEventListener("astro:before-swap", cleanupSearch);

  // Initial search initialization
  logger.debug("Starting initial search initialization");
  initSearch();
</script>

<style is:global>
  /* Base styles */
  @reference "@/styles/global.css";

  /* Loading skeleton styles */
  #search-loading {
    transition: opacity 0.3s ease-in-out;
  }

  /* Search container styles */
  #pagefind-search {
    --pagefind-ui-scale: 0.95;
    --pagefind-ui-font: var(--font-popplers);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    transition: opacity 0.3s ease-in-out;

    form::before {
      background-color: var(--foreground);
    }

    input {
      font-weight: 400;
      border: 1px solid var(--border);
      transition:
        border-color 0.2s ease,
        box-shadow 0.2s ease;
    }

    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px hsl(var(--accent) / 0.1);
    }

    .pagefind-ui__result-title a {
      color: var(--accent);
      outline-offset: 2px;
      outline-color: var(--accent);
      transition: color 0.2s ease;
    }

    .pagefind-ui__result-title a:hover {
      color: hsl(var(--accent) / 0.8);
    }

    .pagefind-ui__result-title a:focus-visible,
    .pagefind-ui__search-clear:focus-visible {
      text-decoration-line: none;
      outline-width: 2px;
      outline-style: solid;
      outline-offset: 2px;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 0;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:before {
      font-family: system-ui;
    }

    /* Enhanced mobile responsiveness */
    @media (max-width: 768px) {
      --pagefind-ui-scale: 1;

      .pagefind-ui__search-input {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 12px 16px;
      }

      .pagefind-ui__result {
        padding: 16px 12px;
      }
    }
  }

  .pagefind-ui__result-excerpt mark {
    @apply bg-accent text-foreground;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
  }

  /* Accessibility improvements */
  @media (prefers-reduced-motion: reduce) {
    #search-loading,
    #pagefind-search,
    #pagefind-search input {
      transition: none;
    }

    #search-loading {
      animation: none;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    #pagefind-search input:focus-visible {
      outline-width: 3px;
      outline-style: solid;
    }

    .pagefind-ui__result-excerpt mark {
      outline: 2px solid;
    }
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
