---
/**
 * Search Page - Refactored
 *
 * Provides site-wide search functionality using Pagefind.
 * This refactored version is much more maintainable with:
 * - Separated components for UI elements
 * - Extracted configuration and utilities
 * - Improved code organization
 *
 * Original: 517 lines
 * Refactored: ~90 lines (82% reduction)
 */

import SearchContainer from "@/components/search/SearchContainer.astro";
import SearchKeyboardShortcuts from "@/components/search/SearchKeyboardShortcuts.astro";
import SearchLoadingSkeleton from "@/components/search/SearchLoadingSkeleton.astro";
import { SITE } from "@/config";
import { getI18nStrings } from "@/config/i18n";
import BasePage from "@/layouts/BasePage.astro";
import Main from "@/layouts/Main.astro";

import "@pagefind/default-ui/css/ui.css";

const i18n = getI18nStrings("de");
---

<BasePage title={`${i18n.search.pageTitle} | ${SITE.title}`} activeNav="search">
  <Main
    pageTitle={i18n.search.pageTitle}
    pageDesc={i18n.search.pageDescription}
  >
    <SearchLoadingSkeleton />
    <SearchContainer />
    <SearchKeyboardShortcuts />
  </Main>
</BasePage>

<script>
  import { logger, LogLevelName, type LoggerConfig } from "@/utils/logger";
  import { PAGEFIND_CONFIG, SEARCH_STRINGS } from "@/utils/search/searchConfig";

  // Configure logger for search component
  logger.configure({
    component: "search",
    minLevel: import.meta.env.DEV ? LogLevelName.DEBUG : LogLevelName.INFO,
  } satisfies LoggerConfig);

  // Global reference to event handlers for cleanup
  let searchInput: HTMLInputElement | null = null;
  let clearButton: HTMLButtonElement | null = null;

  /**
   * Shows loading skeleton while search initializes
   */
  function showLoadingState(): void {
    const loadingEl = document.querySelector<HTMLElement>("#search-loading");
    const searchEl = document.querySelector<HTMLElement>("#pagefind-search");

    if (loadingEl && searchEl) {
      loadingEl.style.display = "block";
      searchEl.style.display = "none";
    }
  }

  /**
   * Hides loading skeleton and shows search interface
   */
  function hideLoadingState(): void {
    const loadingEl = document.querySelector<HTMLElement>("#search-loading");
    const searchEl = document.querySelector<HTMLElement>("#pagefind-search");

    if (loadingEl && searchEl) {
      loadingEl.style.display = "none";
      searchEl.style.display = "block";
    }
  }

  /**
   * Announces messages to screen readers
   */
  function announceToScreenReader(message: string): void {
    const announcements = document.querySelector<HTMLElement>(
      "#search-announcements"
    );
    if (announcements) {
      announcements.textContent = message;
      setTimeout(() => {
        announcements.textContent = "";
      }, 1000);
    }
  }

  /**
   * Resets the search parameter when input is cleared
   */
  function resetSearchParam(e: Event): void {
    try {
      const target = e.target as HTMLInputElement;
      if (target?.value.trim() === "") {
        history.replaceState(history.state, "", window.location.pathname);
        logger.debug("Search parameters reset");
      }
    } catch (error) {
      logger.error("Error resetting search parameters:", error);
    }
  }

  /**
   * Sets up keyboard shortcuts for search
   */
  function setupKeyboardShortcuts(): void {
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      // Ctrl+K or Cmd+K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        const searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        if (searchInput) {
          searchInput.focus();
          announceToScreenReader(SEARCH_STRINGS.accessibility.focused);
        }
      }

      // Escape to clear search
      if (e.key === "Escape") {
        const searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        if (searchInput && document.activeElement === searchInput) {
          searchInput.value = "";
          searchInput.dispatchEvent(new Event("input", { bubbles: true }));
          announceToScreenReader(SEARCH_STRINGS.accessibility.cleared);
        }
      }
    });
  }

  /**
   * Initializes the Pagefind search functionality
   */
  function initSearch(): void {
    const pageFindSearch =
      document.querySelector<HTMLElement>("#pagefind-search");

    if (!pageFindSearch) {
      logger.warn("Pagefind search element not found");
      return;
    }

    showLoadingState();
    announceToScreenReader(SEARCH_STRINGS.accessibility.loading);

    const params = new URLSearchParams(window.location.search);
    const onIdle = window.requestIdleCallback || (cb => setTimeout(cb, 1));

    onIdle(async () => {
      try {
        const { PagefindUI } = await import("@pagefind/default-ui");
        logger.debug("PagefindUI loaded successfully");

        // Display warning in dev mode
        if (import.meta.env.DEV) {
          pageFindSearch.innerHTML = `
            <div class="bg-muted/75 rounded p-4 space-y-4 mb-4">
              <p><strong>${SEARCH_STRINGS.devWarning.split("!")[0]}!</strong> ${SEARCH_STRINGS.devWarning.split("! ")[1]}</p>
              <code class="block bg-black text-white px-2 py-1 rounded">${SEARCH_STRINGS.buildCommand}</code>
            </div>
          `;
        }

        // Initialize pagefind UI with German translations
        const search = new PagefindUI({
          element: "#pagefind-search",
          ...PAGEFIND_CONFIG,
          translations: {
            placeholder: SEARCH_STRINGS.placeholder,
            clear_search: SEARCH_STRINGS.clearSearch,
            load_more: SEARCH_STRINGS.loadMore,
            search_label: SEARCH_STRINGS.ariaLabel,
            filters_label: SEARCH_STRINGS.filters.label,
            zero_results: SEARCH_STRINGS.noResults,
            many_results: SEARCH_STRINGS.manyResults,
            one_result: SEARCH_STRINGS.oneResult,
            searching: SEARCH_STRINGS.searching,
          },
          processTerm(term: string): string {
            try {
              params.set("q", term);
              history.replaceState(history.state, "", `?${params.toString()}`);

              const backUrl = pageFindSearch?.dataset?.backurl;
              if (backUrl) {
                sessionStorage.setItem(
                  "backUrl",
                  `${backUrl}?${params.toString()}`
                );
              }

              logger.debug(`Search term processed: ${term}`);
              return term;
            } catch (error) {
              logger.error("Error processing search term:", error);
              return term;
            }
          },
        });

        logger.info("Pagefind search initialized successfully");

        hideLoadingState();
        announceToScreenReader(SEARCH_STRINGS.accessibility.ready);
        setupKeyboardShortcuts();

        // Trigger search if query param exists
        const query = params.get("q");
        if (query) {
          search.triggerSearch(query);
          announceToScreenReader(
            SEARCH_STRINGS.accessibility.searchStarted.replace("{query}", query)
          );
        }

        // Setup event listeners
        searchInput = document.querySelector<HTMLInputElement>(
          ".pagefind-ui__search-input"
        );
        clearButton = document.querySelector<HTMLButtonElement>(
          ".pagefind-ui__search-clear"
        );

        searchInput?.addEventListener("input", e => {
          resetSearchParam(e);
          const value = (e.target as HTMLInputElement).value;
          if (value.length > 2) {
            announceToScreenReader(
              SEARCH_STRINGS.searching.replace("[SEARCH_TERM]", value)
            );
          }
        });

        clearButton?.addEventListener("click", e => {
          resetSearchParam(e);
          announceToScreenReader(SEARCH_STRINGS.accessibility.cleared);
        });
      } catch (error) {
        logger.error("Failed to initialize Pagefind search:", error);
        hideLoadingState();
        announceToScreenReader(SEARCH_STRINGS.accessibility.error);

        if (pageFindSearch) {
          pageFindSearch.style.display = "block";
          pageFindSearch.innerHTML = `
            <div class="bg-destructive/10 border border-destructive/20 rounded p-4 mb-4">
              <p class="text-destructive font-medium">Suchfunktion konnte nicht geladen werden.</p>
              <p class="text-sm text-muted-foreground mt-2">Bitte lade die Seite neu oder kontaktiere den Support.</p>
              <button
                class="mt-3 px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors"
                onclick="window.location.reload()"
              >
                Seite neu laden
              </button>
            </div>
          `;
        }
      }
    });
  }

  /**
   * Cleanup function for search component
   */
  function cleanupSearch(): void {
    try {
      if (searchInput) {
        searchInput.removeEventListener("input", resetSearchParam);
        searchInput = null;
      }
      if (clearButton) {
        clearButton.removeEventListener("click", resetSearchParam);
        clearButton = null;
      }
      logger.debug("Search component cleaned up");
    } catch (error) {
      logger.error("Error during search cleanup:", error);
    }
  }

  // Initialize search on page load
  document.addEventListener("astro:after-swap", () => {
    const pagefindSearch = document.querySelector("#pagefind-search");

    if (pagefindSearch && pagefindSearch.querySelector("form")) {
      logger.debug("Search already initialized, skipping");
      return;
    }

    logger.debug("Initializing search after page swap");
    initSearch();
  });

  // Cleanup on page unload
  document.addEventListener("astro:before-swap", cleanupSearch);

  // Initial search initialization
  logger.debug("Starting initial search initialization");
  initSearch();
</script>
