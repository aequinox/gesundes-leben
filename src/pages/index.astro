---
import { Icon } from "astro-icon/components";

import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import Hr from "@/components/elements/Hr.astro";
import LinkButton from "@/components/elements/LinkButton.astro";
import SectionHeading from "@/components/elements/SectionHeading.astro";
import ContentGrid from "@/components/layout/ContentGrid.astro";
import SectionContainer from "@/components/layout/SectionContainer.astro";
import Card from "@/components/sections/Card.astro";
import Footer from "@/components/sections/Footer.astro";
import Header from "@/components/sections/Header.astro";
import Socials from "@/components/socials/Socials.astro";
import { SITE } from "@/config";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import Layout from "@/layouts/Layout.astro";
import { SOCIALS } from "@/socials";
import { processAllPosts } from "@/utils/posts";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Process all posts in a single operation to avoid duplicate processing
const sortedPosts = await processAllPosts({
  includeDrafts: false,
  sortDirection: "desc",
});

// Split posts into featured and non-featured
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

// Precompute post counts for performance
const featuredPostCount = featuredPosts.length;
const recentPostCount = Math.min(recentPosts.length, SITE.postPerIndex);

// Count active social links for conditional rendering
const socialCount = SOCIALS.filter(social => social.active).length;

// Extract critical images for preloading (LCP optimization)
const criticalImages = [];
if (featuredPosts.length > 0 && featuredPosts[0].data.heroImage) {
  criticalImages.push(featuredPosts[0].data.heroImage.src);
}
if (recentPosts.length > 0 && recentPosts[0].data.heroImage) {
  criticalImages.push(recentPosts[0].data.heroImage.src);
}
---

<Layout>
  <!-- Preload critical images for LCP optimization -->
  <Fragment slot="head">
    {
      criticalImages.map(imgSrc => (
        <link
          rel="preload"
          as="image"
          href={imgSrc}
          fetchpriority="high"
          imagesizes="(max-width: 768px) 100vw, 50vw"
        />
      ))
    }
  </Fragment>

  <Header />

  <main id="main-content" class="relative overflow-hidden" data-layout="index">
    {
      /* Background decorative elements with reduced opacity for better performance */
    }

    {/* Hero Section with enhanced styling and accessibility */}
    <SectionContainer
      id="hero"
      variant="gradient"
      withDecorations={true}
      padding="small"
      class="min-h-100"
    >
          <!-- Main heading -->
          <div class="mb-8 flex items-center justify-between">
            <div
              class="bg-gradient-to-r from-accent to-accent/70 bg-clip-text text-4xl font-black tracking-tight text-transparent transition-all duration-300 sm:text-6xl"
              data-aos="fade-right"
              data-aos-duration="600"
              aria-label="Site title"
            >
              Gesundes Leben
            </div>

            <a
              target="_blank"
              href="/rss.xml"
              class="relative mr-4 inline-flex items-center gap-2 rounded-full p-2 shadow-[var(--shadow-elevation-low)] transition-all duration-300 hover:scale-105 hover:shadow-[var(--shadow-elevation-medium)]"
              aria-label="RSS Feed"
              title="RSS Feed"
              data-aos="fade-left"
              data-aos-duration="600"
            >
              <Icon
                name="tabler:rss"
                class="h-6 w-6 fill-accent transition-transform duration-300 hover:scale-110 hover:rotate-360"
                aria-hidden="true"
              />
              <span class="sr-only">RSS Feed</span>
            </a>
          </div>

          <!-- Welcome message -->
          <h1
            class="mb-6 text-4xl leading-tight font-bold tracking-tight sm:text-5xl"
            data-aos="fade-up"
            data-aos-delay="50"
            data-aos-duration="600"
          >
            Willkommen auf unserem Blog!
          </h1>

          <!-- Introduction text -->
          <div
            class="max-w-content space-y-6 md:text-pretty"
            data-aos="fade-up"
            data-aos-delay="100"
            data-aos-duration="600"
          >
            <p class="my-4 text-base leading-relaxed md:text-lg">
              Auf diesem Blog stellen dir Sandra & Kai Artikel über
              Gesundheitsthemen zur Verfügung und laden dich ein auf eine Reise
              zu mehr Gesundheit, die Spaß machen soll.
              <span class="hashtag">sogehtgesund</span>
            </p>

            <p class="my-4 text-base leading-relaxed md:text-lg">
              Wir betreiben den Blog als Privatpersonen, teilen aber unser
              Insider-Wissen, das wir uns in unserer langjährigen Arbeit als
              Therapeuten angeeignet haben. Das möchten wir auf einfache und
              verständliche Weise tun, denn wir finden, dass medizinische
              Zusammenhänge häufig zu kompliziert und für Laien schwer
              nachvollziehbar vermittelt werden. Deshalb verlinken wir
              medizinische Begriffe, wenn sie nicht vermeidbar sind, auf unser <a
                href="/glossary/"
                class="font-medium text-accent hover:underline">Glossar</a
              >, wo du eine verständliche Erklärung findest.
            </p>

            <p class="my-4 text-base leading-relaxed md:text-lg">
              Unser Ziel ist <strong class="font-bold text-accent"
                >Empowerment für deine Gesundheit</strong
              >. Das bedeutet, wir möchten dich darin unterstützen, für deine
              Gesundheit aktiv zu werden und dir dafür unser Wissen und unsere
              Erfahrung kostenfrei zur Verfügung stellen.
              <span class="hashtag">weildueswertbist</span>
            </p>
          </div>

          <!-- Social links -->
          {
            socialCount > 0 && (
              <div
                class="mt-8 flex flex-col rounded-xl border border-accent/10 bg-gradient-to-b from-card/30 to-card-muted/30 p-4 shadow-elevation-low backdrop-blur-sm sm:flex-row sm:items-center"
                data-aos="fade-up"
                data-aos-delay="150"
                data-aos-duration="600"
              >
                <div class="social-links">
                  <Socials />
                </div>
              </div>
            )
          }
        </div>
    </SectionContainer>

    <Hr variant="dots" />

    {/* Featured Articles Section - Optimized animations and rendering */}
    {
      featuredPostCount > 0 && (
        <SectionContainer
          id="featured"
          animation="fade-up"
          animationDuration={600}
          optimized={true}
        >
          <SectionHeading
            icon="tabler:star"
            title="Ausgewählte Artikel"
            level={2}
          />

          <ContentGrid columns={3} gap="medium" class="mt-8">
            {featuredPosts.map((post, index) => (
              <div
                data-aos="fade-up"
                data-aos-delay={Math.min(index * 50, 500)}
              >
                <Card
                  post={post}
                  loading={index < 2 ? "eager" : "lazy"}
                  withHeroImage={true}
                />
              </div>
            ))}
          </ContentGrid>
        </SectionContainer>
      )
    }

    {/* Recent Articles Section - Optimized animations and rendering */}
    {
      recentPostCount > 0 && (
        <Fragment>
          <Hr variant="dots" />
          <SectionContainer
            id="recent-posts"
            animation="fade-up"
            animationDuration={600}
            optimized={true}
          >
            <SectionHeading
              icon="tabler:clock"
              title="Neueste Artikel"
              level={2}
            />

            <ContentGrid columns={3} gap="medium" class="mt-8">
              {recentPosts.slice(0, SITE.postPerIndex).map((post, index) => (
                <div
                  data-aos="fade-up"
                  data-aos-delay={Math.min(index * 50, 300)}
                >
                  <Card
                    post={post}
                    loading={index < 3 ? "eager" : "lazy"}
                    withHeroImage={true}
                  />
                </div>
              ))}
            </ContentGrid>
          </SectionContainer>
        </Fragment>
      )
    }

    {/* All Posts Button */}
    <div class="my-12 text-center" data-aos="fade-up" data-aos-duration="400">
      <LinkButton href="/posts/">
        {t("post.allPosts")}
        <IconArrowRight class="inline-block" />
      </LinkButton>
    </div>
  </main>
  <!-- </Main> -->
  <Footer />
</Layout>

<!-- Styles have been converted to Tailwind classes and applied directly to HTML elements -->

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
