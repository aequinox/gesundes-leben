---
import { getCollection } from "astro:content";
import Posts from "@/layouts/Posts.astro";
import { postService } from "@/services/content/PostService";
import getPagination from "@/utils/getPagination";
import getPageNumbers from "@/utils/getPageNumbers";
import { getPostsByCategory } from "@/utils/getPostsBy";
import { slugService } from "@/services/format/SlugService";

export async function getStaticPaths() {
  const posts = await postService.getAllPosts();
  const sortedPosts = await postService.getSortedPosts(posts);
  const totalPages = getPageNumbers(sortedPosts.length);

  return totalPages.map(page => ({
    params: { page: page.toString() },
  }));
}

const { page } = Astro.params;
const { url } = Astro;

// Get category from query parameter if it exists
const categoryParam = url.searchParams.get("category");

// Get all posts
const allPosts = await postService.getAllPosts();
const sortedPosts = await postService.getSortedPosts(allPosts);

// Filter posts by category if category parameter exists
let filteredPosts = sortedPosts;
let pageTitle = "Alle Artikel";

if (categoryParam) {
  // Convert from slug format back to original format (e.g., "immunsystem" -> "Immunsystem")
  const categories = [
    ...new Set(sortedPosts.flatMap(post => post.data.categories || [])),
  ];

  const matchedCategory = categories.find(
    category => slugService.slugifyStr(category) === categoryParam
  );

  if (matchedCategory) {
    filteredPosts = await getPostsByCategory(sortedPosts, matchedCategory);
    pageTitle = `Kategorie: ${matchedCategory}`;
  }
}

// Get pagination for the current page
const pagination = getPagination({
  posts: filteredPosts,
  page,
  isIndex: false,
});
---

<Posts {...pagination} pageTitle={pageTitle} />
