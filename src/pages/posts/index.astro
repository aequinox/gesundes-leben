---
import Posts from "@/layouts/Posts.astro";
import { postService } from "@/services/content/PostService";
import { paginationService } from "@/services/content/PaginationService";
import type { Pagination } from "@/types/pagination";
import type { CollectionEntry } from "astro:content";
import { slugService } from "@/services/format/SlugService";

// Get category from query parameter if it exists
const categoryParam = Astro.url.searchParams.get("category");

// Get all posts
const allPosts = await postService.getAllPosts();
const sortedPosts = await postService.getSortedPosts(allPosts);

// Filter posts by category if category parameter exists
let filteredPosts = sortedPosts;
let pageTitle = "Alle Artikel";

if (categoryParam) {
  // Convert from slug format back to original format (e.g., "immunsystem" -> "Immunsystem")
  const categories = [
    ...new Set(sortedPosts.flatMap(post => post.data.categories || [])),
  ];

  const matchedCategory = categories.find(
    category => slugService.slugifyStr(category) === categoryParam
  );

  if (matchedCategory) {
    filteredPosts = await postService.getPostsByCategory(
      sortedPosts,
      matchedCategory
    );
    pageTitle = `Kategorie: ${matchedCategory}`;
  }
}

const pagination: Pagination<CollectionEntry<"blog">> =
  paginationService.generatePagination({
    posts: filteredPosts,
    page: 1,
    isIndex: true,
  });
---

<Posts {...pagination} pageTitle={pageTitle} />
