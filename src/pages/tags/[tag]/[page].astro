---
import { type CollectionEntry, getCollection } from "astro:content";
import TagPosts from "@/layouts/TagPosts.astro";
import { tagService } from "@/services/content/TagService";
import { paginationService } from "@/services/content/PaginationService";
import { postService } from "@/services/content/PostService";

export interface Props {
  post: CollectionEntry<"blog">;
  tag: string;
  tagName: string;
}

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tags = tagService.extractUniqueTags(posts);

  const paths = await Promise.all(
    tags.map(async ({ tag, tagName }) => {
      const tagPosts = await postService.getPostsByTag(posts, tag);
      const totalPages = paginationService.calculatePageNumbers(
        tagPosts.length
      );

      return totalPages.map(page => ({
        params: { tag, page: page.toString() },
        props: { tag, tagName },
      }));
    })
  );

  return paths.flat();
}

const { page } = Astro.params;
const { tag, tagName } = Astro.props;

const posts = await getCollection(
  "blog",
  ({ data }: { data: CollectionEntry<"blog">["data"] }) => !data.draft
);

const postsByTag = await postService.getPostsByTag(posts, tag);

const pagination = paginationService.generatePagination({
  posts: postsByTag,
  page,
});
---

<TagPosts {...pagination} {tag} {tagName} />
