---
/**
 * Categories Overview Page
 *
 * Displays all blog categories with descriptions, post counts, and preview cards.
 * Enhanced with hero section, animations, and visual elements to match site design.
 */

import { Icon } from "astro-icon/components";

import Hr from "@/components/elements/Hr.astro";
import LinkButton from "@/components/elements/LinkButton.astro";
import SectionHeading from "@/components/elements/SectionHeading.astro";
import ContentGrid from "@/components/layout/ContentGrid.astro";
import SectionContainer from "@/components/layout/SectionContainer.astro";
import Card from "@/components/sections/Card.astro";
import Footer from "@/components/sections/Footer.astro";
import Header from "@/components/sections/Header.astro";
import PageHero from "@/components/sections/PageHero.astro";
import { SITE } from "@/config";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import Layout from "@/layouts/Layout.astro";
import { getCategoryCounts } from "@/utils/categories";
import { processAllPosts } from "@/utils/posts";
import { slugify } from "@/utils/slugs";
import type { Post } from "@/utils/types";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all published posts
const posts = await processAllPosts({ includeDrafts: false });

// Extract all unique categories from posts
const categories = [
  ...new Set(posts.flatMap(post => post.data.categories || [])),
].sort();

// Get post counts for each category
const categoryCounts = getCategoryCounts(posts);

// Group posts by category
const postsByCategory = categories.reduce(
  (acc, category) => {
    acc[category] = posts.filter(
      post => post.data.categories && post.data.categories.includes(category)
    );
    return acc;
  },
  {} as Record<string, typeof posts>
);

// Page metadata
const pageTitle = t("nav.categories");
const pageDescription = t("categories.description");

// Category icon mapping
const categoryIcons: Record<string, string> = {
  "Ernährung": "tabler:apple",
  "Immunsystem": "tabler:shield-check",
  "Lesenswertes": "tabler:book",
  "Lifestyle & Psyche": "tabler:heart",
  "Mikronährstoffe": "tabler:pill",
  "Organsysteme": "tabler:heartbeat",
  "Wissenschaftliches": "tabler:flask",
  "Wissenswertes": "tabler:bulb",
};

// Helper function to get category description from i18n
const getCategoryDescription = (category: string): string => {
  const slugified = slugify(category);
  const key = `categories.${slugified}.description` as keyof typeof t;
  try {
    return t(key);
  } catch {
    return "";
  }
};
---

<Layout title={`${pageTitle} | ${SITE.title}`} description={pageDescription}>
  <Header activeNav="categories" />

  <main id="main-content">
    <PageHero
      title={pageTitle}
      subtitle={pageDescription}
      fromColor="accent"
      toColor="accent/50"
    />

    <Hr variant="dots" />

    <!-- Category Overview Section -->
    <SectionContainer
      id="categories-overview"
      variant="gradient"
      withDecorations={true}
      animation="fade-up"
      animationDuration={600}
      padding="large"
    >
      <div class="mx-auto max-w-content">
        <!-- Introduction Text -->
        <div
          class="mb-12 text-center"
          data-aos="fade-up"
          data-aos-duration="600"
        >
          <p class="text-lg leading-relaxed opacity-90">
            Entdecke unsere Artikel nach Themengebieten sortiert. Jede
            Kategorie bietet dir fundiertes Wissen zu spezifischen
            Gesundheitsthemen.
          </p>
        </div>

        <!-- Category Grid -->
        <div class="mb-16 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          {
            categories.map((category, index) => {
              const slugified = slugify(category);
              const postCount = categoryCounts.get(slugified) || 0;
              const description = getCategoryDescription(category);
              const icon = categoryIcons[category] || "tabler:folder";

              return (
                <a
                  href={`/categories/${slugified}/`}
                  class="category-card group relative overflow-hidden rounded-xl border border-accent/20 bg-gradient-to-br from-card/80 to-card-muted/80 p-6 shadow-elevation-low backdrop-blur-sm transition-all duration-300 hover:scale-[1.02] hover:border-accent/40 hover:shadow-elevation-medium"
                  data-aos="fade-up"
                  data-aos-delay={Math.min(index * 50, 500)}
                  data-aos-duration="600"
                >
                  {/* Decorative gradient background */}
                  <div class="absolute top-0 right-0 -z-10 h-32 w-32 rounded-full bg-gradient-to-br from-accent/20 to-transparent opacity-0 blur-2xl transition-opacity duration-300 group-hover:opacity-100" />

                  {/* Category Header */}
                  <div class="mb-4 flex items-start justify-between">
                    <div class="flex items-center gap-3">
                      <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-accent/10 transition-colors duration-300 group-hover:bg-accent/20">
                        <Icon
                          name={icon}
                          class="h-6 w-6 text-accent transition-transform duration-300 group-hover:scale-110"
                          aria-hidden="true"
                        />
                      </div>
                      <h2 class="text-xl font-bold tracking-tight transition-colors duration-300 group-hover:text-accent">
                        {category}
                      </h2>
                    </div>
                    <span class="flex h-8 min-w-[2rem] items-center justify-center rounded-full bg-accent/10 px-3 text-sm font-semibold text-accent">
                      {postCount}
                    </span>
                  </div>

                  {/* Category Description */}
                  {description && (
                    <p class="mb-4 text-sm leading-relaxed opacity-80">
                      {description}
                    </p>
                  )}

                  {/* View Articles Link */}
                  <div class="mt-auto flex items-center gap-2 text-sm font-medium text-accent transition-all duration-300 group-hover:gap-3">
                    <span>Artikel ansehen</span>
                    <Icon
                      name="tabler:arrow-right"
                      class="h-4 w-4 transition-transform duration-300 group-hover:translate-x-1"
                      aria-hidden="true"
                    />
                  </div>
                </a>
              );
            })
          }
        </div>
      </div>
    </SectionContainer>

    <Hr variant="dots" />

    <!-- Featured Posts by Category Section -->
    {
      categories.map((category, categoryIndex) => {
        const slugified = slugify(category);
        const categoryPosts = postsByCategory[category];
        const postsToShow = categoryPosts.slice(0, SITE.postPerIndex || 6);
        const hasMorePosts = categoryPosts.length > (SITE.postPerIndex || 6);
        const icon = categoryIcons[category] || "tabler:folder";

        return (
          <>
            <SectionContainer
              id={`category-${slugified}`}
              animation="fade-up"
              animationDuration={600}
              padding="medium"
            >
              <div class="mx-auto max-w-content">
                {/* Category Section Header */}
                <div
                  class="mb-8 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center"
                  data-aos="fade-up"
                  data-aos-duration="600"
                >
                  <SectionHeading
                    icon={icon}
                    title={category}
                    level={2}
                    iconSize="medium"
                  />

                  <a
                    href={`/categories/${slugified}/`}
                    class="group flex items-center gap-2 text-sm font-medium text-accent transition-all duration-300 hover:gap-3"
                  >
                    <span>Alle Artikel</span>
                    <Icon
                      name="tabler:arrow-right"
                      class="h-4 w-4 transition-transform duration-300 group-hover:translate-x-1"
                      aria-hidden="true"
                    />
                  </a>
                </div>

                {/* Posts Grid */}
                <ContentGrid columns={3} gap="medium">
                  {postsToShow.map((post: Post, index: number) => (
                    <div
                      data-aos="fade-up"
                      data-aos-delay={Math.min(index * 50, 300)}
                      data-aos-duration="600"
                    >
                      <Card
                        post={post}
                        loading={categoryIndex === 0 && index < 3
                          ? "eager"
                          : "lazy"}
                        withCategories={false}
                        withMeta={true}
                        withHeroImage={true}
                      />
                    </div>
                  ))}
                </ContentGrid>

                {/* View All Link */}
                {hasMorePosts && (
                  <div
                    class="mt-8 text-center"
                    data-aos="fade-up"
                    data-aos-duration="400"
                  >
                    <LinkButton href={`/categories/${slugified}/`}>
                      Alle {categoryPosts.length} Artikel in "{category}"
                      ansehen
                      <Icon
                        name="tabler:arrow-right"
                        class="inline-block h-5 w-5"
                        aria-hidden="true"
                      />
                    </LinkButton>
                  </div>
                )}
              </div>
            </SectionContainer>

            {categoryIndex < categories.length - 1 && <Hr variant="dots" />}
          </>
        );
      })
    }
  </main>

  <Footer />
</Layout>

<style>
  @reference "@/styles/global.css";

  /* Category card hover effects */
  .category-card {
    position: relative;
  }

  .category-card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: linear-gradient(
      135deg,
      oklch(var(--color-accent) / 0.3),
      transparent 50%
    );
    -webkit-mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .category-card:hover::before {
    opacity: 1;
  }

  /* Accessibility - reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .category-card,
    .category-card * {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
    }
  }
</style>

<script>
  // Track page view for analytics
  document.addEventListener("astro:page-load", () => {
    const categoriesPage = document.querySelector("#main-content");
    if (categoriesPage) {
      sessionStorage.setItem("backUrl", "/categories");
    }
  });
</script>
