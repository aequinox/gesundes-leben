---
import Hr from "@/components/elements/Hr.astro";
import Card from "@/components/sections/Card.astro";
import Footer from "@/components/sections/Footer.astro";
import Header from "@/components/sections/Header.astro";
import { SITE } from "@/config";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";
import { processAllPosts } from "@/utils/posts";
import type { Post } from "@/utils/types";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all posts
const posts = await processAllPosts({ includeDrafts: false });
// const allPosts = await  getAllPosts();
// const sortedPosts = await  getSortedPosts(allPosts);

// Extract all unique categories from posts
const categories = [
  ...new Set(posts.flatMap(post => post.data.categories || [])),
].sort();

// Group posts by category
const postsByCategory = categories.reduce(
  (acc, category) => {
    acc[category] = posts.filter(
      post => post.data.categories && post.data.categories.includes(category)
    );
    return acc;
  },
  {} as Record<string, typeof posts>
);

// Page title and description
const pageTitle = t("nav.categories");
const pageDescription = t("post.allCategories");
---

<Layout title={`${pageTitle} | ${SITE.title}`}>
  <Header activeNav="categories" />
  <Main pageTitle={pageTitle} pageDesc={pageDescription}>
    <section class="mx-auto max-w-content px-4 pt-8 pb-12">
      <!-- <h1 class="text-3xl font-bold leading-tight tracking-wider sm:text-4xl">
        {pageTitle}
      </h1>
      <p class="mt-3 text-lg leading-relaxed text-base opacity-90">
        {pageDescription}
      </p> -->

      <div class="my-8">
        <Hr />
      </div>

      <div class="mt-8">
        {
          categories.map(category => (
            <section id={`category-${category}`} class="mb-12">
              <h2 class="mb-6 border-l-4 border-accent bg-gradient-to-r from-accent to-accent/90 bg-clip-text pl-4 text-2xl font-semibold tracking-wide text-transparent">
                {category}
              </h2>

              <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                {postsByCategory[category]
                  .slice(0, SITE.postPerIndex || 6)
                  .map((post: Post) => (
                    <Card
                      post={post}
                      loading="lazy"
                      withCategories={false}
                      withMeta={false}
                    />
                  ))}
              </div>

              {postsByCategory[category].length > (SITE.postPerIndex || 6) && (
                <div class="mt-4 text-right">
                  <a
                    href={`/posts/?category=${category.toLowerCase().replace(/\s+/g, "-")}`}
                    class="inline-block text-accent hover:underline"
                  >
                    Alle Artikel in "{category}" ansehen â†’
                  </a>
                </div>
              )}
            </section>
          ))
        }
      </div>
    </section>
  </Main>
  <Footer />
</Layout>

<style>
  /* Base styles */
  @reference "@/styles/global.css";

  /* h2 {
    @apply mb-6 text-2xl font-semibold tracking-wide text-accent border-l-4 border-accent pl-4;
    background: linear-gradient(
      to right,
      oklch(var(--color-accent)),
      oklch(var(--color-accent) / 0.7)
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  } */

  .grid {
    @apply gap-6;
  }

  .grid > div {
    @apply transition-all duration-300 ease-in-out;
  }

  .grid > div:hover {
    transform: translateY(-4px);
  }

  a.inline-block {
    @apply text-accent underline decoration-accent underline-offset-4 transition-colors duration-300 hover:decoration-wavy;
  }
</style>
