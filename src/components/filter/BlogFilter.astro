---
/**
 * BlogFilter Component
 *
 * A dynamic filtering system for blog posts that allows users to filter content by:
 * 1. Group type (pro, question-time, contra)
 * 2. Categories
 *
 * Features:
 * - Responsive grid layout
 * - Animated transitions
 * - Lazy loading for performance
 * - Accessibility support
 */

import { CATEGORIES } from "@/data/taxonomies";
import getSortedPosts from "@/utils/getSortedPosts";
import { getCollection } from "astro:content";
import Card from "@/components/sections/Card.astro";
import GroupSelector, {
  type Identifier,
} from "@/components/sections/GroupSelector.astro";

// Constants for group types to ensure consistency and type safety
const GROUP_TYPES = {
  PRO: "pro",
  QUESTION_TIME: "question-time",
  CONTRA: "contra",
} as const;

const allGroups: Identifier[] = [
  GROUP_TYPES.PRO,
  GROUP_TYPES.QUESTION_TIME,
  GROUP_TYPES.CONTRA,
];

// Initialize categories with "All" as the default option
const allCategories = ["Alle", ...CATEGORIES];

// Fetch and prepare blog posts
const posts = await getCollection("blog");
const sortedPosts = await getSortedPosts(posts);

// Extract unique categories from posts
const usedCategories: string[] = [
  "Alle",
  ...new Set(sortedPosts.map(post => post.data.categories).flat()),
];
---

<section
  id="category-filter"
  class="articles mx-auto max-w-content"
  transition:name="articles-filter"
  role="region"
  aria-label="Blog filter section"
>
  {/* Group Selector Grid */}
  <div
    id="group-selectors"
    class="mx-auto mt-4 grid max-w-content grid-cols-1 md:gap-0 gap-16 md:px-0 md:py-6 p-6 md:mt-12 md:grid-cols-3"
    role="tablist"
    aria-label="Content group filters"
  >
    {allGroups.map(group => <GroupSelector groupType={group} />)}
  </div>

  {/* Category Filter Buttons */}
  <div
    class="relative mb-8 flex flex-wrap justify-center gap-3 px-2 before:absolute before:inset-0 before:-z-10 before:rounded-xl before:bg-skin-fill/5 before:backdrop-blur-sm"
    id="category-buttons"
    role="toolbar"
    aria-label="Category filters"
  >
    {
      allCategories.map(category => (
        <button
          disabled={!usedCategories.includes(category)}
          class="category-button relative overflow-hidden rounded-lg border border-skin-accent/30 bg-skin-fill/60 px-6 py-2.5 text-sm font-medium tracking-wide backdrop-blur-md transition-all duration-300 before:absolute before:inset-0 before:-z-10 before:translate-y-full before:bg-skin-accent/20 before:transition-transform before:duration-300 before:content-[''] after:absolute after:inset-0 after:-z-20 after:bg-gradient-to-b after:from-skin-accent/5 after:to-transparent after:opacity-0 after:transition-opacity after:duration-300 hover:border-skin-accent/60 hover:shadow-lg hover:before:translate-y-0 hover:after:opacity-100 focus:outline-none focus:ring-2 focus:ring-skin-accent focus:ring-offset-2 focus:ring-offset-skin-fill disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:border-skin-accent/30 disabled:hover:shadow-none disabled:hover:before:translate-y-full disabled:hover:after:opacity-0 data-[active=true]:border-skin-accent/80 data-[active=true]:bg-skin-accent/20 data-[active=true]:before:translate-y-0 data-[active=true]:after:opacity-100"
          data-category={category}
          aria-pressed={category === "Alle"}
          aria-label={`Filter by ${category} category`}
        >
          {category}
        </button>
      ))
    }
    <!-- {
      allCategories.map(category => (
        <button
          disabled={!usedCategories.includes(category)}
          class="category-button hover:text-skin my-2 mr-2 transform rounded border border-skin-accent bg-skin-fill px-4 py-2 text-sm hover:scale-105 hover:bg-skin-accent focus:outline-none focus:ring-2 focus:ring-skin-accent active:bg-skin-accent disabled:opacity-50 disabled:hover:transform-none disabled:hover:bg-skin-fill"
          data-category={category}
        >
          {category}
        </button>
      ))
    } -->
  </div>

  {/* Article Grid */}
  <div
    class="grid grid-cols-1 gap-6 p-4 sm:grid-cols-2 lg:grid-cols-3"
    id="article-grid"
    role="feed"
    aria-live="polite"
  >
    {
      sortedPosts.map((post, index) => (
        <Card {post} loading={index < 6 ? "eager" : "lazy"} />
      ))
    }
  </div>
</section>

<style>
  .category-button {
    transform: translateZ(0);
    backface-visibility: hidden;
    will-change: transform;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .show {
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .hide {
    animation: fadeOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  /* Hover effect for active cards */
  #article-grid article {
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  #article-grid article:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.1);
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    #category-buttons {
      gap: 2;
      padding: 0 1rem;
    }

    .category-button {
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
    }
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .category-button,
    #article-grid article,
    .show,
    .hide {
      transition: none;
      animation: none;
      transform: none;
    }

    .category-button::before,
    .category-button::after {
      display: none;
    }
  }
</style>

<script>
  /**
   * TypeScript interfaces for better type safety and documentation
   */
  interface DOMElements {
    articleGrid: HTMLElement;
    articleCards: HTMLElement[];
    categoryButtons: HTMLElement[];
    groupSelectors: HTMLElement[];
  }

  interface CardDataset extends DOMStringMap {
    group?: GroupType;
    categories?: string;
  }

  // Type-safe group constants
  const GROUP_TYPES = {
    PRO: "pro",
    QUESTION_TIME: "question-time",
    CONTRA: "contra",
  } as const;

  type GroupType = (typeof GROUP_TYPES)[keyof typeof GROUP_TYPES];

  const allGroups: GroupType[] = [
    GROUP_TYPES.PRO,
    GROUP_TYPES.QUESTION_TIME,
    GROUP_TYPES.CONTRA,
  ];

  /**
   * Initializes DOM elements and returns them as a typed object
   * @returns {DOMElements} Object containing all necessary DOM elements
   */
  function initializeDOMElements(): DOMElements {
    const articleGrid = document.getElementById("article-grid") as HTMLElement;
    if (!articleGrid) throw new Error("Article grid element not found");

    return {
      articleGrid,
      articleCards: Array.from(
        articleGrid.querySelectorAll(".article-card")
      ) as HTMLElement[],
      categoryButtons: Array.from(
        document.querySelectorAll(".category-button")
      ) as HTMLElement[],
      groupSelectors: Array.from(
        document.querySelectorAll(".group-selector")
      ) as HTMLElement[],
    };
  }

  /**
   * Updates the visual order of group selectors
   * @param {HTMLElement} clickedSelector - The selector that was clicked
   * @param {HTMLElement[]} groupSelectors - All group selector elements
   */
  function orderGroupSelectors(
    clickedSelector: HTMLElement,
    groupSelectors: HTMLElement[]
  ): void {
    const clickedIndex = groupSelectors.indexOf(clickedSelector);

    groupSelectors.forEach((selector, i) => {
      selector.classList.toggle(
        "left",
        (i + 1) % groupSelectors.length === clickedIndex
      );
      selector.classList.toggle("middle", i === clickedIndex);
      selector.classList.toggle(
        "right",
        i !== clickedIndex && (i + 1) % groupSelectors.length !== clickedIndex
      );
    });
  }

  /**
   * Handles the visibility of articles based on selected group
   * @param {HTMLElement[]} articleCards - All article card elements
   * @param {GroupType} selectedGroup - The selected group type
   */
  function updateArticleVisibility(
    articleCards: HTMLElement[],
    selectedGroup: GroupType
  ): void {
    articleCards.forEach(card => {
      const isMatchingGroup =
        (card.dataset as CardDataset).group === selectedGroup;
      card.classList.toggle("hide", !isMatchingGroup);
      card.classList.toggle("show", isMatchingGroup);
      card.toggleAttribute("data-aos", isMatchingGroup);
    });
  }

  /**
   * Handles filtering articles by category
   * @param {HTMLElement[]} articleCards - All article card elements
   * @param {string} category - The selected category
   */
  function handleCategoryFilter(
    articleCards: HTMLElement[],
    category: string
  ): void {
    // Update active state of category buttons
    const categoryButtons = document.querySelectorAll(".category-button");
    categoryButtons.forEach(button => {
      button.setAttribute(
        "data-active",
        (button.getAttribute("data-category") === category).toString()
      );
    });

    articleCards.forEach(card => {
      const cardCategories =
        (card.dataset as CardDataset).categories?.split("|") || [];
      const shouldShow =
        category === "Alle" || cardCategories.includes(category);

      card.classList.toggle("hide", !shouldShow);
      card.classList.toggle("show", shouldShow);
    });
  }

  /**
   * Initializes all event listeners
   * @param {DOMElements} elements - Object containing all DOM elements
   */
  function initializeEventListeners(elements: DOMElements): void {
    const { articleCards, categoryButtons, groupSelectors } = elements;

    // Group filter event listeners
    allGroups.forEach(group => {
      const button = document.getElementById(`${group}-group`);
      if (!button) return;

      button.addEventListener("click", () => {
        orderGroupSelectors(button, groupSelectors);
        updateArticleVisibility(articleCards, group);
      });
    });

    // Category filter event listeners
    categoryButtons.forEach(button => {
      button.addEventListener("click", () => {
        const category = button.dataset.category;
        if (category) {
          handleCategoryFilter(articleCards, category);
        }
      });
    });
  }

  // Initialize filtering system when page loads
  document.addEventListener("astro:page-load", () => {
    try {
      const elements = initializeDOMElements();
      initializeEventListeners(elements);
    } catch (error) {
      console.error("Failed to initialize blog filter:", error);
    }
  });
</script>
