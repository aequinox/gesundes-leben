---
/**
 * RelatedPosts Component
 *
 * Enhanced component for displaying related blog posts with intelligent content analysis.
 * Uses advanced scoring algorithm based on content relationships, topic clusters, and SEO optimization.
 *
 * @component
 * @example
 * ```astro
 * <RelatedPosts
 *   post={post}
 *   maxPosts={3}
 *   useAdvancedAnalysis={true}
 * />
 * ```
 */

import { getCollection } from "astro:content";

import Card from "@/components/sections/Card.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { getRelatedPosts, getSortedPosts } from "@/utils/posts";
import { analyzeContentRelationships, identifyTopicCluster, TOPIC_CLUSTERS } from "@/utils/internal-linking";
import type { Post } from "@/utils/types";

interface Props {
  /** The current blog post */
  post: Post;
  /** Maximum number of related posts to display */
  maxPosts?: number;
  /** Animation type for data-aos attribute */
  animationType?: string;
  /** Whether to use advanced content analysis */
  useAdvancedAnalysis?: boolean;
  /** Whether to show relationship scores in dev mode */
  showDebugInfo?: boolean;
}

const { 
  post, 
  maxPosts = 3, 
  animationType = "fade-up",
  useAdvancedAnalysis = true,
  showDebugInfo = false 
}: Props = Astro.props;

// Get translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch all posts
const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);

// Get related posts using enhanced algorithm
let relatedPosts: Post[] = [];
let relationshipData: Array<{
  targetPost: Post;  
  score: number;
  matchReasons: string[];
  suggestedAnchorText: string[];
  linkingContext: 'strong' | 'moderate' | 'weak';
}> = [];

if (useAdvancedAnalysis) {
  // Use advanced content relationship analysis
  const relationships = analyzeContentRelationships(post, sortedPosts, maxPosts);
  relatedPosts = relationships.map(rel => rel.targetPost);
  relationshipData = relationships;
} else {
  // Fallback to original algorithm
  relatedPosts = getRelatedPosts(post, sortedPosts, maxPosts);
}

// Get topic cluster information for context
const currentCluster = identifyTopicCluster(post);
const clusterInfo = currentCluster ? TOPIC_CLUSTERS[currentCluster] : null;

// No related posts message from i18n
const noRelatedPostsMessage = t("post.noRelatedPosts");
---

<section
  class="related-posts-section"
  aria-labelledby="related-posts-heading"
  data-aos={animationType}
  data-cluster={currentCluster}
>
  <div class="related-posts-header">
    <h2 id="related-posts-heading" class="related-posts-heading">
      {t("post.relatedPosts")}
      {clusterInfo && (
        <span class="cluster-badge" title={`Teil der ${clusterInfo.name} Serie`}>
          ðŸ“š {clusterInfo.name}
        </span>
      )}
    </h2>
    
    {/* Cluster context information */}
    {clusterInfo && useAdvancedAnalysis && (
      <p class="cluster-context">
        Diese Artikel gehÃ¶ren zu unserer umfassenden Serie Ã¼ber {clusterInfo.name.toLowerCase()}.
      </p>
    )}
  </div>

  {
    relatedPosts.length > 0 ? (
      <div class="related-posts-grid">
        {relatedPosts.map((relatedPost, index) => {
          const relationship = useAdvancedAnalysis ? relationshipData[index] : null;
          
          return (
            <div
              class={`related-post-item ${relationship ? `related-post-item--${relationship.linkingContext}` : ''}`}
              style={`--animation-order: ${index};`}
              data-aos="fade-up"
              data-aos-delay={index * 100}
              data-relationship-score={relationship?.score}
            >
              <Card
                post={relatedPost}
                size="small"
                withHeroImage={true}
                loading="lazy"
                withMeta={false}
                withDescription={true}
                withReadMore={true}
                withCategories={true}
                maxCategories={2}
              />
              
              {/* Enhanced relationship indicators */}
              {relationship && relationship.linkingContext === 'strong' && (
                <div class="relationship-indicator">
                  <span class="relationship-badge">Stark verwandt</span>
                </div>
              )}
              
              {/* Dev mode: Show relationship debugging */}
              {showDebugInfo && import.meta.env.DEV && relationship && (
                <div class="relationship-debug">
                  <small>
                    Score: {relationship.score} | 
                    Context: {relationship.linkingContext} |
                    Reasons: {relationship.matchReasons.slice(0, 2).join(', ')}
                  </small>
                </div>
              )}
            </div>
          );
        })}
      </div>
    ) : (
      <div class="related-posts-empty">
        <p>{noRelatedPostsMessage}</p>
      </div>
    )
  }

  {/* Enhanced footer with cluster navigation */}
  {clusterInfo && useAdvancedAnalysis && (
    <footer class="related-posts-footer">
      <div class="cluster-navigation">
        <p class="cluster-cta">
          <strong>ðŸ’¡ Entdecken Sie mehr:</strong> 
          Alle Artikel zu {clusterInfo.name} fÃ¼r ein umfassendes VerstÃ¤ndnis
        </p>
      </div>
    </footer>
  )}
</section>

<style>
  @reference "@/styles/global.css";

  /* Base section styling */
  .related-posts-section {
    @apply relative isolate mt-4 pt-4;
  }

  /* Header styling */
  .related-posts-header {
    @apply relative mb-6 flex flex-col;
  }

  .related-posts-heading {
    @apply relative mb-3 flex flex-wrap items-center gap-3 text-2xl font-semibold text-accent md:text-3xl;
  }

  .cluster-badge {
    @apply inline-flex items-center gap-1 px-3 py-1 text-sm font-medium bg-accent/10 text-accent rounded-full border border-accent/20;
    font-size: 0.875rem;
  }

  .cluster-context {
    @apply text-sm text-gray-600 dark:text-gray-400 leading-relaxed max-w-2xl;
  }

  .related-posts-icon {
    @apply h-6 w-6 text-[--color-accent];
  }

  /* Grid layout */
  .related-posts-grid {
    @apply grid grid-cols-1 gap-2;
  }

  /* Empty state */
  .related-posts-empty {
    @apply rounded-[--border-radius-lg] p-4 text-center italic backdrop-blur-md;
    color: oklch(var(--color-text-base) / 0.7);
    background-color: oklch(var(--color-card) / 0.3);
  }

  /* Animation for staggered items */
  .related-post-item {
    @apply m-0 opacity-0 relative;
    transform: translateY(20px);
    animation: fadeInStaggered 0.5s ease-out forwards;
    animation-delay: calc(var(--animation-order, 0) * 100ms + 200ms);
  }

  @keyframes fadeInStaggered {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Relationship context styling */
  .related-post-item--strong {
    @apply ring-2 ring-accent/20 rounded-lg;
  }

  .related-post-item--moderate {
    @apply ring-1 ring-accent/10 rounded-lg;
  }

  .related-post-item--weak {
    @apply opacity-90;
  }

  /* Relationship indicators */
  .relationship-indicator {
    @apply absolute top-2 right-2 z-10;
  }

  .relationship-badge {
    @apply px-2 py-1 text-xs font-medium bg-accent text-white rounded-md shadow-sm;
  }

  /* Debug information (dev mode only) */
  .relationship-debug {
    @apply mt-2 p-2 bg-gray-100 dark:bg-gray-800 rounded text-xs text-gray-600 dark:text-gray-400 border border-dashed border-gray-300 dark:border-gray-600;
  }

  /* Footer styling */
  .related-posts-footer {
    @apply mt-6 pt-4 border-t border-border/30;
  }

  .cluster-navigation {
    @apply text-center;
  }

  .cluster-cta {
    @apply text-sm text-gray-600 dark:text-gray-400 leading-relaxed p-3 bg-accent/5 rounded-lg border border-accent/10;
  }

  /* Responsive adjustments */
  @media (min-width: 768px) {
    .related-posts-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .related-posts-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .related-post-item {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>
