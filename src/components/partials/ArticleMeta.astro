---
import Author from "@/components/partials/Author.astro";
import Datetime from "@/components/partials/Datetime.astro";
import ReadingTime from "@/components/partials/ReadingTime.astro";
import { getAuthorEntry } from "@/utils/getAuthor";
import { slugifyStr } from "@/utils/slugify";
import { type CollectionEntry } from "astro:content";

type PostType = CollectionEntry<"blog"> | CollectionEntry<"glossary">;

interface Props {
  post: PostType;
  withDatetime?: boolean;
  withReadingTime?: boolean;
  withAuthor?: boolean;
  size?: "sm" | "lg";
  classes?: string;
}

const {
  post,
  withDatetime = true,
  withReadingTime = false,
  withAuthor = false,
  size = "sm",
  classes = "",
}: Props = Astro.props;

const { title, author, pubDatetime, modDatetime } = post.data;

// Type guard to check if post is a blog post with reading time
const isBlogPost = (post: PostType): post is CollectionEntry<"blog"> => {
  return post.collection === "blog";
};

// Get reading time only if it's a blog post
const readingTime = isBlogPost(post) ? post.data.readingTime : undefined;

// Get author data asynchronously
const authorEntry = await getAuthorEntry(author);

// Generate unique transition names for animations
const getTransitionName = (suffix: string) => slugifyStr(title + suffix);

// Determine if we should show separators
const showFirstSeparator = withDatetime && withReadingTime && readingTime;
const showSecondSeparator =
  (withDatetime || (withReadingTime && readingTime)) &&
  withAuthor &&
  authorEntry;
---

<div class:list={["flex flex-wrap items-center space-x-2", classes.trim()]}>
  {
    withDatetime && (
      <>
        <Datetime
          pubDatetime={pubDatetime}
          modDatetime={modDatetime}
          size={size}
          transition:name={getTransitionName(pubDatetime.toString())}
        />
        {showFirstSeparator && (
          <span class="opacity-80" aria-hidden="true">
            |
          </span>
        )}
      </>
    )
  }
  {
    withReadingTime && readingTime && (
      <>
        <ReadingTime
          readingTime={readingTime}
          size={size}
          transition:name={getTransitionName(readingTime.toString())}
        />
        {showSecondSeparator && (
          <span class="opacity-80" aria-hidden="true">
            |
          </span>
        )}
      </>
    )
  }
  {
    withAuthor && authorEntry && (
      <Author
        author={authorEntry}
        size={size}
        transition:name={getTransitionName(authorEntry.data.name)}
      />
    )
  }
</div>
