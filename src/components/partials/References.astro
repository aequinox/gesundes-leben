---
import { getI18nStrings } from "@/config/i18n";
import { logger } from "@/utils/logger";
import { getReferencesByIds, type Reference } from "@/utils/references";

interface Props {
  referenceIds: string[];
}

const { referenceIds } = Astro.props;
const i18n = getI18nStrings("de");

// Get references data using the utility function
let references: Reference[] = [];
let debugInfo = "";

try {
  if (referenceIds && referenceIds.length > 0) {
    debugInfo = `Loading ${referenceIds.length} references: ${referenceIds.join(", ")}`;
    logger.info(debugInfo);

    references = await getReferencesByIds(referenceIds);

    if (references.length === 0) {
      debugInfo = `No references found for IDs: ${referenceIds.join(", ")}`;
      logger.warn(debugInfo);
    } else {
      logger.info(
        `Successfully loaded ${references.length}/${referenceIds.length} references`
      );

      // Log each reference for debugging
      references.forEach((ref, i) => {
        logger.info(
          `Reference ${i + 1}: ${ref.id} - ${ref.title} (${ref.type})`
        );
      });

      // Check for missing references
      const foundIds = references.map(ref => ref.id);
      const missingIds = referenceIds.filter(id => !foundIds.includes(id));
      if (missingIds.length > 0) {
        logger.warn(`Missing references: ${missingIds.join(", ")}`);
        debugInfo += ` | Missing: ${missingIds.join(", ")}`;
      }
    }
  } else {
    debugInfo = `No reference IDs provided`;
    logger.info(debugInfo);
  }
} catch (error) {
  logger.error("Failed to load references:", error);
  debugInfo = `Error loading references: ${error}`;
}

// Calculate reference types and metadata
const journalCount = references.filter(ref => ref.type === "journal").length;
const websiteCount = references.filter(ref => ref.type === "website").length;
const bookCount = references.filter(ref => ref.type === "book").length;
const reportCount = references.filter(ref => ref.type === "report").length;
const otherCount = references.filter(ref => ref.type === "other").length;
const totalReferences = references.length;

// Generate keywords from all references
const allKeywords = references
  .flatMap(ref => ref.keywords || [])
  .filter((keyword, index, array) => array.indexOf(keyword) === index) // Remove duplicates
  .slice(0, 10); // Limit to 10 most relevant keywords

// Generate authors list
const allAuthors = references
  .flatMap(ref => ref.authors || [])
  .filter((author, index, array) => array.indexOf(author) === index)
  .slice(0, 8); // Limit to 8 authors for metadata

// Create localized summary text
const summaryText = i18n.references.summary
  .replace("{count}", totalReferences.toString())
  .replace("{journals}", journalCount.toString())
  .replace("{books}", bookCount.toString())
  .replace("{websites}", websiteCount.toString())
  .replace("{reports}", reportCount.toString())
  .replace("{others}", otherCount.toString());
---

{
  totalReferences > 0 && (
    <section
      class="mt-8 rounded-lg border bg-muted/30 p-6"
      data-pagefind-weight="12"
      data-pagefind-meta={`referenceCount:${totalReferences},journalReferences:${journalCount},websiteReferences:${websiteCount},bookReferences:${bookCount},reportReferences:${reportCount},otherReferences:${otherCount},scientificKeywords:${allKeywords.join(",")},referenceAuthors:${allAuthors.join(",")},hasScientificReferences:true,contentType:references`}
      data-pagefind-filter={i18n.references.title}
      aria-labelledby="references-heading"
    >
      <h2
        id="references-heading"
        class="mb-4 text-xl font-semibold text-foreground"
        data-pagefind-weight="15"
      >
        {i18n.references.title}
      </h2>

      {/* References Metadata Summary for Search */}
      <div
        class="sr-only"
        data-pagefind-meta={`referenceSummary:${summaryText}`}
      >
        {summaryText}
      </div>

      <ol class="space-y-4" role="list">
        {references.map((ref, index) => (
          <li
            class="text-sm leading-relaxed"
            data-pagefind-weight="8"
            data-pagefind-meta={`referenceType:${ref.type},referenceYear:${ref.year},doi:${ref.doi || "none"}`}
          >
            <div class="flex gap-3">
              <span class="text-muted-foreground flex-shrink-0 font-medium">
                [{index + 1}]
              </span>
              <div class="flex-1">
                {/* Authors */}
                {ref.authors && ref.authors.length > 0 && (
                  <span
                    class="font-medium text-foreground"
                    data-pagefind-meta={`authors:${ref.authors.join(", ")}`}
                  >
                    {ref.authors.join(", ")}
                    {ref.authors.length === 1 ? "" : " et al."}
                  </span>
                )}

                {/* Year */}
                {ref.year && (
                  <span class="text-muted-foreground"> ({ref.year}). </span>
                )}

                {/* Title */}
                <span
                  class="font-medium text-accent hover:text-accent/80"
                  data-pagefind-weight="10"
                  data-pagefind-meta={`referenceTitle:${ref.title}`}
                >
                  {ref.title}
                </span>

                {/* Journal info for journal articles */}
                {ref.type === "journal" && (
                  <span class="text-muted-foreground">
                    .{" "}
                    <em data-pagefind-meta={`journal:${ref.journal}`}>
                      {ref.journal}
                    </em>
                    {ref.volume && `, ${ref.volume}`}
                    {ref.issue && `(${ref.issue})`}
                    {ref.pages && `, ${ref.pages}`}
                  </span>
                )}

                {/* Book info for books */}
                {ref.type === "book" && (
                  <span class="text-muted-foreground">
                    . {ref.edition && `${ref.edition}. `}
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        {ref.publisher}
                      </span>
                    )}
                    {ref.location && `, ${ref.location}`}
                  </span>
                )}

                {/* Report info for reports */}
                {ref.type === "report" && (
                  <span class="text-muted-foreground">
                    .{" "}
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        {ref.publisher}
                      </span>
                    )}
                    {ref.location && `, ${ref.location}`}
                  </span>
                )}

                {/* Other info for other types */}
                {ref.type === "other" && (
                  <span class="text-muted-foreground">
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        . {ref.publisher}
                      </span>
                    )}
                  </span>
                )}

                {/* DOI, PMID and URL */}
                <div class="mt-1 flex flex-wrap gap-4 text-xs">
                  {ref.doi && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">DOI:</span>
                      <a
                        href={`https://doi.org/${ref.doi}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="font-mono text-accent hover:text-accent/80 hover:underline"
                        data-pagefind-meta={`doi:${ref.doi}`}
                      >
                        {ref.doi}
                      </a>
                    </div>
                  )}

                  {ref.pmid && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">PMID:</span>
                      <a
                        href={`https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="font-mono text-accent hover:text-accent/80 hover:underline"
                        data-pagefind-meta={`pmid:${ref.pmid}`}
                      >
                        {ref.pmid}
                      </a>
                    </div>
                  )}

                  {ref.isbn && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">ISBN:</span>
                      <span
                        class="text-muted-foreground font-mono"
                        data-pagefind-meta={`isbn:${ref.isbn}`}
                      >
                        {ref.isbn}
                      </span>
                    </div>
                  )}

                  {ref.url && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">URL:</span>
                      <a
                        href={ref.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="break-all text-accent hover:text-accent/80 hover:underline"
                        aria-label={`${i18n.references.externalSourceLabel} ${ref.title}`}
                      >
                        {ref.url.replace(/^https?:\/\//, "")}
                      </a>
                    </div>
                  )}
                </div>

                {/* Keywords for search indexing */}
                {ref.keywords && ref.keywords.length > 0 && (
                  <div
                    class="sr-only"
                    data-pagefind-meta={`keywords:${ref.keywords.join(",")}`}
                  >
                    {i18n.references.keywordLabel} {ref.keywords.join(", ")}
                  </div>
                )}

                {/* Abstract for search indexing */}
                {ref.abstract && (
                  <div
                    class="sr-only"
                    data-pagefind-weight="6"
                    data-pagefind-meta={`hasAbstract:true`}
                  >
                    {i18n.references.summaryLabel} {ref.abstract}
                  </div>
                )}
              </div>
            </div>
          </li>
        ))}
      </ol>

      {/* Scientific credibility indicator */}
      <div class="text-muted-foreground mt-4 flex items-center gap-2 text-xs">
        <svg
          class="h-4 w-4 text-green-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span data-pagefind-meta="scientificallyBacked:true">
          {i18n.references.credibilityIndicator.replace(
            "{count}",
            totalReferences.toString()
          )}
        </span>
      </div>
    </section>
  )
}

<style>
  /* Enhanced styling for references */
  .references-list {
    counter-reset: reference-counter;
  }

  .references-list li {
    counter-increment: reference-counter;
  }

  /* Ensure proper text wrapping for long URLs */
  .references-list a {
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Focus indicators for accessibility */
  .references-list a:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    border-radius: 2px;
  }

  /* Print styles */
  @media print {
    .references-list a {
      color: black;
      text-decoration: underline;
    }

    .references-list a:after {
      content: " (" attr(href) ")";
      font-size: 0.8em;
      color: #666;
    }
  }
</style>
