---
import { readFile } from "node:fs/promises";
import { join } from "node:path";

import { parse } from "yaml";

import { t } from "@/config/i18n";

interface Props {
  referenceIds: string[];
}

// Reference interface (copied from the working debug component)
interface ReferenceData {
  type: string;
  title: string;
  authors: string[];
  year: number;
  journal?: string;
  volume?: number;
  issue?: number | string;
  pages?: string;
  doi?: string;
  publisher?: string;
  location?: string;
  url?: string;
  pmid?: string;
  keywords?: string[];
  abstract?: string;
}

interface Reference extends ReferenceData {
  id: string;
}

const { referenceIds } = Astro.props;

// Get references data using direct YAML reading
const references: Reference[] = [];

// Load references directly from YAML files (same approach as working debug component)
try {
  if (referenceIds && referenceIds.length > 0) {
    for (const id of referenceIds) {
      try {
        const filePath = join(
          process.cwd(),
          "src/data/references",
          `${id}.yaml`
        );
        const content = await readFile(filePath, "utf8");
        const data = parse(content) as ReferenceData;

        references.push({
          id,
          ...data,
        });
      } catch {
        // Silently skip failed references in production
      }
    }
  }
} catch {
  // Silently handle errors in production
}

// Calculate total references
const totalReferences = references.length;

// Simple summary and credibility text
const summaryText = `${totalReferences} wissenschaftliche Quellen`;
const credibilityText = t("references.credibilityIndicator", {
  values: { count: totalReferences },
});
---

{
  totalReferences > 0 && (
    <section
      class="mt-8 rounded-lg border bg-muted/30 p-6"
      data-pagefind-weight="12"
      data-pagefind-meta="contentType:references,hasScientificReferences:true"
      aria-labelledby="references-heading"
      aria-label={t("references.accessibility.referenceSection")}
    >
      <h2
        id="references-heading"
        class="mb-4 text-xl font-semibold text-foreground"
        data-pagefind-weight="15"
      >
        {t("references.title")}
      </h2>

      {/* References Metadata Summary for Search */}
      <div
        class="sr-only"
        data-pagefind-meta={`referenceSummary:${summaryText}`}
      >
        {summaryText}
      </div>

      <ol
        class="space-y-4"
        role="list"
        aria-label={t("references.accessibility.referenceList")}
      >
        {references.map((ref, index) => (
          <li
            class="text-sm leading-relaxed"
            data-pagefind-weight="8"
            data-pagefind-meta={`referenceType:${ref.type},referenceYear:${ref.year}`}
            aria-label={t("references.accessibility.referenceItem", {
              values: { index: index + 1 },
            })}
          >
            <div class="flex gap-3">
              <span class="text-muted-foreground flex-shrink-0 font-medium">
                [{index + 1}]
              </span>
              <div class="flex-1">
                {/* Authors */}
                {ref.authors && ref.authors.length > 0 && (
                  <span
                    class="font-medium text-foreground"
                    data-pagefind-meta={`authors:${ref.authors.join(", ")}`}
                  >
                    {ref.authors.join(", ")}
                    {ref.authors.length === 1 ? "" : " et al."}
                  </span>
                )}

                {/* Year */}
                {ref.year && (
                  <span class="text-muted-foreground"> ({ref.year}). </span>
                )}

                {/* Title */}
                <span
                  class="font-medium text-accent hover:text-accent/80"
                  data-pagefind-weight="10"
                  data-pagefind-meta={`referenceTitle:${ref.title}`}
                >
                  {ref.title}
                </span>

                {/* Journal info for journal articles */}
                {ref.type === "journal" && (
                  <span class="text-muted-foreground">
                    .{" "}
                    <em data-pagefind-meta={`journal:${ref.journal}`}>
                      {ref.journal}
                    </em>
                    {ref.volume && `, ${ref.volume}`}
                    {ref.issue && `(${ref.issue})`}
                    {ref.pages && `, ${ref.pages}`}
                  </span>
                )}

                {/* Book info for books */}
                {ref.type === "book" && (
                  <span class="text-muted-foreground">
                    . {ref.edition && `${ref.edition}. `}
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        {ref.publisher}
                      </span>
                    )}
                    {ref.location && `, ${ref.location}`}
                  </span>
                )}

                {/* Report info for reports */}
                {ref.type === "report" && (
                  <span class="text-muted-foreground">
                    .{" "}
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        {ref.publisher}
                      </span>
                    )}
                    {ref.location && `, ${ref.location}`}
                  </span>
                )}

                {/* Other info for other types */}
                {ref.type === "other" && (
                  <span class="text-muted-foreground">
                    {ref.publisher && (
                      <span data-pagefind-meta={`publisher:${ref.publisher}`}>
                        . {ref.publisher}
                      </span>
                    )}
                  </span>
                )}

                {/* DOI, PMID and URL */}
                <div class="mt-1 flex flex-wrap gap-4 text-xs">
                  {ref.doi && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">DOI:</span>
                      <a
                        href={`https://doi.org/${ref.doi}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="font-mono text-accent hover:text-accent/80 hover:underline"
                        data-pagefind-meta={`doi:${ref.doi}`}
                        aria-label={t("references.accessibility.doiLink", {
                          values: { title: ref.title },
                        })}
                      >
                        {ref.doi}
                      </a>
                    </div>
                  )}

                  {ref.pmid && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">PMID:</span>
                      <a
                        href={`https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="font-mono text-accent hover:text-accent/80 hover:underline"
                        data-pagefind-meta={`pmid:${ref.pmid}`}
                        aria-label={t("references.accessibility.pmidLink", {
                          values: { title: ref.title },
                        })}
                      >
                        {ref.pmid}
                      </a>
                    </div>
                  )}

                  {ref.isbn && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">ISBN:</span>
                      <span
                        class="text-muted-foreground font-mono"
                        data-pagefind-meta={`isbn:${ref.isbn}`}
                      >
                        {ref.isbn}
                      </span>
                    </div>
                  )}

                  {ref.url && (
                    <div class="flex items-center gap-1">
                      <span class="text-muted-foreground">URL:</span>
                      <a
                        href={ref.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="break-all text-accent hover:text-accent/80 hover:underline"
                        aria-label={t("references.accessibility.externalLink", {
                          values: { title: ref.title },
                        })}
                      >
                        {ref.url.replace(/^https?:\/\//, "")}
                      </a>
                    </div>
                  )}
                </div>

                {/* Keywords for search indexing */}
                {ref.keywords && ref.keywords.length > 0 && (
                  <div
                    class="sr-only"
                    data-pagefind-meta={`keywords:${ref.keywords.join(",")}`}
                  >
                    {t("references.keywordLabel")} {ref.keywords.join(", ")}
                  </div>
                )}

                {/* Abstract for search indexing */}
                {ref.abstract && (
                  <div
                    class="sr-only"
                    data-pagefind-weight="6"
                    data-pagefind-meta={`hasAbstract:true`}
                  >
                    {t("references.summaryLabel")} {ref.abstract}
                  </div>
                )}
              </div>
            </div>
          </li>
        ))}
      </ol>

      {/* Scientific credibility indicator */}
      <div class="text-muted-foreground mt-4 flex items-center gap-2 text-xs">
        <svg
          class="h-4 w-4 text-green-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span data-pagefind-meta="scientificallyBacked:true">
          {credibilityText}
        </span>
      </div>
    </section>
  )
}

<style>
  /* Enhanced styling for references */
  .references-list {
    counter-reset: reference-counter;
  }

  .references-list li {
    counter-increment: reference-counter;
  }

  /* Ensure proper text wrapping for long URLs */
  .references-list a {
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Focus indicators for accessibility */
  .references-list a:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    border-radius: 2px;
  }

  /* Print styles */
  @media print {
    .references-list a {
      color: black;
      text-decoration: underline;
    }

    .references-list a:after {
      content: " (" attr(href) ")";
      font-size: 0.8em;
      color: #666;
    }
  }
</style>
