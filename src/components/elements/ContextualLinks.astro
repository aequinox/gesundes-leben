---
/**
 * ContextualLinks Component
 *
 * Displays intelligent contextual link suggestions within article content.
 * Uses content analysis to suggest relevant internal links with varied anchor text.
 *
 * @component
 * @example
 * ```astro
 * <ContextualLinks
 *   currentPost={post}
 *   maxLinks={3}
 *   placement="inline"
 * />
 * ```
 */

import InternalLink from "@/components/elements/InternalLink.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { analyzeContentRelationships } from "@/utils/internal-linking";
import { generateSessionId } from "@/utils/internal-linking-analytics";
import { extractSlugFromPath } from "@/utils/slugs";
import { processAllPosts } from "@/utils/posts";
import type { Post } from "@/utils/types";

export interface Props {
  /** Current post for context analysis */
  currentPost: Post;
  /** Maximum number of links to display */
  maxLinks?: number;
  /** Where the links are placed */
  placement?: "inline" | "sidebar" | "footer";
  /** Visual style of the container */
  variant?: "simple" | "boxed" | "highlighted";
  /** Custom title for the section */
  title?: string;
  /** Whether to show relationship scores (dev mode) */
  showScores?: boolean;
}

const {
  currentPost,
  maxLinks = 3,
  placement = "inline",
  variant = "simple",
  title,
  showScores = false,
} = Astro.props;

// Get translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch all posts for relationship analysis (with slug property)
const sortedPosts = await processAllPosts({ includeDrafts: false });

// Analyze content relationships
const relationships = analyzeContentRelationships(
  currentPost,
  sortedPosts,
  maxLinks
);

// Filter only meaningful relationships
const meaningfulRelationships = relationships.filter(rel => rel.score >= 5);

// Default titles based on placement
const defaultTitles = {
  inline: t("cluster.relatedArticles"),
  sidebar: t("cluster.furtherInformation"),
  footer: t("cluster.mightAlsoInterest"),
};

const sectionTitle = title || defaultTitles[placement];

// Generate session ID for tracking
const sessionId = generateSessionId();

// Get current page info for analytics
const currentPath = Astro.url.pathname;
const currentSlug = extractSlugFromPath(currentPath);

// Don't render if no meaningful relationships found
if (meaningfulRelationships.length === 0) {
  return null;
}
---

<section
  class={`contextual-links contextual-links--${variant} contextual-links--${placement}`}
  aria-labelledby="contextual-links-heading"
  data-contextual-links
  data-current-post={currentSlug}
  data-session-id={sessionId}
>
  <h3 id="contextual-links-heading" class="contextual-links__title">
    {sectionTitle}
  </h3>

  <div class="contextual-links__container">
    {
      meaningfulRelationships.map(relationship => {
        const {
          targetPost,
          suggestedAnchorText,
          linkingContext,
          score,
          matchReasons,
        } = relationship;

        // Choose best anchor text (first suggestion is usually best)
        const anchorText = suggestedAnchorText[0] || targetPost.data.title;

        // Determine link variant based on context strength
        const linkVariant =
          placement === "inline"
            ? "inline"
            : linkingContext === "strong"
              ? "highlight"
              : "subtle";

        return (
          <div class="contextual-links__item">
            <InternalLink
              href={`/posts/${targetPost.slug}`}
              variant={linkVariant}
              context={linkingContext}
              placement={
                placement === "inline"
                  ? "content"
                  : placement === "footer"
                    ? "content"
                    : placement
              }
              icon={linkingContext === "strong" ? "related" : ""}
              title={`${targetPost.data.title} - ${matchReasons.join(", ")}`}
            >
              {anchorText}
            </InternalLink>

            {/* Dev mode: Show relationship scores and reasons */}
            {showScores && import.meta.env.DEV && (
              <div class="contextual-links__debug">
                <small>
                  Score: {score} | {matchReasons.join(", ")}
                </small>
              </div>
            )}
          </div>
        );
      })
    }
  </div>
</section>

<style>
  @reference "@/styles/global.css";
  /* Base contextual links styles */
  .contextual-links {
    @apply mt-6 mb-4;
  }

  .contextual-links__title {
    @apply mb-3 text-lg font-semibold text-foreground;
  }

  .contextual-links__container {
    @apply space-y-2;
  }

  .contextual-links__item {
    @apply flex items-start;
  }

  /* Variant: Simple */
  .contextual-links--simple {
    @apply border-l-2 pl-4;
    border-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.3);
  }

  .contextual-links--simple .contextual-links__title {
    @apply text-base font-medium;
    color: oklch(var(--color-accent, 0.5 0.15 250));
  }

  /* Variant: Boxed */
  .contextual-links--boxed {
    @apply rounded-lg border border-border/50 bg-card/30 p-4;
    backdrop-filter: blur(8px);
  }

  .contextual-links--boxed .contextual-links__title {
    @apply mb-4;
    color: oklch(var(--color-accent, 0.5 0.15 250));
  }

  .contextual-links--boxed .contextual-links__container {
    @apply space-y-3;
  }

  /* Variant: Highlighted */
  .contextual-links--highlighted {
    @apply rounded-xl border p-4;
    border-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.2);
    background: linear-gradient(
      to right,
      oklch(var(--color-accent, 0.5 0.15 250) / 0.1),
      oklch(var(--color-accent, 0.5 0.15 250) / 0.05),
      transparent
    );
  }

  .contextual-links--highlighted .contextual-links__title {
    @apply flex items-center gap-2 font-semibold;
    color: oklch(var(--color-accent, 0.5 0.15 250) / 0.9);
  }

  .contextual-links--highlighted .contextual-links__title::before {
    content: "ðŸ”—";
    @apply opacity-60;
  }

  /* Placement: Inline (within content) */
  .contextual-links--inline {
    @apply my-8;
  }

  .contextual-links--inline .contextual-links__container {
    @apply flex flex-wrap gap-3;
  }

  .contextual-links--inline .contextual-links__item {
    @apply flex-shrink-0;
  }

  /* Placement: Sidebar */
  .contextual-links--sidebar {
    @apply text-sm;
  }

  .contextual-links--sidebar .contextual-links__title {
    @apply mb-2 text-sm font-medium;
  }

  .contextual-links--sidebar .contextual-links__container {
    @apply space-y-1.5;
  }

  /* Placement: Footer */
  .contextual-links--footer {
    @apply mt-8 border-t border-border/30 pt-6;
  }

  .contextual-links--footer .contextual-links__container {
    @apply grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-3;
  }

  /* Debug information (dev mode only) */
  .contextual-links__debug {
    @apply ml-2 text-xs opacity-60;
    color: oklch(var(--color-text-muted));
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .contextual-links--inline .contextual-links__container {
      @apply flex-col gap-2;
    }

    .contextual-links--footer .contextual-links__container {
      @apply grid-cols-1;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    .contextual-links--boxed {
      @apply border-2 border-accent;
    }

    .contextual-links--highlighted {
      @apply border-2 border-accent bg-accent/20;
    }

    .contextual-links--simple {
      @apply border-l-4;
    }
  }

  /* Dark mode optimizations */
  @media (prefers-color-scheme: dark) {
    .contextual-links--boxed {
      @apply bg-card/20;
    }

    .contextual-links--highlighted {
      @apply from-accent/8 to-transparent;
    }
  }

  /* Print styles */
  @media print {
    .contextual-links {
      @apply mb-4 border border-gray-300 p-3;
    }

    .contextual-links__title {
      @apply font-bold text-black;
    }

    .contextual-links__debug {
      display: none;
    }
  }
</style>

<script>
  /**
   * Track contextual link interactions and performance
   */

  // Helper function to extract slug from path
  const extractSlugFromPath = (path: string): string => {
    return path.split("/").pop() || "unknown";
  };

  // Track contextual link clicks
  document.addEventListener("click", async event => {
    const target = event.target as HTMLElement;
    const link = target.closest(".internal-link") as HTMLAnchorElement;
    const contextualSection = target.closest(
      "[data-contextual-links]"
    ) as HTMLElement;

    if (link && contextualSection) {
      const linkText = link.textContent?.trim() || "";
      const currentPost = contextualSection.dataset.currentPost || "unknown";
      const sessionId = contextualSection.dataset.sessionId;

      // Extract target post from href
      const href = link.getAttribute("href") || "";
      const targetPost = extractSlugFromPath(href);

      const clickEvent = {
        linkType: "contextual" as const,
        sourcePost: currentPost,
        targetPost,
        linkText,
        variant: link.dataset.variant || "inline",
        context: link.dataset.context || "moderate",
        timestamp: Date.now(),
        sessionId,
      };

      // Dynamically import and track the click
      try {
        const { trackLinkClick } = await import(
          "@/utils/internal-linking-analytics"
        );
        trackLinkClick(clickEvent);
      } catch (error) {
        // Silently fail - analytics are non-critical
      }
    }
  });

  // Track contextual links section visibility for engagement metrics
  document.addEventListener("DOMContentLoaded", () => {
    const contextualSections = document.querySelectorAll(
      "[data-contextual-links]"
    );

    if ("IntersectionObserver" in window) {
      const observer = new IntersectionObserver(
        entries => {
          entries.forEach(async entry => {
            if (entry.isIntersecting) {
              const section = entry.target as HTMLElement;
              const currentPost = section.dataset.currentPost || "unknown";
              const sessionId = section.dataset.sessionId;

              // Track section view for engagement analysis
              const viewEvent = {
                linkType: "contextual" as const,
                sourcePost: currentPost,
                targetPost: "section-view",
                linkText: "contextual_section_viewed",
                variant: "view",
                context: "engagement",
                timestamp: Date.now(),
                sessionId,
              };

              // Dynamically import and track the view
              try {
                const { trackLinkClick } = await import(
                  "@/utils/internal-linking-analytics"
                );
                trackLinkClick(viewEvent);
              } catch (error) {
                // Silently fail - analytics are non-critical
              }

              // Only track once per section
              observer.unobserve(section);
            }
          });
        },
        {
          threshold: 0.5, // Track when 50% of section is visible
        }
      );

      contextualSections.forEach(section => observer.observe(section));
    }
  });
</script>
