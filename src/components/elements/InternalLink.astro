---
/**
 * InternalLink Component
 *
 * Intelligent internal linking component with SEO optimization.
 * Provides contextual link suggestions, proper anchor text variation,
 * and performance tracking for internal link building.
 *
 * @component
 * @example
 * ```astro
 * <InternalLink
 *   href="/posts/vitamin-d-mangel"
 *   variant="inline"
 *   context="strong"
 * >
 *   Vitamin D Mangel erkennen
 * </InternalLink>
 * ```
 */

import { generateSessionId } from "@/utils/internal-linking-analytics";
import { extractSlugFromPath } from "@/utils/slugs";

export interface Props {
  /** Target URL or post slug */
  href: string;
  /** Visual style variant */
  variant?: "inline" | "button" | "highlight" | "subtle";
  /** Relationship strength for styling */
  context?: "strong" | "moderate" | "weak";
  /** Whether to open in new tab */
  external?: boolean;
  /** Whether to track click analytics */
  trackClick?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Icon to display with link */
  icon?: string;
  /** Tooltip text */
  title?: string;
  /** Whether link is within content or in sidebar */
  placement?: "content" | "sidebar" | "navigation";
}

const {
  href,
  variant = "inline",
  context = "moderate",
  external = false,
  trackClick = true,
  class: additionalClasses = "",
  icon,
  title,
  placement = "content",
} = Astro.props;

// Ensure proper URL formatting
const finalHref = href.startsWith("/") ? href : `/posts/${href}`;

// Get current page info for analytics
const currentPath = Astro.url.pathname;
const currentSlug = extractSlugFromPath(currentPath);
const targetSlug = extractSlugFromPath(finalHref);

// Generate session ID for tracking
const sessionId = generateSessionId();

// Generate tracking attributes for analytics
const trackingAttributes = trackClick
  ? {
      "data-link-type": "internal",
      "data-source-post": currentSlug,
      "data-target-post": targetSlug,
      "data-variant": variant,
      "data-context": context,
      "data-placement": placement,
      "data-session-id": sessionId,
    }
  : {};

// Build CSS classes based on variant and context
const baseClasses = "internal-link";
const variantClasses = {
  inline: "internal-link--inline",
  button: "internal-link--button",
  highlight: "internal-link--highlight",
  subtle: "internal-link--subtle",
};

const contextClasses = {
  strong: "internal-link--strong",
  moderate: "internal-link--moderate",
  weak: "internal-link--weak",
};

const placementClasses = {
  content: "internal-link--in-content",
  sidebar: "internal-link--in-sidebar",
  navigation: "internal-link--in-nav",
};

const linkClasses = [
  baseClasses,
  variantClasses[variant],
  contextClasses[context],
  placementClasses[placement],
  additionalClasses,
]
  .filter(Boolean)
  .join(" ");

// Icon component mapping
const iconMap: Record<string, string> = {
  "arrow-right": "‚Üí",
  external: "‚Üó",
  related: "üîó",
  info: "‚Ñπ",
  health: "üè•",
  nutrition: "ü•ó",
  mental: "üß†",
  vitamin: "üíä",
};

const iconSymbol = icon && iconMap[icon] ? iconMap[icon] : null;
---

<a
  href={finalHref}
  class={linkClasses}
  title={title}
  target={external ? "_blank" : undefined}
  rel={external ? "noopener noreferrer" : undefined}
  {...trackingAttributes}
>
  {
    iconSymbol && (
      <span class="internal-link__icon" aria-hidden="true">
        {iconSymbol}
      </span>
    )
  }
  <span class="internal-link__text"><slot /></span>
  {
    variant === "button" && (
      <span class="internal-link__arrow" aria-hidden="true">
        ‚Üí
      </span>
    )
  }
</a>

<style>
  @reference "@/styles/global.css";
  /* Base internal link styles */
  .internal-link {
    @apply relative inline-flex items-center transition-all duration-200;
    text-decoration: none;
    gap: 0.25rem;
    color: oklch(var(--color-accent, 0.5 0.15 250));
    transition-timing-function: cubic-bezier(0, 0, 0.2, 1);

    /* Hover animations */
    &:hover {
      color: oklch(var(--color-accent-hover, 0.4 0.2 250));
      transform: translateX(1px);
    }

    &:focus {
      @apply rounded-sm outline-2 outline-offset-2;
      outline-color: oklch(var(--color-accent, 0.5 0.15 250));
    }
  }

  /* Variant styles */
  .internal-link--inline {
    @apply underline underline-offset-2;
    text-decoration-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.3);

    &:hover {
      text-decoration-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.6);
      text-decoration-thickness: 2px;
    }
  }

  .internal-link--button {
    @apply rounded-lg px-3 py-2 font-medium no-underline;
    background-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.1);
    border: 1px solid oklch(var(--color-accent, 0.5 0.15 250) / 0.2);

    &:hover {
      background-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.2);
      border-color: oklch(var(--color-accent, 0.5 0.15 250) / 0.4);
      transform: translateY(-1px);
    }
  }

  .internal-link--highlight {
    @apply rounded-md px-2 py-1 font-medium no-underline;
    background: linear-gradient(
      to right,
      oklch(var(--color-accent, 0.5 0.15 250) / 0.2),
      oklch(var(--color-accent, 0.5 0.15 250) / 0.1)
    );

    &:hover {
      background: linear-gradient(
        to right,
        oklch(var(--color-accent, 0.5 0.15 250) / 0.3),
        oklch(var(--color-accent, 0.5 0.15 250) / 0.2)
      );
    }
  }

  .internal-link--subtle {
    @apply underline decoration-dotted;
    color: oklch(var(--color-text-muted, 0.6 0.05 250));
    text-decoration-color: oklch(var(--color-text-muted, 0.6 0.05 250) / 0.4);

    &:hover {
      color: oklch(var(--color-foreground, 0.2 0.05 250));
      text-decoration-color: oklch(var(--color-foreground, 0.2 0.05 250) / 0.6);
    }
  }

  /* Context strength styles */
  .internal-link--strong {
    @apply font-semibold;

    &.internal-link--inline {
      text-decoration-thickness: 2px;
    }
  }

  .internal-link--moderate {
    @apply font-medium;
  }

  .internal-link--weak {
    @apply font-normal opacity-90;

    &:hover {
      @apply opacity-100;
    }
  }

  /* Placement-specific styles */
  .internal-link--in-content {
    color: inherit;

    &.internal-link--inline {
      color: oklch(var(--color-accent, 0.5 0.15 250));
    }
  }

  .internal-link--in-sidebar {
    @apply text-sm font-medium;
    color: oklch(var(--color-text-muted, 0.6 0.05 250));

    &:hover {
      color: oklch(var(--color-accent, 0.5 0.15 250));
    }
  }

  .internal-link--in-nav {
    @apply text-base font-medium;
  }

  /* Icon styles */
  .internal-link__icon {
    @apply text-sm opacity-70;
  }

  .internal-link__text {
    @apply flex-1;
  }

  .internal-link__arrow {
    @apply text-sm opacity-60 transition-transform duration-200;
  }

  .internal-link--button:hover .internal-link__arrow {
    transform: translateX(2px);
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .internal-link--button {
      @apply px-2 py-1.5 text-sm;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .internal-link {
      @apply underline;
    }

    .internal-link--button {
      @apply border-2;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .internal-link {
      transition: none;

      &:hover {
        transform: none;
      }
    }

    .internal-link--button:hover {
      transform: none;
    }
  }

  /* Dark mode optimizations */
  @media (prefers-color-scheme: dark) {
    .internal-link--highlight {
      @apply from-accent/15 to-accent/8;

      &:hover {
        @apply from-accent/25 to-accent/15;
      }
    }
  }

  /* Print styles */
  @media print {
    .internal-link {
      @apply text-black underline;
    }

    .internal-link__arrow,
    .internal-link__icon {
      display: none;
    }
  }
</style>

<script>
  /**
   * Internal Link Analytics and Performance Tracking
   */

  // Track internal link clicks for comprehensive analytics
  document.addEventListener("click", async event => {
    const target = event.target as HTMLElement;
    const link = target.closest(".internal-link") as HTMLAnchorElement;

    if (link && link.dataset.linkType) {
      const linkText = link.textContent?.trim() || "";

      const clickEvent = {
        linkType: link.dataset.linkType as "internal",
        sourcePost: link.dataset.sourcePost || "unknown",
        targetPost: link.dataset.targetPost || "unknown",
        linkText,
        variant: link.dataset.variant || "inline",
        context: link.dataset.context || "moderate",
        timestamp: Date.now(),
        sessionId: link.dataset.sessionId,
      };

      // Dynamically import and use the analytics system
      try {
        const { trackLinkClick } = await import(
          "@/utils/internal-linking-analytics"
        );
        trackLinkClick(clickEvent);
      } catch (error) {
        // Silently fail - analytics are non-critical
      }
    }
  });

  // Preload linked pages on hover for better performance
  document.addEventListener("mouseover", event => {
    const target = event.target as HTMLElement;
    const link = target.closest(".internal-link") as HTMLAnchorElement;

    if (link && link.href && !link.dataset.preloaded) {
      // Mark as preloaded to avoid duplicate prefetching
      link.dataset.preloaded = "true";

      // Create preload link element
      const preloadLink = document.createElement("link");
      preloadLink.rel = "prefetch";
      preloadLink.href = link.href;
      document.head.appendChild(preloadLink);

      // Remove preload link after a delay to clean up
      setTimeout(() => {
        document.head.removeChild(preloadLink);
      }, 5000);
    }
  });
</script>
