---
/**
 * Button Component
 *
 * A clean, accessible button component that follows the project's design system.
 * Supports both button and link functionality with consistent styling and behavior.
 *
 * Features:
 * - Unified button/link interface
 * - Accessible by default with ARIA support
 * - Loading states with spinner
 * - Icon support with proper positioning
 * - Consistent with project's OKLCH color system
 * - Performance optimized with minimal DOM
 *
 * @component
 * @example
 * ```astro
 * <Button>Click me</Button>
 * <Button href="/about" variant="accent">Learn more</Button>
 * <Button type="submit" loading={isSubmitting}>Submit</Button>
 * ```
 */

import { Icon } from "astro-icon/components";
import type { HTMLAttributes } from "astro/types";
import LoadingSpinner from "./LoadingSpinner.astro";
import { 
  buttonBaseClasses, 
  focusStyles, 
  animationStyles, 
  shadowStyles,
  cn 
} from "@/utils/ui/designSystem";

type ButtonVariant =
  | "default" // Primary solid button
  | "accent" // Accent colored button
  | "outline" // Outlined button
  | "ghost" // Transparent with hover effect
  | "subtle" // Subtle background
  | "text" // Text only
  | "link" // Behaves like a link
  | "icon"; // Icon-focused button

  // Define all possible sizes
type ButtonSize = "xs" | "sm" | "md" | "lg" | "xl";

// Define all possible shapes
type ButtonShape = "default" | "rounded" | "pill" | "circle" | "square";

export interface Props extends HTMLAttributes<"button" | "a"> {
  /** Link destination URL (makes this a link instead of button) */
  href?: string;
  /** Visual style variant */
  variant?: ButtonVariant;
  /** Size variant */
  size?: ButtonSize;
  /** Shape variant */
  shape?: ButtonShape;
  /** Button/link text content */
  text?: string;
  /** Icon identifier from astro-icon */
  icon?: string;
  /** Icon position relative to text */
  iconPosition?: "start" | "end";
  /** HTML button type */
  type?: "button" | "submit" | "reset";
  /** Whether the button is disabled */
  disabled?: boolean;
  /** Whether to open link in new tab */
  newTab?: boolean;
  /** Whether to use full width */
  fullWidth?: boolean;
  /** Whether to show loading state */
  loading?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Accessible label */
  ariaLabel?: string;
}

const {
  href,
  variant = "default",
  size = "md",
  shape = "default",
  icon,
  iconPosition = "start",
  type = "button",
  disabled = false,
  newTab = false,
  fullWidth = false,
  loading = false,
  class: className = "",
  ariaLabel,
  "aria-label": ariaLabelAttr,
  ...rest
} = Astro.props;

// Use either ariaLabel prop or aria-label attribute
const finalAriaLabel = ariaLabel || ariaLabelAttr;

// Determine if this should be a link
const isLink = !!href && !disabled;

// Get content from slot
const content = await Astro.slots.render("default");

// Build classes using the project's design system
const baseClasses = [
  ...buttonBaseClasses,
  ...animationStyles.transitions.all,
  ...focusStyles.ring,
  ...animationStyles.hover.lift,
];

// Variant-specific styles using project's color system
const variantClasses = {
  default: [
    "bg-foreground",
    "text-background",
    "border",
    "border-transparent",
    "hover:bg-foreground/90",
    ...shadowStyles.elevation.low,
    ...shadowStyles.hoverTransitions.elevate,
  ],
  accent: [
    "bg-accent",
    "text-background",
    "border",
    "border-transparent",
    "hover:bg-accent/90",
    ...shadowStyles.elevation.low,
    ...shadowStyles.hoverTransitions.elevate,
  ],
  outline: [
    "bg-transparent",
    "text-accent",
    "border",
    "border-accent/30",
    "hover:border-accent",
    "hover:bg-accent/5",
  ],
  ghost: [
    "bg-transparent",
    "text-foreground",
    "border",
    "border-transparent",
    "hover:bg-card/50",
  ],
  subtle: [
    "bg-card",
    "text-foreground",
    "border",
    "border-transparent",
    "hover:bg-card-muted",
    ...shadowStyles.surface,
  ],
  text: [
    "bg-transparent",
    "text-accent",
    "border-0",
    "hover:text-accent/80",
    "hover:underline",
    "shadow-none",
    "hover:shadow-none",
  ],
  link: [
    "bg-transparent",
    "text-accent",
    "border-0",
    "hover:text-accent/80",
    "hover:underline",
    "shadow-none",
    "hover:shadow-none",
    "p-0",
    "min-h-auto",
  ],
  icon: [
    "bg-transparent",
    "text-foreground",
    "border",
    "border-transparent",
    "hover:bg-card/50",
    "p-2",
    "aspect-square",
  ],
};

// Size-specific styles
const sizeClasses = {
  xs: ["min-h-6", "px-2", "py-1", "text-xs", "rounded"],
  sm: ["min-h-8", "px-3", "py-1.5", "text-sm", "rounded-md"],
  md: ["min-h-10", "px-4", "py-2", "text-sm", "rounded-lg"],
  lg: ["min-h-12", "px-6", "py-3", "text-base", "rounded-lg"],
  xl: ["min-h-14", "px-8", "py-4", "text-lg", "rounded-xl"],
};

// Shape-specific styles
const shapeClasses = {
  default: [],
  rounded: ["rounded-lg"],
  pill: ["rounded-full"],
  circle: ["rounded-full", "aspect-square", "p-0"],
  square: ["rounded-none", "aspect-square"],
};

// Conditional classes
const conditionalClasses = [
  fullWidth && "w-full",
  loading && animationStyles.states.loading,
  disabled && animationStyles.states.disabled,
  !disabled && !loading && "cursor-pointer",
].flat().filter(Boolean) as string[];

// Combine all classes using design system utility
const buttonClasses = cn(
  baseClasses,
  variantClasses[variant],
  sizeClasses[size],
  shapeClasses[shape],
  conditionalClasses,
  animationStyles.motionSafe,
  className
);
---

{
  isLink ? (
    <a
      href={href}
      class={cn(
        buttonClasses,
        focusStyles.oklchOutline,
        variant === 'link' && 'inline p-0 min-h-0 hover:translate-y-0',
        disabled && 'pointer-events-none'
      )}
      aria-label={finalAriaLabel}
      target={newTab ? "_blank" : undefined}
      rel={newTab ? "noopener noreferrer" : undefined}
      aria-disabled={disabled ? "true" : undefined}
      {...rest}
    >
      <span class="flex items-center justify-center gap-2">
{loading && <LoadingSpinner size="sm" />}
        {icon && iconPosition === "start" && !loading && (
          <Icon name={icon} class="size-4 flex-shrink-0" aria-hidden="true" />
        )}
        {content && <span>{content}</span>}
        {icon && iconPosition === "end" && !loading && (
          <Icon name={icon} class="size-4 flex-shrink-0" aria-hidden="true" />
        )}
      </span>
    </a>
  ) : (
    <button
      type={type}
      class={cn(
        buttonClasses,
        focusStyles.oklchOutline,
        variant === 'icon' && 'aspect-square justify-center p-2',
        variant === 'link' && 'inline p-0 min-h-0 hover:translate-y-0',
        'disabled:pointer-events-none'
      )}
      disabled={disabled || loading}
      aria-label={finalAriaLabel}
      aria-disabled={disabled || loading}
      {...rest}
    >
      <span class="flex items-center justify-center gap-2">
{loading && <LoadingSpinner size="sm" />}
        {icon && iconPosition === "start" && !loading && (
          <Icon name={icon} class="size-4 flex-shrink-0" aria-hidden="true" />
        )}
        {content && <span>{content}</span>}
        {icon && iconPosition === "end" && !loading && (
          <Icon name={icon} class="size-4 flex-shrink-0" aria-hidden="true" />
        )}
      </span>
    </button>
  )
}
