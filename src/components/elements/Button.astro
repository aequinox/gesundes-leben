---
/**
 * Button Component (Refactored)
 *
 * A clean, accessible button component following Single Responsibility Principle.
 * Orchestrates smaller, focused components for specific responsibilities.
 *
 * Single Responsibility: Component composition and prop management
 *
 * @component
 * @example
 * ```astro
 * <Button>Click me</Button>
 * <Button href="/about" variant="accent">Learn more</Button>
 * <Button type="submit" loading={isSubmitting}>Submit</Button>
 * ```
 */

import type { HTMLAttributes } from "astro/types";
import BaseButton from "./button/BaseButton.astro";
import BaseLink from "./button/BaseLink.astro";
import { buildButtonClasses } from "./button/ButtonClassBuilder";
import ButtonIcon from "./button/ButtonIcon.astro";
import {
  type ButtonShape,
  type ButtonSize,
  type ButtonVariant,
} from "./button/ButtonVariants";

export interface Props extends HTMLAttributes<"button" | "a"> {
  /** Link destination URL (makes this a link instead of button) */
  href?: string;
  /** Visual style variant */
  variant?: ButtonVariant;
  /** Size variant */
  size?: ButtonSize;
  /** Shape variant */
  shape?: ButtonShape;
  /** Button/link text content */
  text?: string;
  /** Icon identifier from astro-icon */
  icon?: string;
  /** Icon position relative to text */
  iconPosition?: "start" | "end";
  /** HTML button type */
  type?: "button" | "submit" | "reset";
  /** Whether the button is disabled */
  disabled?: boolean;
  /** Whether to open link in new tab */
  newTab?: boolean;
  /** Whether to use full width */
  fullWidth?: boolean;
  /** Whether to show loading state */
  loading?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Accessible label */
  ariaLabel?: string;
}

const {
  href,
  variant = "default",
  size = "md",
  shape = "default",
  text,
  icon,
  iconPosition = "start",
  type = "button",
  disabled = false,
  newTab = false,
  fullWidth = false,
  loading = false,
  class: className = "",
  ariaLabel,
  ...rest
} = Astro.props;

// Determine if this should be a link
const isLink = !!href && !disabled;

// Get content from slot
const slotContent = await Astro.slots.render("default");
const hasSlotContent = !!slotContent.trim();
const hasTextContent = !!(text || hasSlotContent);

// Build CSS classes
const buttonClasses = buildButtonClasses({
  variant,
  size,
  shape,
  disabled,
  loading,
  fullWidth,
  className,
});

// Common props for both button and link
const commonProps = {
  class: buttonClasses,
  ariaLabel,
  ...rest,
};
---

{
  isLink ? (
    <BaseLink href={href} newTab={newTab} disabled={disabled} {...commonProps}>
      {icon && iconPosition === "start" && (
        <ButtonIcon icon={icon} position="start" hasText={hasTextContent} />
      )}

      {text && <span>{text}</span>}
      {hasSlotContent && <slot />}

      {icon && iconPosition === "end" && (
        <ButtonIcon icon={icon} position="end" hasText={hasTextContent} />
      )}

      {icon && !hasTextContent && (
        <ButtonIcon icon={icon} position="only" hasText={false} />
      )}
    </BaseLink>
  ) : (
    <BaseButton
      type={type}
      disabled={disabled}
      loading={loading}
      {...commonProps}
    >
      {icon && iconPosition === "start" && (
        <ButtonIcon icon={icon} position="start" hasText={hasTextContent} />
      )}

      {text && <span>{text}</span>}
      {hasSlotContent && <slot />}

      {icon && iconPosition === "end" && (
        <ButtonIcon icon={icon} position="end" hasText={hasTextContent} />
      )}

      {icon && !hasTextContent && (
        <ButtonIcon icon={icon} position="only" hasText={false} />
      )}
    </BaseButton>
  )
}
