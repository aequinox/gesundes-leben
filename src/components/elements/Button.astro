---
import { Icon } from "astro-icon/components";
import type { CallToActionVariant } from "../../types/components";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"a"> {
  /** Visual style variant of the button */
  variant?: CallToActionVariant;
  /** Button/link text content */
  text?: string;
  /** Icon identifier from astro-icon */
  icon?: string;
  /** Additional CSS classes */
  class?: string;
  /** HTML button type */
  type?: "button" | "submit" | "reset";
  /** Size of the button */
  size?: "sm" | "md" | "lg";
  /** Whether to use full width */
  fullWidth?: boolean;
  /** Whether to show loading state */
  loading?: boolean;
}

const {
  variant = "default",
  text,
  icon,
  class: className = "",
  type,
  target,
  size = "md",
  fullWidth = false,
  loading = false,
  ...rest
}: Props = Astro.props;

const content = text || (await Astro.slots.render("default"));

const variants: Record<CallToActionVariant, string> = {
  default: "btn-default",
  accented: "btn-accented",
  muted: "btn-muted",
  link: "btn-link",
};

const sizes = {
  sm: "btn-sm",
  md: "btn-md",
  lg: "btn-lg",
};
---

{
  type === "button" || type === "submit" || type === "reset" ? (
    <button
      type={type}
      class:list={[
        "btn",
        variants[variant],
        sizes[size],
        fullWidth && "btn-full",
        loading && "btn-loading",
        className,
      ]}
      disabled={loading}
      {...rest}
    >
      <span class="btn-content">
        {loading && (
          <svg
            class="btn-spinner"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
              fill="none"
            />
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
        )}
        {icon && !loading && <Icon name={icon} class="btn-icon" />}
        <span class="btn-text">
          <Fragment
            class="not-prose m-0 inline p-0 leading-none"
            set:html={content}
          />
        </span>
      </span>
    </button>
  ) : (
    <a
      class:list={[
        "btn",
        variants[variant],
        sizes[size],
        fullWidth && "btn-full",
        className,
      ]}
      {...(target ? { target, rel: "noopener noreferrer" } : {})}
      {...rest}
    >
      <span class="btn-content">
        {icon && <Icon name={icon} class="btn-icon" />}
        <span class="btn-text">
          <Fragment set:html={content} />
        </span>
      </span>
    </a>
  )
}

<style>
  .btn {
    @apply relative inline-flex items-center justify-center overflow-hidden rounded-xl border border-transparent text-center font-medium transition-all duration-300 ease-out-expo focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-skin-accent focus-visible:ring-offset-2;
    transform: translateZ(0);

    &::before {
      content: "";
      @apply absolute inset-0 z-0 opacity-0 transition-opacity duration-300;
      background: radial-gradient(
        800px circle at var(--mouse-x, 0) var(--mouse-y, 0),
        rgba(255, 255, 255, 0.06),
        transparent 40%
      );
    }
    &:hover::before {
      @apply opacity-100;
    }
  }

  .btn-content {
    @apply relative z-10 flex items-center justify-center gap-2;
  }

  .btn-icon {
    @apply size-5 flex-shrink-0 text-skin-base;
  }

  .btn-text p {
    @apply m-0 inline p-0 leading-none !important;
    prose-p: leading-none;
  }

  /* Size variants */
  .btn-sm {
    @apply min-h-8 px-3 py-1.5 text-xs;
  }

  .btn-md {
    @apply min-h-10 px-4 py-2 text-sm;
  }

  .btn-lg {
    @apply min-h-12 px-6 py-3 text-base;
  }

  /* Full width */
  .btn-full {
    @apply w-full;
  }

  /* Loading state */
  .btn-loading {
    @apply cursor-not-allowed;
  }

  .btn-spinner {
    @apply size-5 animate-spin;
  }

  /* Style variants */
  .btn-default {
    @apply bg-skin-base text-skin-inverted shadow-lg;
    box-shadow:
      0 2px 4px 0 rgba(0, 0, 0, 0.05),
      0 1px 2px 0 rgba(0, 0, 0, 0.1),
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.15);

    &:hover {
      @apply bg-skin-base/90;
      transform: translateY(-1px);
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 1px 0 rgba(255, 255, 255, 0.2);
    }

    &:active {
      @apply bg-skin-inverted;
      transform: translateY(0);
      box-shadow:
        0 1px 2px 0 rgba(0, 0, 0, 0.05),
        inset 0 1px 1px 0 rgba(0, 0, 0, 0.1);
    }
  }

  .btn-accented {
    @apply bg-skin-accent text-skin-base shadow-lg;
    box-shadow:
      0 2px 4px 0 rgba(0, 0, 0, 0.05),
      0 1px 2px 0 rgba(0, 0, 0, 0.1),
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.15);

    &:hover {
      @apply bg-skin-accent/90;
      transform: translateY(-1px);
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        inset 0 1px 1px 0 rgba(255, 255, 255, 0.2);
    }

    &:active {
      @apply bg-skin-accent;
      transform: translateY(0);
      box-shadow:
        0 1px 2px 0 rgba(0, 0, 0, 0.05),
        inset 0 1px 1px 0 rgba(0, 0, 0, 0.1);
    }
  }

  .btn-muted {
    @apply bg-skin-card text-skin-base shadow-md;
    box-shadow:
      0 2px 4px 0 rgba(0, 0, 0, 0.03),
      0 1px 2px 0 rgba(0, 0, 0, 0.05),
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.1);

    &:hover {
      @apply bg-skin-card-muted;
      transform: translateY(-1px);
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.05),
        0 2px 4px -1px rgba(0, 0, 0, 0.03),
        inset 0 1px 1px 0 rgba(255, 255, 255, 0.15);
    }

    &:active {
      @apply bg-skin-card;
      transform: translateY(0);
      box-shadow:
        0 1px 2px 0 rgba(0, 0, 0, 0.03),
        inset 0 1px 1px 0 rgba(0, 0, 0, 0.05);
    }
  }

  .btn-link {
    @apply bg-transparent p-0 text-skin-base shadow-none hover:text-skin-accent;
  }

  /* Dark mode adjustments */
  :global(html[data-theme="dark"]) .btn-default,
  :global(html[data-theme="dark"]) .btn-accented,
  :global(html[data-theme="dark"]) .btn-muted {
    box-shadow:
      0 2px 4px 0 rgba(0, 0, 0, 0.2),
      0 1px 2px 0 rgba(0, 0, 0, 0.15),
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.05);
  }

  :global(html[data-theme="dark"]) .btn-default:hover,
  :global(html[data-theme="dark"]) .btn-accented:hover,
  :global(html[data-theme="dark"]) .btn-muted:hover {
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.25),
      0 2px 4px -1px rgba(0, 0, 0, 0.15),
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.1);
  }
</style>

<script>
  // Add interactive light effect on hover
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".btn");

    buttons.forEach(button => {
      button.addEventListener("mousemove", function (e) {
        if (e instanceof MouseEvent && button instanceof HTMLElement) {
          const rect = button.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          button.style.setProperty("--mouse-x", `${x}px`);
          button.style.setProperty("--mouse-y", `${y}px`);
        }
      });
    });
  });
</script>
