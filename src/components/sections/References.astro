---
/**
 * References Component
 *
 * A component for displaying academic references and citations
 * with proper formatting and accessibility features.
 *
 * @component
 * @example
 * ```astro
 * <References
 *   references={["ref1", "ref2"]}
 *   class="my-8"
 * />
 * ```
 */

import { ReferenceUtils } from "../../utils/content";
import type { Reference } from "../../utils/content/types";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

interface Props {
  /** Array of reference IDs to display */
  references?: string[];
  /** Optional CSS class name */
  class?: string;
}

const { references = [], class: className = "" }: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Load and process references
let sortedReferences: Reference[] = [];
try {
  // Get all references and filter if needed
  const allReferences = await ReferenceUtils.getAllReferences();
  const filteredReferences =
    references.length > 0
      ? allReferences.filter(ref => references.includes(ref.id))
      : allReferences;

  // Sort references by first author's last name
  sortedReferences = [...filteredReferences].sort((a, b) => {
    const getLastName = (author: string): string => {
      const parts = author.split(",")[0].trim().split(" ");
      return parts[parts.length - 1];
    };

    const authorA = Array.isArray(a.data.authors) ? a.data.authors[0] : "";
    const authorB = Array.isArray(b.data.authors) ? b.data.authors[0] : "";

    return getLastName(authorA).localeCompare(getLastName(authorB));
  });
} catch (error) {
  console.error("Error loading references:", error);
}

/**
 * Formats a list of authors with proper punctuation
 * @param authors - Array of author names
 * @returns Formatted author string
 */
const formatAuthors = (authors: ReadonlyArray<string>): string => {
  if (!Array.isArray(authors)) return "";

  return authors
    .map((author, index) => {
      if (index === authors.length - 1) return author;
      if (index === authors.length - 2) return `${author} & `;
      return `${author}, `;
    })
    .join("");
};

/**
 * Formats citation details with proper punctuation
 * @param ref - Reference data
 * @returns Formatted citation string
 */
const formatCitation = (ref: Reference): string => {
  const { data } = ref;
  const parts = [
    data.journal && `${data.journal}`,
    data.volume && `${data.volume}`,
    data.issue && `(${data.issue})`,
    data.pages && `, ${data.pages}`,
  ].filter(Boolean);

  return parts.join(" ");
};

// Memoize common class names
const containerClasses = [
  "references",
  "my-8 rounded-lg",
  "bg-gray-50 dark:bg-gray-800",
  "p-6",
  className,
]
  .filter(Boolean)
  .join(" ");

// Generate unique ID for accessibility
const sectionId = `references-${Math.random().toString(36).substring(2, 9)}`;
---

<section
  id={sectionId}
  class={containerClasses}
  aria-labelledby={`${sectionId}-title`}
>
  <h2 id={`${sectionId}-title`} class="mb-6 text-2xl font-bold text-skin-base">
    {t("references.title")}
  </h2>

  <ul class="space-y-4" role="list">
    {
      sortedReferences.map(ref => (
        <li class="reference-item text-sm leading-relaxed" role="listitem">
          <div class="citation-content">
            {/* Authors */}
            <span class="font-semibold">{formatAuthors(ref.data.authors)}</span>

            {/* Year */}
            <span class="ml-1">({ref.data.year})</span>

            {/* Title */}
            <span class="ml-1">
              {ref.data.url ? (
                <a
                  href={ref.data.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-skin-accent"
                  aria-label={t("references.viewSource").replace(
                    "{title}",
                    ref.data.title
                  )}
                >
                  {ref.data.title}
                </a>
              ) : (
                ref.data.title
              )}
            </span>

            {/* Journal info */}
            {ref.data.journal && (
              <span class="ml-1 italic">{formatCitation(ref)}</span>
            )}

            {/* DOI link if available */}
            {ref.data.doi && (
              <span class="ml-2">
                <a
                  href={`https://doi.org/${ref.data.doi}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-xs text-primary hover:underline"
                  aria-label={`DOI: ${ref.data.doi}`}
                >
                  [DOI]
                </a>
              </span>
            )}
          </div>
        </li>
      ))
    }
  </ul>

  {
    sortedReferences.length === 0 && (
      <p class="text-skin-base/80" role="status">
        {t("references.noReferences")}
      </p>
    )
  }
</section>

<style>
  /* Base styles */
  .references {
    @apply transition-colors duration-300;
  }

  /* Focus styles */
  .references:focus-within {
    @apply ring-2 ring-skin-accent ring-offset-2;
  }

  /* Citation styles */
  .citation-content {
    @apply relative pl-8;
  }

  .citation-content::before {
    content: "[" counter(reference-counter) "]";
    @apply absolute left-0 font-medium text-skin-accent;
    counter-increment: reference-counter;
  }

  /* Link styles */
  a:focus-visible {
    @apply outline-none ring-2 ring-skin-accent ring-offset-2;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .references {
      @apply transition-none;
    }
  }

  /* Print styles */
  @media print {
    .references {
      @apply break-inside-avoid bg-transparent shadow-none;
    }

    a {
      @apply text-current no-underline;
    }

    a[href^="http"]::after {
      content: " (" attr(href) ")";
      @apply text-sm;
    }
  }

  /* High contrast mode */
  @media (forced-colors: active) {
    .references {
      @apply border border-[CanvasText];
    }
  }

  /* Dark mode adjustments */
  :global(.dark) .references {
    @apply bg-gray-800/50;
  }

  /* Counter styles */
  .references {
    counter-reset: reference-counter;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .citation-content {
      @apply pl-6 text-xs;
    }
  }
</style>
