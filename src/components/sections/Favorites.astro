---
import { getCollection, type CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import Button from "@/components/elements/Button.astro";

interface Props {
  data?: Record<string, string[]>;
  id?: string;
}

interface CategoryConfig {
  icon: string;
  color: string;
  gradient: string;
}

const { data, id }: Props = Astro.props;

const favorites: CollectionEntry<"favorites">[] = await getCollection(
  "favorites",
  ({ id: favoriteId }: CollectionEntry<"favorites">) =>
    data && id ? data[id]?.includes(favoriteId) : false
);

const categoryConfigs: Record<string, CategoryConfig> = {
  Basis: {
    icon: "tabler:shield",
    color: "text-emerald-500",
    gradient: "from-emerald-500/10 to-emerald-500/5",
  },
  Premium: {
    icon: "tabler:shield-check",
    color: "text-violet-500",
    gradient: "from-violet-500/10 to-violet-500/5",
  },
  Profi: {
    icon: "tabler:shield-star",
    color: "text-amber-500",
    gradient: "from-amber-500/10 to-amber-500/5",
  },
};

const favoritesCount = favorites.length;

// Calculate grid classes based on number of favorites
const gridClasses =
  {
    1: "grid-cols-1 max-w-md mx-auto",
    2: "grid-cols-1 md:grid-cols-2 max-w-4xl mx-auto gap-8",
    3: "grid-cols-1 md:grid-cols-2 lg:grid-cols-3 max-w-content mx-auto gap-8",
  }[favoritesCount] || "grid-cols-1 md:grid-cols-3 max-w-content mx-auto gap-8";
---

<section data-aos="fade-up" class="mx-auto max-w-content py-12">
  <div class="favorites-container">
    <input
      type="checkbox"
      name="favorites"
      id={`favorites-${id}`}
      class="hidden"
    />
    <div class="favorites-wrapper">
      <label for={`favorites-${id}`} class="favorites-header group">
        <span class="text-xl font-medium text-skin-base">
          {
            favoritesCount > 1
              ? `Unsere Favoriten zum Thema ${id}`
              : `Unser Favorit zum Thema ${id}`
          }
        </span>
        <Icon
          name="tabler:chevron-down"
          class="h-6 w-6 transform transition-transform duration-300 group-hover:text-skin-accent"
        />
      </label>

      <div class="favorites-content">
        <p
          class="mx-auto mb-12 max-w-content text-left text-lg text-skin-base/80"
        >
          Wir werben für Partner und Produkte, von denen wir überzeugt sind und
          mit denen wir in der Praxis ausgezeichnete Erfahrungen gemacht haben.
          Das bedeutet, diese entsprechen hohen Standards bezüglich Qualität,
          Preis-Leistungs-Verhältnis, therapeutisch wirksamer Dosierung,
          Reinheit und Nachhaltigkeit. Die Einnahmen, die wir durch manche der
          Empfehlungen erzielen, kommen dem Blog zugute. <b
            class="text-skin-accent">#weildueswertbist</b
          >
        </p>

        <div class={`grid ${gridClasses}`}>
          {
            favorites.map(({ data: { category, name, descriptions, url } }) => {
              const config = categoryConfigs[category || "Basis"];
              return (
                <div class="favorite-card group h-full">
                  <div
                    class={`flex h-full flex-col rounded-2xl bg-gradient-to-b ${config.gradient} p-8 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg`}
                  >
                    <div class="mb-6 flex items-start justify-between">
                      <h3 class="text-xl font-medium text-skin-base">{name}</h3>
                      {category && (
                        <Icon
                          name={config.icon}
                          aria-hidden="true"
                          class={`h-7 w-7 ${config.color} ml-4 shrink-0`}
                        />
                      )}
                    </div>

                    <ul class="mb-8 flex-grow space-y-4">
                      {descriptions.map((description: string) => (
                        <li class="flex items-start">
                          <Icon
                            name="tabler:circle-check"
                            aria-hidden="true"
                            class={`mt-1 h-5 w-5 shrink-0 ${config.color} absolute -ml-7`}
                          />
                          <span class="text-skin-base/80">{description}</span>
                        </li>
                      ))}
                    </ul>

                    <Button
                      type="button"
                      variant="default"
                      icon="tabler:external-link"
                      href={url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="mt-auto w-full justify-center"
                      text={`Zum ${category ? category.toUpperCase() : ""} Produkt`}
                    />
                  </div>
                </div>
              );
            })
          }
        </div>
        <slot />
      </div>
    </div>
  </div>
</section>

<style>
  .favorites-container {
    @apply relative overflow-hidden rounded-2xl bg-skin-card/30 backdrop-blur-sm;
  }

  .favorites-wrapper {
    @apply relative border-l-4 border-skin-accent;
  }

  .favorites-header {
    @apply flex cursor-pointer items-center justify-between bg-skin-card/50 px-6 py-4 transition-colors duration-300 hover:bg-skin-card/70;
  }

  .favorites-content {
    @apply max-h-0 overflow-hidden px-6 transition-all duration-500 ease-in-out;
  }

  input:checked ~ .favorites-wrapper .favorites-content {
    @apply max-h-full py-8;
  }

  input:checked ~ .favorites-wrapper .favorites-header svg {
    @apply rotate-180;
  }

  .favorite-card {
    @apply relative isolate;
  }

  .favorite-card::after {
    content: "";
    @apply absolute inset-0 -z-10 rounded-2xl bg-gradient-to-b from-skin-accent/10 to-transparent opacity-0 transition-opacity duration-300;
  }

  .favorite-card:hover::after {
    @apply opacity-100;
  }

  /* Position the list items with proper alignment */
  .favorite-card ul {
    @apply pl-7;
  }
</style>
