---
/**
 * Minimalistic Favorites Component
 *
 * A clean, space-efficient component for displaying affiliated product suggestions.
 * Focuses on essential information with minimal visual clutter.
 * Hidden by default in an accordion for optional viewing.
 */
import Badge from "@/components/elements/Badge.astro";
import Button from "@/components/elements/Button.astro";
import Accordion from "@/components/sections/Accordion.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { logger } from "@/utils/logger";
import { Icon } from "astro-icon/components";
import { getCollection, type CollectionEntry } from "astro:content";

interface Props {
  data?: Record<string, string[]>;
  id?: string;
  animationType?: string;
  animationDelay?: number;
  variant?: "default" | "bordered" | "separated" | "minimal";
  size?: "sm" | "md" | "lg";
}

interface CategoryConfig {
  icon: string;
  badge: "success" | "primary" | "warning";
  label: string;
}

type CategoryId = "Basis" | "Plus" | "Premium" | "Profi";

const {
  data,
  id = "",
  animationType = "fade-up",
  animationDelay = 100,
  variant = "minimal",
  size = "md",
}: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const categoryConfigs: Record<CategoryId, CategoryConfig> = {
  Basis: {
    icon: "tabler:shield",
    badge: "success",
    label: "Basic Product",
  },
  Plus: {
    icon: "tabler:shield",
    badge: "success",
    label: "Basic Product",
  },
  Premium: {
    icon: "tabler:shield-check",
    badge: "primary",
    label: "Premium Product",
  },
  Profi: {
    icon: "tabler:shield-star",
    badge: "warning",
    label: "Professional Product",
  },
};

let favorites: CollectionEntry<"favorites">[] = [];
try {
  if (data && id) {
    const allFavorites = await getCollection("favorites");
    favorites = allFavorites.filter(({ id: favoriteId }) =>
      data[id]?.includes(favoriteId)
    );
  }
} catch (error) {
  logger.error(`Error loading favorites: ${error}`);
}

const title =
  favorites.length > 1
    ? t("favorites.multipleTitle").replace("{topic}", id)
    : t("favorites.singleTitle").replace("{topic}", id);

const accordionItems = [
  {
    title: `${title} (${favorites.length})`,
    icon: "tabler:star",
    open: false,
    slotId: 0,
  },
];

// Dynamic grid configuration based on favorites count
const getGridClasses = (count: number): string => {
  switch (count) {
    case 1:
      return "grid grid-cols-1 justify-items-center gap-4 max-w-md mx-auto";
    case 2:
      return "grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto";
    case 3:
      return "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto";
    default:
      return "grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 items-stretch";
  }
};

const getCardClasses = (count: number): string => {
  // For 1-3 items, ensure consistent max-width; for 4+ items, allow full flexibility
  return count <= 3
    ? "flex h-full flex-col rounded-md border border-line bg-card p-4 transition-all duration-200 hover:border-accent/30 max-w-md w-full"
    : "flex h-full flex-col rounded-md border border-line bg-card p-4 transition-all duration-200 hover:border-accent/30";
};

const gridClasses = getGridClasses(favorites.length);
const cardClasses = getCardClasses(favorites.length);
---

<section data-aos={animationType} data-aos-delay={animationDelay} class="py-4">
  <Accordion items={accordionItems} variant={variant} size={size} class="mx-0">
    <div slot="content-0">
      <div class="mb-4 text-center">
        <p class="mx-auto max-w-2xl text-foreground/70">
          {t("favorites.description")}
          <span class="font-medium text-accent">#weildueswertbist</span>
        </p>
      </div>

      <div class={gridClasses}>
        {
          favorites.map(
            ({ data: { category, name, descriptions, url } }, index) => {
              const config =
                categoryConfigs[(category || "Basis") as CategoryId];
              const buttonText = t("favorites.viewProduct").replace(
                "{category}",
                category || "Basis"
              );

              return (
                <article
                  class={cardClasses}
                  data-aos="fade-up"
                  data-aos-delay={100 + index * 50}
                >
                  {category && (
                    <Badge
                      text={category}
                      variant={config.badge}
                      size="sm"
                      shape="rounded"
                      icon={config.icon}
                      class="ml-2 flex-shrink-0"
                    />
                  )}
                  <header class="mb-3 flex items-center justify-between">
                    <div class="mt-4 flex-1 pr-2 text-center leading-tight font-medium">
                      {name}
                    </div>
                  </header>
                  <div class="mb-4 flex-1">
                    <div class="m-0 space-y-2 p-0" role="list">
                      {descriptions.map((description: string) => (
                        <div class="not-prose flex items-start gap-2">
                          <Icon
                            name="tabler:circle-check"
                            aria-hidden="true"
                            class="size-4 flex-shrink-0 text-accent"
                          />
                          <span class="text-sm leading-relaxed text-foreground/85">
                            {description}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div class="mt-auto">
                    <Button
                      variant="outline"
                      size="sm"
                      icon="tabler:external-link"
                      iconPosition="end"
                      href={url}
                      newTab={true}
                      class="w-full"
                      ariaLabel={`View ${name} product details`}
                    >
                      {buttonText}
                    </Button>
                  </div>
                </article>
              );
            }
          )
        }
      </div>

      {
        favorites.length === 0 && (
          <div class="py-8 text-center">
            <Icon
              name="tabler:star-off"
              class="mx-auto mb-3 h-12 w-12 text-foreground/30"
            />
            <p class="text-foreground/60">
              No affiliated products available at the moment.
            </p>
          </div>
        )
      }

      <slot />
    </div>
  </Accordion>
</section>
