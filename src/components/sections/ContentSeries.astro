---
/**
 * ContentSeries Component
 *
 * Creates navigation for multi-part article series and sequential content.
 * Provides clear progression through related content with next/previous navigation.
 *
 * @component
 * @example
 * ```astro
 * <ContentSeries
 *   currentPost={post}
 *   seriesId="antivirale-strategien"
 *   showProgress={true}
 * />
 * ```
 */

import { getCollection } from "astro:content";
import { getSortedPosts } from "@/utils/posts";
import InternalLink from "@/components/elements/InternalLink.astro";
import type { Post } from "@/utils/types";

export interface Props {
  /** Current post in the series */
  currentPost: Post;
  /** Series identifier (can be from post metadata or manual) */
  seriesId?: string;
  /** Whether to show reading progress */
  showProgress?: boolean;
  /** Whether to show series overview */
  showOverview?: boolean;
  /** Custom series title */
  seriesTitle?: string;
}

const {
  currentPost,
  seriesId,
  showProgress = true,
  showOverview = true,
  seriesTitle
} = Astro.props;

// Fetch all posts
const allPosts = await getCollection("blog");
const sortedPosts = getSortedPosts(allPosts);

// Define known content series based on content analysis
const CONTENT_SERIES = {
  'antivirale-strategien': {
    title: 'Antivirale Strategien',
    description: 'Umfassende Serie √ºber nat√ºrliche und medizinische antivirale Ans√§tze',
    posts: [
      '2022-09-16-antivirale-strategien-teil-1',
      '2022-09-23-antivirale-strategien-teil-2'
    ]
  },
  'mikronaehrstoffraeuber': {
    title: 'Mikron√§hrstoffr√§uber',
    description: 'Serie √ºber Faktoren, die wichtige N√§hrstoffe im K√∂rper reduzieren',
    posts: [
      '2022-03-11-mikronaehrstoffraeuber-die-pille',
      '2022-07-02-mikronaehrstoffraeuber-medikamente',
      '2023-01-30-vitaminraeuber-antibiotika'
    ]
  },
  'lesenswert': {
    title: 'Lesenswert - Buchempfehlungen',
    description: 'Kuratierte Sammlung wertvoller Gesundheitsb√ºcher',
    posts: [
      '2022-04-02-lesenswert-cancer-and-the-new-biology-of-water',
      '2022-05-14-lesenswert-warum-es-so-schwierig-ist-sich-zu-aendern',
      '2022-08-02-lesenswert-wir-fressen-uns-zu-tode',
      '2022-11-16-lesenswert-eselsweisheit-augentraining',
      '2023-09-25-lesenswert-systemischer-ratgeber',
      '2023-11-17-lesenswert-einfach-lieben',
      '2024-01-16-lesenswert-der-kleine-eheretter',
      '2024-04-19-lesenswert-die-1-methode-minimale-veraenderung-maximale-wirkung',
      '2024-08-30-lesenswert-wuerde',
      '2025-01-24-lesenswert-das-bleibt-in-der-familie'
    ]
  },
  'top-listen': {
    title: 'Top-Listen f√ºr Gesundheit',
    description: 'Praktische Listen mit den besten Gesundheitstipps',
    posts: [
      '2023-08-01-top-5-darm-und-immunsystemstaerkung',
      '2023-08-14-top-lebensmittel-fuers-immunsystems',
      '2024-05-05-top-5-untersuchungen-und-laborwerte-fuer-deinen-gesundheits-tuev',
      '2025-05-06-top-entzuendungshemmende-lebensmittel'
    ]
  }
} as const;

// Auto-detect series if not provided
let detectedSeries: keyof typeof CONTENT_SERIES | null = null;
let seriesInfo: typeof CONTENT_SERIES[keyof typeof CONTENT_SERIES] | null = null;

if (seriesId && CONTENT_SERIES[seriesId as keyof typeof CONTENT_SERIES]) {
  detectedSeries = seriesId as keyof typeof CONTENT_SERIES;
  seriesInfo = CONTENT_SERIES[detectedSeries];
} else {
  // Auto-detect based on post slug patterns
  const currentSlug = currentPost.slug;
  
  for (const [id, series] of Object.entries(CONTENT_SERIES)) {
    if (series.posts.some(postSlug => currentSlug.includes(postSlug.split('-').slice(-2).join('-')) || 
                                     series.posts.includes(currentSlug))) {
      detectedSeries = id as keyof typeof CONTENT_SERIES;
      seriesInfo = series;
      break;
    }
  }
}

// Don't render if no series detected
if (!detectedSeries || !seriesInfo) {
  return null;
}

// Get series posts in order
const seriesPosts = seriesInfo.posts
  .map(slug => sortedPosts.find(post => post.slug === slug || post.slug.includes(slug)))
  .filter(Boolean) as Post[];

if (seriesPosts.length <= 1) {
  return null;
}

// Find current post position
const currentIndex = seriesPosts.findIndex(post => post.id === currentPost.id);
const previousPost = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null;
const nextPost = currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null;

// Calculate progress
const progressData = {
  current: currentIndex + 1,
  total: seriesPosts.length,
  percentage: Math.round(((currentIndex + 1) / seriesPosts.length) * 100)
};

const finalSeriesTitle = seriesTitle || seriesInfo.title;
---

<nav 
  class="content-series" 
  aria-labelledby="content-series-heading"
  data-series={detectedSeries}
>
  {/* Series Header */}
  <header class="content-series__header">
    <div class="series-info">
      <h2 id="content-series-heading" class="series-title">
        <span class="series-icon">üìö</span>
        {finalSeriesTitle}
      </h2>
      
      {showProgress && (
        <div class="series-progress">
          <div class="progress-visual">
            <div class="progress-track">
              <div 
                class="progress-fill" 
                style={`width: ${progressData.percentage}%`}
                aria-hidden="true"
              ></div>
            </div>
            <span class="progress-text">
              Teil {progressData.current} von {progressData.total}
            </span>
          </div>
        </div>
      )}
      
      {showOverview && (
        <p class="series-description">
          {seriesInfo.description}
        </p>
      )}
    </div>
  </header>

  {/* Navigation Controls */}
  <section class="content-series__navigation">
    <div class="nav-controls">
      {/* Previous Post */}
      <div class="nav-item nav-item--previous">
        {previousPost ? (
          <InternalLink
            to={`/posts/${previousPost.slug}`}
            anchor="‚Üê Vorheriger Artikel"
            variant="button"
            context="moderate"
            placement="navigation"
            title={`Vorheriger Artikel: ${previousPost.data.title}`}
          />
          <div class="nav-item__details">
            <span class="nav-label">Vorher:</span>
            <span class="nav-title">{previousPost.data.title}</span>
          </div>
        ) : (
          <div class="nav-item--disabled">
            <span class="nav-disabled">‚Üê Erster Artikel</span>
          </div>
        )}
      </div>

      {/* Series Overview */}
      <div class="nav-item nav-item--overview">
        <div class="series-position">
          <span class="position-indicator">
            {progressData.current} / {progressData.total}
          </span>
          <span class="series-name">{finalSeriesTitle}</span>
        </div>
      </div>

      {/* Next Post */}
      <div class="nav-item nav-item--next">
        {nextPost ? (
          <InternalLink
            to={`/posts/${nextPost.slug}`}
            anchor="N√§chster Artikel ‚Üí"
            variant="button"
            context="moderate"
            placement="navigation"
            title={`N√§chster Artikel: ${nextPost.data.title}`}
          />
          <div class="nav-item__details">
            <span class="nav-label">Als n√§chstes:</span>
            <span class="nav-title">{nextPost.data.title}</span>
          </div>
        ) : (
          <div class="nav-item--disabled">
            <span class="nav-disabled">Letzter Artikel ‚Üí</span>
          </div>
        )}
      </div>
    </div>
  </section>

  {/* Complete Series Overview */}
  {showOverview && (
    <section class="content-series__overview">
      <h3 class="overview-title">Alle Artikel dieser Serie</h3>
      
      <ol class="series-list">
        {seriesPosts.map((post, index) => (
          <li class={`series-item ${post.id === currentPost.id ? 'series-item--current' : ''}`}>
            {post.id === currentPost.id ? (
              <div class="series-item__current">
                <span class="current-indicator">üìç</span>
                <span class="current-title">{post.data.title}</span>
                <span class="current-label">Sie sind hier</span>
              </div>
            ) : (
              <InternalLink
                to={`/posts/${post.slug}`}
                anchor={post.data.title}
                variant="inline"
                context="moderate"
                placement="navigation"
                title={`Teil ${index + 1}: ${post.data.title}`}
              />
            )}
          </li>
        ))}
      </ol>
    </section>
  )}

  {/* Call to Action */}
  <footer class="content-series__footer">
    <div class="series-cta">
      <p class="cta-text">
        <strong>üí° Tipp:</strong> Lesen Sie alle Artikel dieser Serie f√ºr ein vollst√§ndiges Verst√§ndnis des Themas.
      </p>
    </div>
  </footer>
</nav>

<style>
  /* Base content series styles */
  .content-series {
    @apply bg-gradient-to-br from-card/90 to-card/50 rounded-xl p-6 shadow-lg border border-border/40 my-8;
    backdrop-filter: blur(12px);
  }

  /* Header styles */
  .content-series__header {
    @apply mb-6 pb-4 border-b border-border/30;
  }

  .series-info {
    @apply space-y-4;
  }

  .series-title {
    @apply text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-3;
  }

  .series-icon {
    @apply text-2xl opacity-80;
  }

  .series-description {
    @apply text-sm text-gray-600 dark:text-gray-400 leading-relaxed;
  }

  /* Progress styles */
  .series-progress {
    @apply space-y-2;
  }

  .progress-visual {
    @apply flex items-center gap-4;
  }

  .progress-track {
    @apply flex-1 h-2 bg-border/30 rounded-full overflow-hidden;
  }

  .progress-fill {
    @apply h-full bg-gradient-to-r from-accent to-accent-hover transition-all duration-700 ease-out;
  }

  .progress-text {
    @apply text-sm font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap;
  }

  /* Navigation controls */
  .content-series__navigation {
    @apply mb-6;
  }

  .nav-controls {
    @apply grid grid-cols-1 md:grid-cols-3 gap-4 items-center;
  }

  .nav-item {
    @apply flex flex-col items-center text-center;
  }

  .nav-item--previous {
    @apply md:items-start md:text-left;
  }

  .nav-item--next {
    @apply md:items-end md:text-right;
  }

  .nav-item--overview {
    @apply md:order-none order-first;
  }

  .nav-item__details {
    @apply mt-2 space-y-1;
  }

  .nav-label {
    @apply block text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide;
  }

  .nav-title {
    @apply block text-sm text-gray-900 dark:text-gray-100 font-medium leading-tight;
  }

  .nav-item--disabled {
    @apply opacity-50;
  }

  .nav-disabled {
    @apply px-4 py-2 text-sm text-gray-600 dark:text-gray-400 bg-border/20 rounded-lg border border-border/30;
  }

  /* Series position indicator */
  .series-position {
    @apply flex flex-col items-center gap-2;
  }

  .position-indicator {
    @apply text-2xl font-bold text-accent;
  }

  .series-name {
    @apply text-sm font-medium text-gray-600 dark:text-gray-400;
  }

  /* Series overview */
  .content-series__overview {
    @apply mb-6 pb-4 border-b border-border/30;
  }

  .overview-title {
    @apply text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4;
  }

  .series-list {
    @apply space-y-2 list-none p-0 m-0;
  }

  .series-item {
    @apply p-3 rounded-lg border border-border/20 bg-card/20;
  }

  .series-item--current {
    @apply bg-accent/10 border-accent/30;
  }

  .series-item__current {
    @apply flex items-center gap-3;
  }

  .current-indicator {
    @apply text-lg;
  }

  .current-title {
    @apply flex-1 font-medium text-gray-900 dark:text-gray-100;
  }

  .current-label {
    @apply text-xs text-accent font-medium uppercase tracking-wide;
  }

  /* Footer / CTA */
  .content-series__footer {
    @apply pt-4 border-t border-border/30;
  }

  .series-cta {
    @apply p-4 bg-accent/8 rounded-lg border border-accent/15;
  }

  .cta-text {
    @apply text-sm text-gray-900 dark:text-gray-100 leading-relaxed m-0;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .content-series {
      @apply p-4;
    }

    .nav-controls {
      @apply grid-cols-1 gap-3;
    }

    .nav-item {
      @apply items-center text-center;
    }

    .series-title {
      @apply text-lg;
    }

    .position-indicator {
      @apply text-xl;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    .content-series {
      @apply border-2 border-accent;
    }

    .series-item {
      @apply border border-text-base;
    }

    .series-item--current {
      @apply border-2 border-accent bg-accent/20;
    }
  }

  /* Dark mode optimizations */
  @media (prefers-color-scheme: dark) {
    .content-series {
      @apply from-card/70 to-card/30;
    }

    .series-item {
      @apply bg-card/10;
    }

    .series-cta {
      @apply bg-accent/6;
    }
  }

  /* Print styles */
  @media print {
    .content-series {
      @apply bg-white border border-gray-300 shadow-none;
    }

    .series-icon,
    .current-indicator,
    .progress-visual {
      display: none;
    }

    .series-title {
      @apply text-black;
    }
  }
</style>