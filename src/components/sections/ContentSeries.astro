---
/**
 * ContentSeries Component
 *
 * Creates navigation for multi-part article series and sequential content.
 * Provides clear progression through related content with next/previous navigation.
 *
 * @component
 * @example
 * ```astro
 * <ContentSeries
 *   currentPost={post}
 *   seriesId="antivirale-strategien"
 *   showProgress={true}
 * />
 * ```
 */

import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { processAllPosts } from "@/utils/posts";
import { CONTENT_SERIES, type SeriesId } from "@/utils/seriesConfig";
import type { Post } from "@/utils/types";

import SeriesItem from "./content-series/SeriesItem.astro";
import SeriesNavigation from "./content-series/SeriesNavigation.astro";
import SeriesProgress from "./content-series/SeriesProgress.astro";

export interface Props {
  /** Current post in the series */
  currentPost: Post;
  /** Series identifier (can be from post metadata or manual) */
  seriesId?: string;
  /** Whether to show reading progress */
  showProgress?: boolean;
  /** Whether to show series overview */
  showOverview?: boolean;
  /** Custom series title */
  seriesTitle?: string;
}

const {
  currentPost,
  seriesId,
  showProgress = true,
  showOverview = true,
  seriesTitle,
} = Astro.props;

// Get translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch all posts (with slug property)
const sortedPosts = await processAllPosts({ includeDrafts: false });

// Auto-detect series if not provided
let detectedSeries: SeriesId | null = null;
let seriesInfo: (typeof CONTENT_SERIES)[SeriesId] | null = null;

if (seriesId && CONTENT_SERIES[seriesId as SeriesId]) {
  detectedSeries = seriesId as SeriesId;
  seriesInfo = CONTENT_SERIES[detectedSeries];
} else {
  // Auto-detect based on post slug patterns
  const currentSlug = currentPost.slug;

  for (const [id, series] of Object.entries(CONTENT_SERIES)) {
    if (
      series.posts.some(
        postSlug =>
          currentSlug.includes(postSlug.split("-").slice(-2).join("-")) ||
          series.posts.includes(currentSlug)
      )
    ) {
      detectedSeries = id as SeriesId;
      seriesInfo = series;
      break;
    }
  }
}

// Don't render if no series detected
if (!detectedSeries || !seriesInfo) {
  return null;
}

// Get series posts in order
const seriesPosts = seriesInfo.posts
  .map(slug =>
    sortedPosts.find(post => post.slug === slug || post.slug.includes(slug))
  )
  .filter(Boolean) as Post[];

if (seriesPosts.length <= 1) {
  return null;
}

// Find current post position
const currentIndex = seriesPosts.findIndex(post => post.id === currentPost.id);
const previousPost = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null;
const nextPost =
  currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null;

// Calculate progress
const progressData = {
  current: currentIndex + 1,
  total: seriesPosts.length,
  percentage: Math.round(((currentIndex + 1) / seriesPosts.length) * 100),
};

const finalSeriesTitle = seriesTitle || seriesInfo.title;
---

<nav
  class="content-series"
  aria-labelledby="content-series-heading"
  data-series={detectedSeries}
>
  {/* Series Header */}
  <header class="content-series__header">
    <div class="series-info">
      <h2 id="content-series-heading" class="series-title">
        <span class="series-icon">ðŸ“š</span>
        {finalSeriesTitle}
      </h2>

      {
        showProgress && (
          <SeriesProgress
            current={progressData.current}
            total={progressData.total}
            percentage={progressData.percentage}
          />
        )
      }

      {showOverview && <p class="series-description">{seriesInfo.description}</p>}
    </div>
  </header>

  {/* Navigation Controls */}
  <SeriesNavigation
    previousPost={previousPost}
    nextPost={nextPost}
    currentPost={currentPost}
    progressCurrent={progressData.current}
    progressTotal={progressData.total}
    seriesTitle={finalSeriesTitle}
  />

  {/* Complete Series Overview */}
  {
    showOverview && (
      <section class="content-series__overview">
        <h3 class="overview-title">{t("series.allArticlesInSeries")}</h3>

        <ol class="series-list">
          {seriesPosts.map((post, index) => (
            <SeriesItem
              post={post}
              index={index}
              isCurrent={post.id === currentPost.id}
            />
          ))}
        </ol>
      </section>
    )
  }

  {/* Call to Action */}
  <footer class="content-series__footer">
    <div class="series-cta">
      <p class="cta-text">
        {t("series.tipReadAll")}
      </p>
    </div>
  </footer>
</nav>

<style>
  @import "./content-series/series-styles.css";
</style>
