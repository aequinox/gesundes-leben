---
import ThemeToggle from "@/components/elements/ThemeToggle.astro";
import MegaMenu from "@/components/sections/MegaMenu.astro";
import type { IconName, NavigationLink } from "@/components/types";
import { SITE } from "@/config";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

interface LogoConfig {
  /** Whether to show the logo */
  readonly enable: boolean;

  /** Whether to use SVG format */
  readonly svg: boolean;

  /** Logo width in pixels */
  readonly width: number;

  /** Logo height in pixels */
  readonly height: number;
}

/**
 * Logo Configuration
 * Settings for the site logo
 */
const LOGO_IMAGE: Readonly<LogoConfig> = {
  enable: false, // Whether to show logo
  svg: true, // Use SVG format
  width: 216, // Logo width
  height: 46, // Logo height
};

interface Props {
  activeNav?: NavigationLink;
}

const { activeNav }: Props = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Core navigation links
const NAV_ITEMS = [
  { href: "/posts/", key: "posts", label: t("nav.posts") },
  { href: "/glossary/", key: "glossary", label: t("nav.glossary") },
  { href: "/tags/", key: "tags", label: t("nav.tags") },
  { href: "/our-vision/", key: "our-vision", label: t("nav.ourVision") },
  { href: "/about/", key: "about", label: t("nav.about") },
];

interface ActionItem {
  id: string;
  label: string;
  icon: IconName;
  href: string;
}

// Create action items array
const actionItems: ActionItem[] = [];

// Add search action if enabled
if (SITE.showSearch) {
  actionItems.push({
    id: "search-toggle",
    label: t("nav.search"),
    icon: "search",
    href: "/search/",
  });
}

// Add archives action if enabled
if (SITE.showArchives) {
  actionItems.push({
    id: "archives",
    label: t("nav.archives"),
    icon: "archive",
    href: "/archives/",
  });
}

// Use the properly typed array
const ACTIONS = actionItems;
---

<nav
  class="nav fixed inset-x-0 top-0 z-50 h-16 border-b border-border bg-background/80 shadow-sm backdrop-blur-md transition-transform duration-300 ease-out-expo"
  aria-label={t("nav.mainNavigation")}
>
  <div
    class="mx-auto flex h-full max-w-content items-center justify-between px-4"
  >
    <!-- Logo -->
    <a
      href="/"
      class="flex h-full items-center font-sans text-lg font-bold text-foreground transition-opacity hover:opacity-80"
      aria-label={t("nav.home")}
    >
      {
        LOGO_IMAGE.enable ? (
          <img
            src={`/assets/${LOGO_IMAGE.svg ? "logo.svg" : "logo.png"}`}
            alt={SITE.title}
            width={LOGO_IMAGE.width}
            height={LOGO_IMAGE.height}
            loading="eager"
            class="h-auto max-h-8 w-auto"
          />
        ) : (
          <span>{SITE.title}</span>
        )
      }
    </a>

    <!-- Primary Navigation (Desktop) -->
    <div class="hidden md:block">
      <ul class="flex items-center gap-6">
        <!-- Categories Mega Menu Trigger -->
        <li class="relative">
          <button
            id="categories-toggle"
            class="inline-flex items-center gap-1 transition-colors duration-200 hover:text-accent"
            aria-expanded="false"
            aria-controls="mega-menu"
            aria-haspopup="menu"
          >
            Kategorien
            <svg
              class="h-4 w-4 transition-transform duration-200"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </button>
        </li>
        {
          NAV_ITEMS.map(({ href, key, label }) => (
            <li>
              <a
                href={href}
                class:list={[
                  "transition-colors duration-200 hover:text-accent",
                  {
                    "text-accent underline decoration-solid decoration-2 underline-offset-4":
                      activeNav === key,
                  },
                ]}
                aria-current={activeNav === key ? "page" : undefined}
              >
                {label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <!-- Actions -->
    <div class="flex items-center gap-3">
      {
        ACTIONS.map(({ id, label, icon, href }) => (
          <a
            id={id}
            href={href}
            class:list={[
              "inline-flex items-center justify-center gap-2 rounded-full px-3 py-1.5 text-foreground transition-all hover:text-accent",
              "bg-surface2 hover:bg-surface3",
              { "bg-surface3 text-accent": activeNav === id },
            ]}
            aria-label={label}
            title={label}
          >
            <svg-icon name={icon} class="h-4 w-4" />
            <span class="hidden text-sm font-medium md:inline">{label}</span>
          </a>
        ))
      }

      {
        SITE.lightAndDarkMode && (
          <ThemeToggle lang={lang} size="md" variant="icon" />
        )
      }

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-toggle"
        class="bg-surface2 hover:bg-surface3 flex h-8 w-8 items-center justify-center rounded-full text-foreground transition-all hover:text-accent md:hidden"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label={t("nav.toggleMenu")}
      >
        <span class="menu-icon block transition-transform duration-300">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            fill="none"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M4 6h16"></path>
            <path d="M4 12h16"></path>
            <path d="M4 18h16"></path>
          </svg>
        </span>
        <span class="x-icon hidden transition-transform duration-300">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            fill="none"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </span>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="fixed inset-x-0 top-16 z-40 hidden h-[calc(100vh-4rem)] bg-background/95 backdrop-blur-md"
    aria-hidden="true"
  >
    <div class="mx-auto max-w-content p-4">
      <ul class="flex flex-col gap-2">
        {
          NAV_ITEMS.map(({ href, key, label }) => (
            <li>
              <a
                href={href}
                class:list={[
                  "hover:bg-surface2 block rounded-lg px-4 py-3 text-foreground transition-colors hover:text-accent",
                  {
                    "bg-surface2 text-accent underline decoration-solid decoration-2 underline-offset-4":
                      activeNav === key,
                  },
                ]}
                aria-current={activeNav === key ? "page" : undefined}
              >
                {label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>

  <!-- Mega Menu -->
  <MegaMenu />
</nav>

<script>
  import { NavigationController } from "@/utils/controllers/NavigationController";

  // Create SVG icon component using Tabler Icons
  class SvgIcon extends HTMLElement {
    static icons = {
      // Tabler Icons - https://tabler-icons.io/
      search: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>`,
      archive: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" /><path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" /><path d="M10 12l4 0" /></svg>`,
      moon: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" /></svg>`,
      sun: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" /></svg>`,
      menu: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6l16 0" /><path d="M4 12l16 0" /><path d="M4 18l16 0" /></svg>`,
      x: `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>`,
    };

    connectedCallback() {
      const name = this.getAttribute("name") || "";
      const svg = SvgIcon.icons[name as keyof typeof SvgIcon.icons] || "";
      this.innerHTML = svg;
    }
  }

  // Define custom element
  if (!customElements.get("svg-icon")) {
    customElements.define("svg-icon", SvgIcon);
  }

  // Initialize controller
  let controller: NavigationController | null = new NavigationController();

  // Handle Astro page transitions
  document.addEventListener("astro:page-load", () => {
    if (controller) {
      controller.cleanup();
    }
    controller = new NavigationController();
  });

  document.addEventListener("astro:before-swap", () => {
    if (controller) {
      controller.cleanup();
      controller = null;
    }
  });
</script>
