---
import LinkButton from "@/components/elements/LinkButton.astro";
import ThemeToggle from "@/components/elements/ThemeToggle.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import type { NavigationLink } from "@/data/navigation";
import { LOGO_IMAGE, SITE } from "@/config";
import Icon from "@/components/elements/Icon.astro";

export interface Props {
  activeNav?: NavigationLink;
}

const { activeNav } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface NavLink {
  href: string;
  key: NavigationLink;
  label: string;
}

const NAV_LINKS: NavLink[] = [
  { href: "/posts/", key: "posts", label: t("nav.posts") },
  { href: "/categories/", key: "categories", label: t("nav.categories") },
  { href: "/tags/", key: "tags", label: t("nav.tags") },
  { href: "/glossary/", key: "glossary", label: t("nav.glossary") },
  { href: "/about/", key: "about", label: t("nav.about") },
];

interface ActionButton extends NavLink {
  icon: "archive" | "search";
  showTextOnMobile: boolean;
}

const ACTION_BUTTONS: ActionButton[] = [
  SITE.showArchives && {
    href: "/archives/",
    key: "archives",
    label: "Archives",
    icon: "archive",
    showTextOnMobile: true,
  },
  SITE.showSearch && {
    href: "/search/",
    key: "search",
    label: t("nav.search"),
    icon: "search",
    showTextOnMobile: false,
  },
].filter((button): button is ActionButton => Boolean(button));
---

<header
  id="navbar"
  class="sticky top-0 z-20 w-full backdrop-blur-md transition-all duration-200"
  role="banner"
>
  <div class="mx-auto max-w-7xl px-4">
    <div
      class="relative flex w-full items-start justify-between p-4 md:items-center md:py-4"
    >
      <!-- Logo -->
      <a
        id="logo"
        href="/"
        class="logo scale-105 whitespace-nowrap"
        aria-label={SITE.title}
      >
        {
          LOGO_IMAGE.enable ? (
            <img
              src={`/assets/${LOGO_IMAGE.svg ? "logo.svg" : "logo.png"}`}
              alt={SITE.title}
              width={LOGO_IMAGE.width}
              height={LOGO_IMAGE.height}
              loading="eager"
            />
          ) : (
            SITE.title
          )
        }
      </a>

      <!-- Navigation Menu -->
      <nav id="nav-menu" class="flex-grow" aria-label={t("nav.mainNavigation")}>
        <input
          type="checkbox"
          id="nav-toggle"
          class="nav-toggle"
          aria-hidden="true"
        />
        <label
          for="nav-toggle"
          class="nav-toggle-label"
          aria-label={t("nav.toggleMenu")}
        >
          <span class="hamburger">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
          </span>
        </label>

        <ul id="menu-items" class="menu-items" role="menubar">
          {/* Navigation Links */}
          {
            NAV_LINKS.map(({ href, key, label }) => (
              <li role="none">
                <a
                  href={href}
                  class:list={["nav-link", activeNav === key && "active"]}
                  role="menuitem"
                  aria-current={activeNav === key ? "page" : undefined}
                >
                  {label}
                </a>
              </li>
            ))
          }

          {/* Action Buttons */}
          <div
            class="action-buttons"
            role="group"
            aria-label={t("nav.additionalActions")}
          >
            {
              ACTION_BUTTONS.map(
                ({ href, key, label, icon, showTextOnMobile }) => (
                  <li role="none">
                    <LinkButton
                      href={href}
                      className={`action-button ${activeNav === key ? "active" : ""}`}
                      ariaLabel={label}
                      title={label}
                    >
                      <Icon name={icon} active={activeNav === key} />
                      <span
                        class:list={[
                          showTextOnMobile ? "sm:sr-only" : "sr-only",
                          activeNav === key && "active",
                        ]}
                      >
                        {label}
                      </span>
                    </LinkButton>
                  </li>
                )
              )
            }

            {/* Theme Toggle */}
            {
              SITE.lightAndDarkMode && (
                <li role="none">
                  <ThemeToggle lang={lang} />
                </li>
              )
            }
          </div>
        </ul>
      </nav>
    </div>
  </div>
</header>

<style>
  /* Base Styles */
  .nav-toggle {
    @apply hidden;
  }

  .nav-toggle-label {
    @apply cursor-pointer self-end p-2 outline-2 outline-offset-1 outline-skin-fill focus-visible:no-underline focus-visible:outline-dashed md:hidden;
  }

  /* Menu Items */
  .menu-items {
    @apply absolute left-4 right-4 top-full mt-2 hidden rounded-lg border-2 border-skin-inverted bg-skin-fill/95 p-2 shadow-lg md:static md:flex md:border-none md:bg-transparent md:p-0 md:shadow-none;
  }

  .nav-toggle:checked ~ .menu-items {
    @apply flex flex-col;
  }

  /* Navigation Links */
  .nav-link {
    @apply w-full px-4 py-3 text-center font-medium hover:text-skin-accent md:my-0 md:px-2 md:py-1;
  }

  .nav-link.active {
    @apply underline decoration-wavy decoration-2 underline-offset-4;
  }

  /* Action Buttons */
  .action-buttons {
    @apply grid w-full grid-cols-3 gap-2 md:contents;
  }

  .action-button {
    @apply flex justify-center p-3 sm:p-1;
  }

  .action-button.active :global(svg) {
    @apply fill-skin-accent;
  }

  /* Hamburger Menu */
  .hamburger {
    @apply flex h-5 w-6 flex-col justify-between;
  }

  .hamburger .line {
    @apply block h-0.5 w-full bg-current transition-transform duration-300 ease-in-out;
  }

  .nav-toggle:checked ~ .nav-toggle-label .hamburger .line:nth-child(1) {
    @apply translate-y-[9px] rotate-45;
  }

  .nav-toggle:checked ~ .nav-toggle-label .hamburger .line:nth-child(2) {
    @apply opacity-0;
  }

  .nav-toggle:checked ~ .nav-toggle-label .hamburger .line:nth-child(3) {
    @apply -translate-y-[9px] -rotate-45;
  }

  /* Navigation Layout */
  nav {
    @apply flex w-full flex-col items-center md:ml-2 md:flex-row md:justify-end md:space-x-4 md:py-0;
  }

  /* Navigation Shrink Effect */
  :global(.nav-shrink) {
    @apply h-14 bg-skin-fill/75 shadow-lg;
  }
</style>

<script>
  // Add scroll listener for navbar shrink effect
  const navbar = document.getElementById("navbar");
  const SCROLL_THRESHOLD = 50;

  function updateNavbarStyle() {
    if (window.scrollY > SCROLL_THRESHOLD) {
      navbar?.classList.add("nav-shrink");
    } else {
      navbar?.classList.remove("nav-shrink");
    }
  }

  window.addEventListener("scroll", updateNavbarStyle, { passive: true });
  document.addEventListener("astro:after-swap", updateNavbarStyle);
</script>
