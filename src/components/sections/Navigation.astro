---
/**
 * Navigation Component
 *
 * A modern, responsive navigation component that provides site-wide navigation with
 * enhanced accessibility, mobile support, and performance optimizations.
 *
 * Features:
 * - Responsive design with mobile-first approach
 * - Enhanced accessibility with ARIA labels and keyboard navigation
 * - Smooth animations with reduced motion support
 * - Optimized performance with proper event handling
 * - Theme toggle and search functionality
 * - Print and high contrast mode optimizations
 *
 * @component
 * @example
 * ```astro
 * <Navigation activeNav="posts" />
 * ```
 */

import LinkButton from "@/components/elements/LinkButton.astro";
import ThemeToggle from "@/components/elements/ThemeToggle.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import type { NavigationLink } from "@/data/navigation";
import { LOGO_IMAGE, SITE } from "@/config";
import MenuIcon from "@/components/elements/Icon.astro";

// Type-safe component props
interface Props {
  /** Currently active navigation item */
  activeNav?: NavigationLink;
}

// Type definitions for navigation items
interface NavLink {
  /** URL for the link */
  href: string;
  /** Navigation key for active state */
  key: NavigationLink;
  /** Display label */
  label: string;
}

interface ActionButton extends NavLink {
  /** Icon name from the icon set */
  icon: "archive" | "search";
  /** Whether to show text on mobile */
  showTextOnMobile: boolean;
}

const { activeNav }: Props = Astro.props;

// Internationalization setup
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Pre-compute translated strings for performance
const i18nStrings = {
  mainNav: t("nav.mainNavigation"),
  home: t("nav.home"),
  toggleMenu: t("nav.toggleMenu"),
  openMenu: t("nav.openMenu"),
  closeMenu: t("nav.closeMenu"),
} as const;

// Define main navigation links
const NAV_LINKS: NavLink[] = [
  { href: "/posts/", key: "posts", label: t("nav.posts") },
  { href: "/glossary/", key: "glossary", label: t("nav.glossary") },
  // { href: "/categories/", key: "categories", label: t("nav.categories") },
  { href: "/tags/", key: "tags", label: t("nav.tags") },
  // { href: "/references/", key: "references", label: t("nav.references") },
  { href: "/our-vision/", key: "our-vision", label: t("nav.ourVision") },
  { href: "/about/", key: "about", label: t("nav.about") },
];

// Define action buttons with type safety
const ACTION_BUTTONS: ActionButton[] = [
  SITE.showArchives && {
    href: "/archives/",
    key: "archives",
    label: t("nav.archives"),
    icon: "archive",
    showTextOnMobile: false,
  },
  SITE.showSearch && {
    href: "/search/",
    key: "search",
    label: t("nav.search"),
    icon: "search",
    showTextOnMobile: false,
  },
].filter((button): button is ActionButton => Boolean(button));

// Utility function to combine Tailwind classes
const tw = (...classes: string[]) => classes.filter(Boolean).join(" ");

// Component-specific class compositions
const navClasses = tw(
  "nav-container h-16",
  "bg-skin-fill/90 backdrop-blur-lg",
  "transition-all duration-200 ease-in-out"
);

const menuButtonClasses = tw(
  "flex h-16 items-center p-2 md:hidden",
  "hover:text-skin-accent focus:text-skin-accent",
  "transition-all duration-200"
);

const menuItemsClasses = tw(
  "fixed right-4 top-16 hidden",
  "rounded-lg border border-skin-line bg-skin-fill/95",
  "shadow-lg backdrop-blur-md",
  "transform-gpu transition-transform duration-200",
  "md:static md:flex md:transform-none",
  "md:border-none md:bg-transparent md:shadow-none md:backdrop-blur-none"
);

const menuListClasses = tw(
  "grid w-44 grid-cols-2 grid-rows-4 gap-2 p-4",
  "md:flex md:w-auto md:grid-cols-none md:grid-rows-none",
  "md:items-center md:gap-x-6 md:gap-y-0 md:p-0"
);

const linkClasses = tw(
  "w-full px-4 py-3 text-center font-medium",
  "transition-all duration-200",
  "hover:text-skin-accent focus:text-skin-accent",
  "md:my-0 md:w-auto md:px-3 md:py-2 md:rounded-md"
);

const activeClasses = tw(
  "text-skin-accent font-semibold",
  "bg-skin-accent/10 md:rounded-md"
);
---

<nav class={navClasses} role="navigation" aria-label={i18nStrings.mainNav}>
  <div class="mx-auto flex h-16 w-full items-center justify-between px-4">
    {/* Logo/Home Link */}
    <a
      href="/"
      class="flex h-16 items-center transition-opacity hover:opacity-80"
      aria-label={i18nStrings.home}
    >
      {
        LOGO_IMAGE.enable ? (
          <img
            src={`/assets/${LOGO_IMAGE.svg ? "logo.svg" : "logo.png"}`}
            alt={SITE.title}
            width={LOGO_IMAGE.width}
            height={LOGO_IMAGE.height}
            loading="eager"
            class="h-auto max-h-10 w-auto"
          />
        ) : (
          <span class="text-lg font-bold">{SITE.title}</span>
        )
      }
    </a>

    <div class="flex items-center gap-2">
      {/* Mobile Menu Button */}
      <button
        id="hamburger-menu"
        class={menuButtonClasses}
        aria-label={i18nStrings.toggleMenu}
        aria-expanded="false"
        aria-controls="menu-items"
        data-labels={JSON.stringify({
          open: i18nStrings.openMenu,
          close: i18nStrings.closeMenu,
        })}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="menu-icon h-6 w-6"
          aria-hidden="true"
        >
          <line x1="7" y1="12" x2="21" y2="12" class="line"></line>
          <line x1="3" y1="6" x2="21" y2="6" class="line"></line>
          <line x1="12" y1="18" x2="21" y2="18" class="line"></line>
          <line x1="18" y1="6" x2="6" y2="18" class="close"></line>
          <line x1="6" y1="6" x2="18" y2="18" class="close"></line>
        </svg>
      </button>

      {/* Navigation Menu */}
      <div id="menu-items" class={menuItemsClasses} role="menu">
        <ul class={menuListClasses}>
          {/* Main Navigation Links */}
          {
            NAV_LINKS.map(({ href, key, label }) => (
              <li class="col-span-2 flex items-center justify-center">
                <a
                  href={href}
                  class:list={[linkClasses, activeNav === key && activeClasses]}
                  aria-current={activeNav === key ? "page" : undefined}
                  role="menuitem"
                >
                  {label}
                </a>
              </li>
            ))
          }

          {/* Action Buttons and Theme Toggle */}
          <li
            class="col-span-2 flex items-center justify-end gap-x-2 md:col-span-1"
          >
            {
              ACTION_BUTTONS.map(
                ({ href, key, label, icon, showTextOnMobile }) => (
                  <LinkButton
                    href={href}
                    className={`action-button ${activeNav === key ? "active" : ""}`}
                    ariaLabel={label}
                    title={label}
                  >
                    <MenuIcon name={icon} active={activeNav === key} />
                    <span class={showTextOnMobile ? "sm:sr-only" : "sr-only"}>
                      {label}
                    </span>
                  </LinkButton>
                )
              )
            }
            {SITE.lightAndDarkMode && <ThemeToggle lang={lang} />}
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<style>
  /* Menu icon animations */
  .menu-icon .line {
    @apply transition-opacity duration-200 ease-in-out;
  }

  .menu-icon .close {
    @apply opacity-0 transition-opacity duration-200 ease-in-out;
  }

  #hamburger-menu[aria-expanded="true"] .line {
    @apply opacity-0;
  }

  #hamburger-menu[aria-expanded="true"] .close {
    @apply opacity-100;
  }

  /* Action button styles */
  :global(.action-button) {
    @apply flex items-center justify-center rounded-full p-2;
    @apply transition-all duration-200 ease-in-out;
    @apply hover:bg-skin-accent/10 hover:text-skin-accent focus:text-skin-accent;
  }

  :global(.action-button.active) {
    @apply bg-skin-accent/10 text-skin-accent;
  }

  :global(.action-button svg) {
    @apply h-5 w-5;
  }

  /* Navigation container styles */
  .nav-container {
    @apply px-4 py-3;
    @apply transition-all duration-200 ease-in-out;
    @apply bg-gradient-to-b from-skin-fill/95 to-skin-fill/90;
    @apply backdrop-blur-md;
  }

  /* .nav-container.scrolled {
    @apply px-4 py-1;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.07),
      0 2px 4px -1px rgba(0, 0, 0, 0.05);
  } */

  /* Focus styles */
  a:focus-visible,
  button:focus-visible {
    @apply outline-none ring-2 ring-skin-accent ring-offset-2;
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .nav-container,
    .menu-icon .line,
    .menu-icon .close,
    :global(.action-button),
    .transition-all {
      @apply transform-none transition-none;
    }
  }

  /* Print optimization */
  @media print {
    nav {
      @apply hidden;
    }
  }

  /* High contrast mode support */
  @media (forced-colors: active) {
    .nav-container {
      @apply border-b-2 border-[ButtonText];
    }
  }

  /* Dark mode optimizations */
  :global(.dark) .nav-container {
    @apply bg-gradient-to-b from-skin-fill/95 to-skin-fill/90;
  }

  :global(.dark) .nav-container.scrolled {
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.2),
      0 2px 4px -1px rgba(0, 0, 0, 0.15);
  }

  /* Mobile menu animations */
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .menu-enter {
    animation: slideIn 0.2s ease-out;
  }

  .menu-exit {
    animation: slideOut 0.2s ease-in;
  }
</style>

<script>
  import { themeService } from "@/services/ui/ThemeService";

  /**
   * Enhanced navigation functionality with improved performance and accessibility
   *
   * Features:
   * - Smooth mobile menu animations
   * - Performance optimized with RAF
   * - Enhanced keyboard navigation
   * - Proper cleanup on page transitions
   * - Theme persistence during navigation
   */
  class NavigationController {
    private menuBtn: HTMLElement | null;
    private menuItems: HTMLElement | null;
    private nav: HTMLElement | null;
    private scrollTimeout: number | null;
    private labels: { open: string; close: string };
    private navLinks: HTMLAnchorElement[] | null;
    private linkClickHandlers: Map<HTMLAnchorElement, () => void>;

    constructor() {
      this.menuBtn = document.getElementById("hamburger-menu");
      this.menuItems = document.getElementById("menu-items");
      this.nav = document.querySelector(".nav-container");
      this.scrollTimeout = null;
      this.labels = this.getMenuLabels();
      this.navLinks = Array.from(document.querySelectorAll("nav a"));
      this.linkClickHandlers = new Map();

      if (!this.menuBtn || !this.menuItems || !this.nav) {
        console.warn("Navigation elements not found");
        return;
      }

      this.init();
    }

    private getMenuLabels(): { open: string; close: string } {
      return this.menuBtn?.dataset.labels
        ? JSON.parse(this.menuBtn.dataset.labels)
        : {
            open: "Open Menu",
            close: "Close Menu",
          };
    }

    private init(): void {
      this.setupEventListeners();
      this.setupKeyboardNav();
    }

    private toggleMenu = (): void => {
      if (!this.menuBtn || !this.menuItems) return;

      const isExpanded = this.menuBtn.getAttribute("aria-expanded") === "true";
      const willExpand = !isExpanded;

      this.menuBtn.setAttribute("aria-expanded", willExpand.toString());
      this.menuBtn.setAttribute(
        "aria-label",
        willExpand ? this.labels.close : this.labels.open
      );

      // Toggle with animation
      if (willExpand) {
        this.menuItems.classList.remove("hidden");
        this.menuItems.classList.add("menu-enter");
      } else {
        this.menuItems.classList.add("menu-exit");
        setTimeout(() => {
          this.menuItems?.classList.add("hidden");
          this.menuItems?.classList.remove("menu-exit");
        }, 200);
      }
    };

    private handleScroll = (): void => {
      if (!this.nav) return;

      const scrollThreshold = window.innerHeight * 0.25;
      const isScrolled = window.scrollY > scrollThreshold;

      this.nav.classList.toggle("scrolled", isScrolled);
    };

    private setupKeyboardNav(): void {
      // Close menu on Escape
      document.addEventListener("keydown", (e: KeyboardEvent) => {
        if (
          e.key === "Escape" &&
          this.menuBtn?.getAttribute("aria-expanded") === "true"
        ) {
          this.toggleMenu();
        }
      });

      // Focus trap within menu when open
      const focusableElements = this.menuItems?.querySelectorAll(
        'a[href], button, [tabindex]:not([tabindex="-1"])'
      );

      if (focusableElements?.length) {
        const firstFocusable = focusableElements[0] as HTMLElement;
        const lastFocusable = focusableElements[
          focusableElements.length - 1
        ] as HTMLElement;

        lastFocusable.addEventListener("keydown", (e: KeyboardEvent) => {
          if (e.key === "Tab" && !e.shiftKey) {
            e.preventDefault();
            firstFocusable.focus();
          }
        });

        firstFocusable.addEventListener("keydown", (e: KeyboardEvent) => {
          if (e.key === "Tab" && e.shiftKey) {
            e.preventDefault();
            lastFocusable.focus();
          }
        });
      }
    }

    private handleLinkClick = (): void => {
      // Store current theme in session storage for persistence during navigation
      sessionStorage.setItem(
        "theme-transition",
        document.documentElement.getAttribute("data-theme") || ""
      );

      // Apply theme immediately before navigation to prevent flickering
      themeService.applyThemeImmediately();
    };

    private setupEventListeners(): void {
      // Menu toggle
      this.menuBtn?.addEventListener("click", this.toggleMenu);

      // Optimized scroll handling
      window.addEventListener(
        "scroll",
        () => {
          if (this.scrollTimeout) {
            cancelAnimationFrame(this.scrollTimeout);
          }
          this.scrollTimeout = requestAnimationFrame(this.handleScroll);
        },
        { passive: true }
      );

      // Close menu on click outside
      document.addEventListener("click", (e: MouseEvent) => {
        if (
          this.menuBtn?.getAttribute("aria-expanded") === "true" &&
          !this.menuItems?.contains(e.target as Node) &&
          !this.menuBtn.contains(e.target as Node)
        ) {
          this.toggleMenu();
        }
      });

      // Handle link clicks to apply theme immediately before navigation
      if (this.navLinks) {
        this.navLinks.forEach(link => {
          // Create a unique handler for each link and store it for cleanup
          const handler = this.handleLinkClick.bind(this);
          this.linkClickHandlers.set(link, handler);
          link.addEventListener("click", handler, { capture: true });

          // Add data attribute to mark links as processed
          link.setAttribute("data-theme-processed", "true");
        });
      }
    }

    public cleanup(): void {
      this.menuBtn?.removeEventListener("click", this.toggleMenu);

      // Clean up link click handlers
      if (this.linkClickHandlers.size > 0) {
        this.linkClickHandlers.forEach((handler, link) => {
          link.removeEventListener("click", handler, { capture: true });
        });
        this.linkClickHandlers.clear();
      }

      if (this.scrollTimeout) {
        cancelAnimationFrame(this.scrollTimeout);
      }
    }
  }

  // Initialize controller
  let controller: NavigationController | null = new NavigationController();

  // Handle Astro page transitions
  document.addEventListener("astro:page-load", () => {
    controller?.cleanup();
    controller = new NavigationController();
  });

  // Apply theme at each stage of the view transition
  document.addEventListener("astro:before-preparation", () => {
    themeService.applyThemeImmediately();
  });

  document.addEventListener("astro:after-preparation", () => {
    themeService.applyThemeImmediately();
  });

  document.addEventListener("astro:before-swap", () => {
    controller?.cleanup();
    controller = null;
    themeService.applyThemeImmediately();
  });

  document.addEventListener("astro:after-swap", () => {
    themeService.reflectPreference();
  });
</script>
