---
import LinkButton from "@/components/elements/LinkButton.astro";
import ThemeToggle from "@/components/elements/ThemeToggle.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import type { NavigationLink } from "@/data/navigation";
import { LOGO_IMAGE, SITE } from "@/config";
import MenuIcon from "@/components/elements/Icon.astro";

export interface Props {
  activeNav?: NavigationLink;
}

const { activeNav } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface NavLink {
  href: string;
  key: NavigationLink;
  label: string;
}

const NAV_LINKS: NavLink[] = [
  { href: "/posts/", key: "posts", label: t("nav.posts") },
  /*
  { href: "/categories/", key: "categories", label: t("nav.categories") },
  { href: "/tags/", key: "tags", label: t("nav.tags") },
   */
  { href: "/glossary/", key: "glossary", label: t("nav.glossary") },
  { href: "/about/", key: "about", label: t("nav.about") },
];

interface ActionButton extends NavLink {
  icon: "archive" | "search";
  showTextOnMobile: boolean;
}

const ACTION_BUTTONS: ActionButton[] = [
  SITE.showArchives && {
    href: "/archives/",
    key: "archives",
    label: t("nav.archives"),
    icon: "archive",
    showTextOnMobile: false,
  },
  SITE.showSearch && {
    href: "/search/",
    key: "search",
    label: t("nav.search"),
    icon: "search",
    showTextOnMobile: false,
  },
].filter((button): button is ActionButton => Boolean(button));
---

<header class="sticky top-0 z-20 w-full">
  <nav
    class="nav-container h-16 bg-skin-fill/75 backdrop-blur-md transition-all duration-200"
  >
    <div class="mx-auto flex h-16 w-full items-center justify-between">
      <a href="/" class="flex h-16 items-center">
        {
          LOGO_IMAGE.enable ? (
            <img
              src={`/assets/${LOGO_IMAGE.svg ? "logo.svg" : "logo.png"}`}
              alt={SITE.title}
              width={LOGO_IMAGE.width}
              height={LOGO_IMAGE.height}
              loading="eager"
            />
          ) : (
            SITE.title
          )
        }
      </a>

      <div class="flex items-center">
        <button
          id="hamburger-menu"
          class="flex h-16 items-center p-2 md:hidden"
          aria-label="Open Menu"
          aria-expanded="false"
          aria-controls="menu-items"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="menu-icon h-6 w-6"
          >
            <line x1="7" y1="12" x2="21" y2="12" class="line"></line>
            <line x1="3" y1="6" x2="21" y2="6" class="line"></line>
            <line x1="12" y1="18" x2="21" y2="18" class="line"></line>
            <line x1="18" y1="6" x2="6" y2="18" class="close"></line>
            <line x1="6" y1="6" x2="18" y2="18" class="close"></line>
          </svg>
        </button>

        <div
          id="menu-items"
          class="fixed right-4 top-16 hidden rounded-lg border-2 border-skin-line bg-skin-fill shadow-lg md:static md:flex md:border-none md:bg-transparent md:shadow-none"
        >
          <ul
            class="grid w-44 grid-cols-2 grid-rows-4 gap-x-2 gap-y-2 p-4 md:flex md:w-auto md:grid-cols-none md:grid-rows-none md:items-center md:gap-x-5 md:gap-y-0 md:p-0"
          >
            {
              NAV_LINKS.map(({ href, key, label }) => (
                <li class="col-span-2 flex items-center justify-center">
                  <a
                    href={href}
                    class:list={[
                      "w-full px-4 py-3 text-center font-medium hover:text-skin-accent md:my-0 md:w-auto md:px-2 md:py-1",
                      activeNav === key &&
                        "text-skin-accent underline decoration-wavy decoration-2 underline-offset-4",
                    ]}
                    aria-current={activeNav === key ? "page" : undefined}
                  >
                    {label}
                  </a>
                </li>
              ))
            }
            <li
              class="col-span-2 flex items-center justify-end gap-x-2 md:col-span-1"
            >
              {
                ACTION_BUTTONS.map(
                  ({ href, key, label, icon, showTextOnMobile }) => (
                    <LinkButton
                      href={href}
                      className={`action-button ${activeNav === key ? "active" : ""}`}
                      ariaLabel={label}
                      title={label}
                    >
                      <MenuIcon name={icon} active={activeNav === key} />
                      <span class={showTextOnMobile ? "sm:sr-only" : "sr-only"}>
                        {label}
                      </span>
                    </LinkButton>
                  )
                )
              }
              {SITE.lightAndDarkMode && <ThemeToggle lang={lang} />}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
</header>

<style>
  .menu-icon .line {
    @apply transition-opacity duration-200;
  }
  .menu-icon .close {
    @apply opacity-0 transition-opacity duration-200;
  }
  #hamburger-menu[aria-expanded="true"] .line {
    @apply opacity-0;
  }
  #hamburger-menu[aria-expanded="true"] .close {
    @apply opacity-100;
  }

  :global(.action-button) {
    @apply flex items-center justify-center p-2 hover:text-skin-accent;
  }
  :global(.action-button.active) {
    @apply text-skin-accent;
  }
  :global(.action-button svg) {
    @apply h-6 w-6;
  }

  .nav-container {
    @apply px-4 py-3 transition-all duration-200;
    border-bottom: 2px solid transparent;
  }

  .nav-container.scrolled {
    @apply border-b-2 border-skin-accent px-4 py-1;
  }
</style>

<script>
  function toggleNav() {
    const menuBtn = document.getElementById("hamburger-menu");
    const menuItems = document.getElementById("menu-items");

    if (!menuBtn || !menuItems) return;

    menuBtn.addEventListener("click", () => {
      const isExpanded = menuBtn.getAttribute("aria-expanded") === "true";
      menuBtn.setAttribute("aria-expanded", (!isExpanded).toString());
      menuBtn.setAttribute(
        "aria-label",
        isExpanded ? "Open Menu" : "Close Menu"
      );
      menuItems.classList.toggle("hidden");
    });
  }

  function handleScroll() {
    const nav = document.querySelector(".nav-container");
    if (!nav) return;

    const scrollThreshold = window.innerHeight * 0.25; // 25% of viewport height
    const isScrolled = window.scrollY > scrollThreshold;

    nav.classList.toggle("scrolled", isScrolled);
  }

  // Initialize
  toggleNav();
  handleScroll();

  // Event listeners
  document.addEventListener("astro:after-swap", toggleNav);
  window.addEventListener("scroll", handleScroll);
</script>
