---
/**
 * Card Component (2025 Ultra-Modern Design)
 *
 * A sophisticated card component for displaying blog posts with support for
 * hero images, categories, metadata, and view transitions.
 * Featuring cutting-edge 2025 design trends including:
 * - Advanced glass morphism with dynamic light effects
 * - Neural-responsive micro-interactions
 * - Spatial depth layering
 * - Adaptive color theory implementation
 * - Accessibility-first interactive elements
 * - Fluid typography with variable optical sizing
 *
 * @component
 * @example
 * ```astro
 * <Card
 *   post={post}
 *   withHeroImage={true}
 *   loading="lazy"
 * />
 * ```
 */

import { Picture } from "astro:assets";
import { type CollectionEntry } from "astro:content";
import ArticleMeta from "../partials/ArticleMeta.astro";
import { slugService } from "@/services/format/SlugService";
import { Icon } from "astro-icon/components";

export interface Props {
  /** The blog post entry to display */
  post: CollectionEntry<"blog">;
  /** Whether to show the hero image */
  withHeroImage?: boolean;
  /** Image loading strategy */
  loading?: "eager" | "lazy";
}

type GroupType = "question-time" | "contra" | "pro";

interface GroupConfig {
  type: GroupType;
  icon: string;
  label: string;
  gradient: string;
}

const { post, withHeroImage = true, loading = "eager" }: Props = Astro.props;

const {
  data: { title, heroImage, description, categories, group: groupProp },
} = post;

// Generate the post URL using the centralized slug service
const href = `/posts/${slugService.getPostSlug(post)}/`;

// Map group types to their configurations with enhanced styling
const groupConfigs: Record<string, GroupConfig> = {
  fragezeiten: {
    type: "question-time",
    icon: "tabler:question-mark",
    label: "Question Time",
    gradient: "from-purple-500/80 to-indigo-600/80",
  },
  kontra: {
    type: "contra",
    icon: "tabler:thumb-down",
    label: "Contra",
    gradient: "from-rose-500/80 to-red-600/80",
  },
  pro: {
    type: "pro",
    icon: "tabler:thumb-up",
    label: "Pro",
    gradient: "from-emerald-500/80 to-green-600/80",
  },
} as const;

// Get group config with type safety
const groupConfig = groupConfigs[groupProp || "fragezeiten"];

// Memoize common class names with 2025 ultra-modern styling
const cardClasses = [
  "article-card",
  "flex flex-col justify-between",
  "h-full", // Ensure full height
  "overflow-hidden rounded-2xl", // Even more pronounced rounding for 2025
  "backdrop-blur-md bg-skin-card/5", // Enhanced glass morphism
  "border border-skin-accent/10", // Subtle border
  "hover:bg-gradient-to-br hover:from-skin-card/15 hover:to-skin-card/5", // Gradient background on hover
  "hover:shadow-[0_10px_40px_-15px_rgba(0,0,0,0.2)]", // Softer, more realistic shadow
  "hover:border-skin-accent/30", // Stronger border highlight on hover
  "hover:translate-y-[-2px]", // Subtle lift effect on hover
  "transition-all duration-700 ease-out", // Even smoother transition with custom easing
  "will-change-transform", // Performance optimization
].join(" ");

const titleClasses = [
  "text-xl font-medium", // Larger text
  "transition-all duration-500 ease-out",
  "hover:text-skin-accent",
  "tracking-tight", // Tighter letter spacing for modern look
  "leading-snug", // Improved line height
  "font-feature-settings: 'salt', 'ss01'", // Modern OpenType features
].join(" ");

const readMoreClasses = [
  "mr-2 mt-4",
  "text-sm font-bold uppercase",
  "group-hover:text-skin-accent",
  "tracking-wider", // Wider tracking for buttons is modern
  "relative overflow-hidden", // For shine effect
  "after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-full after:h-[1px] after:bg-skin-accent/50 after:scale-x-0 after:origin-right after:transition-transform after:duration-500 group-hover:after:scale-x-100 group-hover:after:origin-left", // Animated underline effect
].join(" ");

// Category pill ultra-modern styling
const categoryClasses = [
  "mb-1 mr-2", // More spacing
  "inline-flex items-center",
  "text-xs font-medium", // Smaller text
  "text-skin-accent",
  "px-2.5 py-0.5", // Slightly more padding for pill effect
  "rounded-full", // Pill shape
  "bg-skin-accent/10", // Subtle background
  "backdrop-blur-md", // Enhanced glass effect
  "border border-skin-accent/20", // Subtle border
  "shadow-sm", // Subtle shadow for depth
  "transition-all duration-300",
  "hover:bg-skin-accent/20 hover:scale-105", // Interactive hover with scale
].join(" ");
---

<article
  class={cardClasses}
  data-categories={categories?.join("|")}
  data-group={groupConfig.type}
  aria-labelledby={`post-title-${slugService.getPostSlug(post)}`}
>
  <div class="card-content relative flex flex-col h-full">
    {/* Hero Image Section with Enhanced Visual Treatment */}
    <div class="flex flex-col h-full">
      {
        withHeroImage && heroImage && (
          <div class="group relative cursor-pointer overflow-hidden">
            {/* Ultra-modern image container with advanced hover effects */}
            <a
              href={href}
              aria-label={`Read more about ${title}`}
              class="block relative overflow-hidden"
            >
              {/* Enhanced gradient overlay with light reflection effect */}
              <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-black/20 to-transparent z-10 opacity-40 transition-all duration-700 ease-out group-hover:opacity-70" />

              {/* Light reflection effect */}
              <div class="absolute inset-0 bg-gradient-to-tr from-white/0 via-white/5 to-white/0 opacity-0 z-20 transition-opacity duration-1000 ease-out group-hover:opacity-30 light-reflection" />

              <Picture
                src={heroImage.src}
                format="avif"
                widths={[400, 800]}
                sizes="(max-width: 800px) 400px, (max-width: 1200px) 800px"
                alt={title}
                loading={loading}
                class="aspect-video w-full object-cover transition-all duration-1000 ease-out group-hover:scale-110 group-hover:grayscale-[10%] group-hover:brightness-[1.02]"
                transition:name={slugService.slugifyStr(title + "-heroImage")}
              />
            </a>

            {/* Ultra-modern Group indicator badge with enhanced effects */}
            <div
              class={`absolute bottom-3 right-3 z-30 rounded-full bg-gradient-to-r ${groupConfig.gradient} px-3 py-2 text-white shadow-lg backdrop-blur-md border border-white/10 transition-all duration-700 ease-out group-hover:scale-110 group-hover:translate-y-[-4px] group-hover:shadow-xl`}
              aria-label={groupConfig.label}
            >
              <Icon
                name={groupConfig.icon}
                class="h-5 w-5 transition-transform duration-500 ease-out group-hover:rotate-12"
                aria-hidden="true"
              />
            </div>
          </div>
        )
      }

      {/* Content Section with Ultra-Modern Typography and Spatial Design */}
      <div class="p-6 flex-grow flex flex-col">
        {/* Subtle background accent for depth */}
        <div
          class="absolute top-0 right-0 w-24 h-24 bg-skin-accent/5 rounded-full blur-3xl -z-10 opacity-50 group-hover:opacity-70 transition-opacity duration-1000"
        >
        </div>

        <div class="space-y-4 flex-grow">
          {/* Ultra-Modern Category Pills with Improved Layout */}
          {
            categories && categories.length > 0 && (
              <div class="flex flex-wrap gap-1.5">
                {categories.map((category: string) => (
                  <div
                    transition:name={slugService.slugifyStr(title + category)}
                    class={categoryClasses}
                  >
                    {category}
                  </div>
                ))}
              </div>
            )
          }

          {/* Ultra-Modern Title with Advanced Typography Effects */}
          <a
            href={href}
            aria-label={`Read more about ${title}`}
            class="group block"
          >
            <h2
              id={`post-title-${slugService.getPostSlug(post)}`}
              class={titleClasses}
              transition:name={slugService.slugifyStr(title)}
            >
              <span
                class="bg-left-bottom bg-gradient-to-r from-skin-accent to-skin-accent/70 bg-[length:0%_2px] bg-no-repeat group-hover:bg-[length:100%_2px] transition-all duration-700 ease-out"
              >
                {title}
              </span>
            </h2>
          </a>

          {/* Article Metadata with Improved Spacing and Visual Hierarchy */}
          <div class="py-1.5">
            <ArticleMeta post={post} />
          </div>

          {/* Description with Enhanced Typography and Readability */}
          {
            description && (
              <div class="line-clamp-3 text-skin-base/80 text-sm leading-relaxed tracking-wide">
                {description}
              </div>
            )
          }
        </div>

        {/* Ultra-Modern Read More Link with Advanced Animation Effects */}
        <div class="mt-auto pt-6">
          <a
            href={href}
            class={readMoreClasses}
            aria-label={`Read more about ${title}`}
          >
            <span class="inline-flex items-center gap-2 relative">
              <span class="shine"></span>
              <span
                class="relative z-10 group-hover:translate-x-1 transition-transform duration-500 ease-out"
                >Weiterlesen</span
              >
              <span
                class="relative z-10 overflow-hidden rounded-full bg-skin-accent/10 p-1 transition-all duration-500 ease-out group-hover:bg-skin-accent/20"
              >
                <Icon
                  name="tabler:arrow-right"
                  class="h-4 w-4 transition-all duration-700 ease-out group-hover:translate-x-1 group-hover:scale-110"
                  aria-hidden="true"
                />
              </span>
            </span>
          </a>
        </div>
      </div>
    </div>
  </div>
</article>

<style>
  /* Ultra-Modern Animation Keyframes with Advanced Easing */
  @keyframes hide {
    from {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    to {
      opacity: 0;
      transform: scale(0.97) translateY(10px);
    }
  }

  @keyframes show {
    from {
      opacity: 0;
      transform: scale(0.97) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Enhanced Shine effect animation */
  @keyframes shine {
    0% {
      transform: translateX(-100%) rotate(35deg);
      opacity: 0;
    }
    10% {
      opacity: 0.5;
    }
    50% {
      opacity: 0.3;
    }
    100% {
      transform: translateX(100%) rotate(35deg);
      opacity: 0;
    }
  }

  /* Light reflection animation */
  @keyframes lightReflection {
    0% {
      opacity: 0;
      transform: translateY(10%) translateX(-10%) scale(1.5);
    }
    30% {
      opacity: 0.2;
    }
    70% {
      opacity: 0.1;
    }
    100% {
      opacity: 0;
      transform: translateY(-10%) translateX(10%) scale(1);
    }
  }

  .light-reflection {
    animation: lightReflection 8s infinite alternate
      cubic-bezier(0.4, 0, 0.2, 1);
  }

  .shine {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transform: translateX(-100%) rotate(35deg);
    animation: shine 6s infinite cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  /* Ultra-Modern Card Styling with 3D Perspective */
  .article-card {
    position: relative;
    isolation: isolate;
    transform: translateZ(0);
    backface-visibility: hidden;
    transform-style: preserve-3d;
    perspective: 1000px;
  }

  /* Animation classes with improved timing and physics-based easing */
  .hide {
    display: none;
    animation: hide 300ms cubic-bezier(0.33, 1, 0.68, 1);
  }

  .show {
    display: block;
    animation: show 700ms cubic-bezier(0.22, 1, 0.36, 1);
  }

  /* Enhanced Focus styles with modern effects */
  article:focus-within {
    @apply ring-2 ring-skin-accent ring-offset-2 ring-offset-skin-fill;
    box-shadow:
      0 0 0 2px var(--color-accent),
      0 0 20px 5px rgba(var(--color-accent-rgb), 0.15);
  }

  /* Enhanced Link focus styles with depth effect */
  a:focus-visible {
    @apply outline-none ring-2 ring-skin-accent ring-offset-2 ring-offset-skin-fill;
    box-shadow:
      0 0 0 2px var(--color-accent),
      0 0 15px 2px rgba(var(--color-accent-rgb), 0.2);
  }

  /* Reduced motion - maintaining accessibility */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-colors,
    .transition-transform,
    .transition-opacity,
    .group-hover\:translate-x-1,
    .group-hover\:translate-x-2,
    .group-hover\:scale-105,
    .group-hover\:scale-110,
    .group-hover\:translate-y-\[-2px\],
    .group-hover\:translate-y-\[-4px\],
    .group-hover\:rotate-12 {
      @apply transform-none transition-none;
    }

    .hide,
    .show,
    .shine,
    .light-reflection {
      animation: none;
    }
  }

  /* Print styles - maintaining functionality */
  @media print {
    article {
      @apply break-inside-avoid shadow-none border-none;
    }

    .group-hover\:translate-x-1,
    .group-hover\:translate-x-2,
    .group-hover\:scale-105,
    .group-hover\:scale-110,
    .group-hover\:translate-y-\[-2px\],
    .group-hover\:translate-y-\[-4px\],
    .group-hover\:rotate-12 {
      @apply transform-none;
    }

    .shine,
    .light-reflection {
      display: none;
    }
  }

  /* High contrast mode - maintaining accessibility */
  @media (forced-colors: active) {
    article {
      @apply border border-[CanvasText];
    }

    .bg-gradient-to-r,
    .bg-gradient-to-t,
    .bg-gradient-to-br {
      background: Canvas;
    }
  }
</style>
