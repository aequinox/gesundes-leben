---
/**
 * Card Component
 *
 * A versatile card component for displaying blog posts with support for
 * hero images, categories, metadata, and view transitions.
 *
 * @component
 * @example
 * ```astro
 * <Card
 *   post={post}
 *   withHeroImage={true}
 *   loading="lazy"
 * />
 * ```
 */

import { Picture } from "astro:assets";
import { type CollectionEntry } from "astro:content";
import ArticleMeta from "../partials/ArticleMeta.astro";
import { slugifyStr } from "@/utils/slugify";
import { Icon } from "astro-icon/components";

export interface Props {
  /** The blog post entry to display */
  post: CollectionEntry<"blog">;
  /** Whether to show the hero image */
  withHeroImage?: boolean;
  /** Image loading strategy */
  loading?: "eager" | "lazy";
}

type GroupType = "question-time" | "contra" | "pro";

interface GroupConfig {
  type: GroupType;
  icon: string;
  label: string;
}

const { post, withHeroImage = true, loading = "eager" }: Props = Astro.props;

const {
  slug,
  data: { title, heroImage, description, categories, group: groupProp },
} = post;

// Generate the post URL
const href = `/posts/${slug}/`;

// Map group types to their configurations
const groupConfigs: Record<string, GroupConfig> = {
  fragezeiten: {
    type: "question-time",
    icon: "tabler:question-mark",
    label: "Question Time",
  },
  kontra: {
    type: "contra",
    icon: "tabler:thumb-down",
    label: "Contra",
  },
  pro: {
    type: "pro",
    icon: "tabler:thumb-up",
    label: "Pro",
  },
} as const;

// Get group config with type safety
const groupConfig = groupConfigs[groupProp || "fragezeiten"];

// Memoize common class names
const cardClasses = [
  "article-card",
  "flex flex-col justify-between",
  "overflow-hidden rounded-sm",
  "bg-skin-card/10 hover:bg-skin-card/30",
  "hover:shadow-lg",
  "transition-all duration-300",
].join(" ");

const titleClasses = [
  "text-lg font-medium",
  "transition-colors duration-300",
  "hover:text-skin-accent",
].join(" ");

const readMoreClasses = [
  "mr-2 mt-4",
  "text-sm font-bold uppercase",
  "group-hover:text-skin-accent",
].join(" ");
---

<article
  class={cardClasses}
  data-categories={categories?.join("|")}
  data-group={groupConfig.type}
  aria-labelledby={`post-title-${slug}`}
>
  <header class="w-full group-hover:opacity-80">
    {
      withHeroImage && heroImage && (
        <div class="group relative cursor-pointer overflow-hidden">
          <a href={href} aria-label={`Read more about ${title}`}>
            <Picture
              src={heroImage.src}
              format="avif"
              widths={[400, 800]}
              sizes="(max-width: 800px) 400px, (max-width: 1200px) 800px"
              alt={title}
              loading={loading}
              class="aspect-video w-full object-cover transition-all duration-300 ease-in-out group-hover:scale-105 group-hover:grayscale-[25%]"
              transition:name={slugifyStr(title + "-heroImage")}
            />
          </a>

          {/* Group indicator badge */}
          <div
            class="absolute bottom-2 right-2 rounded-full bg-skin-accent/70 px-2 py-[0.5rem] text-skin-fill transition-all duration-300 ease-in-out group-hover:scale-105 group-hover:bg-skin-accent"
            aria-label={groupConfig.label}
          >
            <Icon name={groupConfig.icon} class="h-6 w-6" aria-hidden="true" />
          </div>
        </div>
      )
    }

    <div class="p-4">
      <div class="mb-4">
        {
          categories && categories.length > 0 && (
            <div class="mb-2 flex flex-wrap text-xs uppercase">
              {categories.map((category: string) => (
                <div
                  transition:name={slugifyStr(title + category)}
                  class="mb-1 mr-[0.125rem] inline-flex items-center text-sm font-medium text-skin-accent after:[&:not(:last-child)]:ml-[0.125rem] after:[&:not(:last-child)]:content-['|']"
                >
                  {category}
                </div>
              ))}
            </div>
          )
        }

        <a href={href} aria-label={`Read more about ${title}`}>
          <h2
            id={`post-title-${slug}`}
            class={titleClasses}
            transition:name={slugifyStr(title)}
          >
            {title}
          </h2>
        </a>

        <ArticleMeta post={post} />

        {
          description && (
            <div class="line-clamp-3 text-skin-base/80">{description}</div>
          )
        }
      </div>
    </div>
  </header>

  <div class="group mt-auto pb-4 pl-4">
    <a
      href={href}
      class={readMoreClasses}
      aria-label={`Read more about ${title}`}
    >
      <span class="inline-flex items-center gap-2">
        Weiterlesen
        <Icon
          name="tabler:arrow-right"
          class="h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"
          aria-hidden="true"
        />
      </span>
    </a>
  </div>
</article>

<style>
  /* Animation keyframes */
  @keyframes hide {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0);
    }
  }

  @keyframes show {
    from {
      opacity: 0;
      transform: scale(0);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Animation classes */
  .hide {
    display: none;
    animation: hide 100ms ease-in-out;
  }

  .show {
    display: block;
    animation: show 400ms ease-in-out;
  }

  /* Focus styles */
  article:focus-within {
    @apply ring-2 ring-skin-accent ring-offset-2 ring-offset-skin-fill;
  }

  /* Link focus styles */
  a:focus-visible {
    @apply outline-none ring-2 ring-skin-accent ring-offset-2 ring-offset-skin-fill;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .transition-all,
    .transition-colors,
    .transition-transform,
    .group-hover\:translate-x-1,
    .group-hover\:scale-105 {
      @apply transform-none transition-none;
    }

    .hide,
    .show {
      animation: none;
    }
  }

  /* Print styles */
  @media print {
    article {
      @apply break-inside-avoid shadow-none;
    }

    .group-hover\:translate-x-1,
    .group-hover\:scale-105 {
      @apply transform-none;
    }
  }

  /* High contrast mode */
  @media (forced-colors: active) {
    article {
      @apply border border-[CanvasText];
    }
  }
</style>
