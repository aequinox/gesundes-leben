---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

interface Props {
  class?: string;
}

interface BreadcrumbItem {
  label: string;
  href?: string;
  isCurrentPage: boolean;
}

const { class: className }: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Remove trailing slash and get clean path
const currentUrlPath = Astro.url.pathname.replace(/\/+$/, "");

// Split path into segments and remove empty entries
const pathSegments = currentUrlPath.split("/").filter(Boolean);

/**
 * Formats a breadcrumb label based on the segment and its context
 */
function formatBreadcrumbLabel(segment: string, index: number): string {
  // Handle posts pagination
  if (segment === "posts" && pathSegments[index + 1]) {
    const pageNum = pathSegments[index + 1];
    return `${t("nav.posts")} (${t("nav.page")} ${pageNum || 1})`;
  }

  // Handle tags pagination
  if (
    segment === "tags" &&
    pathSegments[index + 1] &&
    pathSegments[index + 2]
  ) {
    const tag = pathSegments[index + 1];
    const pageNum = pathSegments[index + 2];
    const pageIndicator =
      Number(pageNum) === 1 ? "" : ` (${t("nav.page")} ${pageNum})`;
    return `${decodeURIComponent(tag)}${pageIndicator}`;
  }

  // Default case: decode URI component for readable labels
  return decodeURIComponent(segment);
}

/**
 * Builds the breadcrumb items array with proper formatting and links
 */
function buildBreadcrumbItems(): BreadcrumbItem[] {
  const items: BreadcrumbItem[] = [
    {
      label: t("nav.home"),
      href: "/",
      isCurrentPage: pathSegments.length === 0,
    },
  ];

  let currentPath = "";

  pathSegments.forEach((segment, index) => {
    // Skip pagination numbers for posts and tags
    if (
      (pathSegments[index - 1] === "posts" && !isNaN(Number(segment))) ||
      (pathSegments[index - 2] === "tags" && !isNaN(Number(segment)))
    ) {
      return;
    }

    currentPath += `/${segment}`;

    items.push({
      label: formatBreadcrumbLabel(segment, index),
      href: index === pathSegments.length - 1 ? undefined : currentPath,
      isCurrentPage: index === pathSegments.length - 1,
    });
  });

  return items;
}

const breadcrumbItems = buildBreadcrumbItems();
---

<nav class:list={["breadcrumb", className]} aria-label="breadcrumb">
  <ul>
    {
      breadcrumbItems.map(item => (
        <li>
          {item.isCurrentPage ? (
            <span class="capitalize" aria-current="page">
              {item.label}
            </span>
          ) : (
            <>
              <a href={item.href} class="capitalize">
                {item.label}
              </a>
              <span aria-hidden="true">&raquo;</span>
            </>
          )}
        </li>
      ))
    }
  </ul>
</nav>

<style lang="postcss">
  .breadcrumb {
    @apply mx-auto mb-8 mt-8 w-full max-w-content;
    
    ul {
      @apply flex flex-wrap items-center gap-1;
      
      li {
        @apply inline;
        
        a {
          @apply capitalize opacity-70 transition-opacity duration-200;
          
          &:hover {
            @apply opacity-100;
          }
        }
        
        span {
          @apply opacity-70;
          
          &[aria-current="page"] {
            @apply opacity-100;
          }
        }
      }
    }
  }
</style>
