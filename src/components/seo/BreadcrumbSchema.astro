---
/**
 * @file BreadcrumbSchema.astro
 * @description Enhanced breadcrumb navigation with comprehensive schema markup
 *
 * Features:
 * - BreadcrumbList structured data
 * - German navigation labels
 * - Category-aware breadcrumbs
 * - Health content categorization
 * - Accessibility optimization
 * - SEO-friendly URL structure
 */

import { getCollection } from "astro:content";

import { SITE } from "@/config";
import { getI18nStrings, getNavigationTranslation } from "@/config/i18n";
import {
  buildBreadcrumbSchema,
  buildMedicalAudienceSchema,
  type BreadcrumbItemData,
} from "@/utils/seo/SchemaBuilder";
import { slugify } from "@/utils/slugs";

export interface BreadcrumbItem {
  name: string;
  url?: string;
  position: number;
}

export interface Props {
  /** Current page title */
  currentPage: string;
  /** Category for content categorization */
  category?: string;
  /** Custom breadcrumb items */
  items?: BreadcrumbItem[];
  /** Whether this is a health article */
  isHealthContent?: boolean;
}

const {
  currentPage,
  category,
  items = [],
  isHealthContent = false,
} = Astro.props;

// Get i18n strings for current language
const i18n = getI18nStrings("de");

// Get all blog posts for category lookup
const allPosts = await getCollection("blog");

/**
 * Finds a category name by its slug
 * @param slug The category slug to search for
 * @returns The original category name if found, or null if not found
 */
const findCategoryNameBySlug = (slug: string): string | null => {
  // Extract all unique categories from posts
  const allCategories = new Set<string>();

  allPosts.forEach(post => {
    post.data.categories?.forEach((category: string) => {
      allCategories.add(category);
    });
  });

  // Find the category whose slug matches the input slug
  for (const category of allCategories) {
    if (slugify(category) === slug) {
      return category;
    }
  }

  return null;
};

// Generate breadcrumbs from URL path
const generateBreadcrumbs = (): BreadcrumbItemData[] => {
  if (items.length > 0) {
    // Convert existing items to BreadcrumbItemData format
    return items.map(item => ({
      name: item.name,
      url: item.url,
      position: item.position,
    }));
  }

  const pathSegments = Astro.url.pathname.split("/").filter(Boolean);
  const breadcrumbs: BreadcrumbItemData[] = [
    {
      name: i18n.seo.navigation.home,
      url: SITE.website,
      position: 1,
    },
  ];

  let currentPath = "";
  pathSegments.forEach((segment, index) => {
    currentPath += `/${segment}`;
    const isLast = index === pathSegments.length - 1;

    let segmentName = segment
      .split("-")
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");

    // Apply translations using i18n utility
    segmentName = getNavigationTranslation(segment, "de");

    // Handle category slugs - check if previous segment is "categories"
    if (index > 0 && pathSegments[index - 1] === "categories") {
      const categoryName = findCategoryNameBySlug(segment);
      if (categoryName) {
        segmentName = categoryName;
      }
    }

    breadcrumbs.push({
      name: isLast ? currentPage : segmentName,
      url: isLast ? undefined : new URL(currentPath, SITE.website).href,
      position: index + 2,
    });
  });

  return breadcrumbs;
};

const breadcrumbItems = generateBreadcrumbs();

// Generate structured data using shared utility
const baseBreadcrumbSchema = buildBreadcrumbSchema(breadcrumbItems);

// Enhanced breadcrumb schema with health categorization
const enhancedBreadcrumbSchema = isHealthContent
  ? {
      ...baseBreadcrumbSchema,
      name: "Navigation",
      description: `Navigationspfad für ${currentPage}`,
      potentialAction: {
        "@type": "ReadAction",
        target: {
          "@type": "EntryPoint",
          urlTemplate: `${SITE.website}/search?q={search_term_string}`,
          actionPlatform: [
            "http://schema.org/DesktopWebPlatform",
            "http://schema.org/MobileWebPlatform",
          ],
        },
      },
      mainEntity: {
        "@type": "HealthTopicContent",
        hasHealthAspect: category || "Gesundheit",
        audience: buildMedicalAudienceSchema({
          audienceType: "Patient",
        }),
      },
    }
  : {
      ...baseBreadcrumbSchema,
      name: "Navigation",
      description: `Navigationspfad für ${currentPage}`,
    };
---

<!-- Breadcrumb Structured Data -->
<script
  type="application/ld+json"
  is:inline
  set:html={JSON.stringify(enhancedBreadcrumbSchema)}
/>

<!-- Additional navigation context for health content -->{
  isHealthContent && (
    <>
      <meta
        name="health:navigation-context"
        content={category || "Gesundheit"}
      />
      <meta name="content:breadcrumb-health" content="true" />
      <meta name="navigation:health-category" content={category || "general"} />
    </>
  )
}

<!-- Navigation hints for crawlers -->
<meta
  name="navigation:breadcrumb-count"
  content={breadcrumbItems.length.toString()}
/>
<meta
  name="navigation:depth"
  content={(breadcrumbItems.length - 1).toString()}
/>

<!-- Accessibility enhancements -->
<meta name="accessibility:navigation-context" content="breadcrumb" />
<meta name="accessibility:navigation-language" content="de-DE" />
